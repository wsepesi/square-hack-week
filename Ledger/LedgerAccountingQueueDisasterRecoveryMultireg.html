<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=VweL--i8-AvQug-CfOmyumTXJwzLcIBxXkqq8bywSz6KqvOBQamCwM2jDYHpp_1n);ul.lst-kix_ogbmmh3unxsz-1{list-style-type:none}ul.lst-kix_ogbmmh3unxsz-0{list-style-type:none}ul.lst-kix_ogbmmh3unxsz-3{list-style-type:none}.lst-kix_l43colofp3n7-1>li:before{content:"\0025cb   "}.lst-kix_iczqrri98nom-2>li:before{content:"\0025a0   "}.lst-kix_iczqrri98nom-4>li:before{content:"\0025cb   "}ul.lst-kix_ogbmmh3unxsz-2{list-style-type:none}ul.lst-kix_ogbmmh3unxsz-5{list-style-type:none}ul.lst-kix_ogbmmh3unxsz-4{list-style-type:none}ul.lst-kix_ogbmmh3unxsz-7{list-style-type:none}.lst-kix_l43colofp3n7-2>li:before{content:"\0025a0   "}.lst-kix_iczqrri98nom-1>li:before{content:"\0025cb   "}.lst-kix_iczqrri98nom-5>li:before{content:"\0025a0   "}ul.lst-kix_ogbmmh3unxsz-6{list-style-type:none}ul.lst-kix_ogbmmh3unxsz-8{list-style-type:none}.lst-kix_l43colofp3n7-0>li:before{content:"\0025cf   "}.lst-kix_l43colofp3n7-8>li:before{content:"\0025a0   "}.lst-kix_iczqrri98nom-3>li:before{content:"\0025cf   "}.lst-kix_e6dkfacqb32u-2>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-2}.lst-kix_l43colofp3n7-7>li:before{content:"\0025cb   "}ul.lst-kix_ij313lst2mos-0{list-style-type:none}.lst-kix_l43colofp3n7-6>li:before{content:"\0025cf   "}ul.lst-kix_ij313lst2mos-4{list-style-type:none}ul.lst-kix_ij313lst2mos-3{list-style-type:none}ul.lst-kix_ij313lst2mos-2{list-style-type:none}.lst-kix_l43colofp3n7-3>li:before{content:"\0025cf   "}.lst-kix_l43colofp3n7-5>li:before{content:"\0025a0   "}ul.lst-kix_ij313lst2mos-1{list-style-type:none}.lst-kix_iczqrri98nom-6>li:before{content:"\0025cf   "}.lst-kix_iczqrri98nom-8>li:before{content:"\0025a0   "}ul.lst-kix_ij313lst2mos-8{list-style-type:none}ul.lst-kix_ij313lst2mos-7{list-style-type:none}ul.lst-kix_ij313lst2mos-6{list-style-type:none}.lst-kix_l43colofp3n7-4>li:before{content:"\0025cb   "}ul.lst-kix_ij313lst2mos-5{list-style-type:none}.lst-kix_iczqrri98nom-7>li:before{content:"\0025cb   "}ol.lst-kix_rm7wnwyvtans-8.start{counter-reset:lst-ctn-kix_rm7wnwyvtans-8 0}ol.lst-kix_rm7wnwyvtans-2.start{counter-reset:lst-ctn-kix_rm7wnwyvtans-2 0}.lst-kix_lpofzvgw0m4b-5>li:before{content:"\0025a0   "}.lst-kix_lpofzvgw0m4b-4>li:before{content:"\0025cb   "}.lst-kix_lpofzvgw0m4b-6>li:before{content:"\0025cf   "}.lst-kix_lpofzvgw0m4b-3>li:before{content:"\0025cf   "}.lst-kix_lpofzvgw0m4b-7>li:before{content:"\0025cb   "}ul.lst-kix_ylq5fnif0jlx-0{list-style-type:none}ul.lst-kix_ylq5fnif0jlx-2{list-style-type:none}ul.lst-kix_ylq5fnif0jlx-1{list-style-type:none}ul.lst-kix_ylq5fnif0jlx-4{list-style-type:none}ul.lst-kix_ylq5fnif0jlx-3{list-style-type:none}ul.lst-kix_ylq5fnif0jlx-6{list-style-type:none}.lst-kix_e6dkfacqb32u-4>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-4}ul.lst-kix_ylq5fnif0jlx-5{list-style-type:none}ul.lst-kix_ylq5fnif0jlx-8{list-style-type:none}ul.lst-kix_ylq5fnif0jlx-7{list-style-type:none}.lst-kix_e6dkfacqb32u-0>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-0,decimal) ". "}.lst-kix_lpofzvgw0m4b-8>li:before{content:"\0025a0   "}ol.lst-kix_e6dkfacqb32u-4.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-4 0}.lst-kix_j8z0act96u3h-4>li:before{content:"\0025cb   "}.lst-kix_j8z0act96u3h-3>li:before{content:"\0025cf   "}.lst-kix_j8z0act96u3h-5>li:before{content:"\0025a0   "}.lst-kix_rm7wnwyvtans-4>li{counter-increment:lst-ctn-kix_rm7wnwyvtans-4}.lst-kix_j8z0act96u3h-0>li:before{content:"\0025cf   "}.lst-kix_j8z0act96u3h-8>li:before{content:"\0025a0   "}.lst-kix_j8z0act96u3h-7>li:before{content:"\0025cb   "}.lst-kix_j8z0act96u3h-6>li:before{content:"\0025cf   "}ul.lst-kix_m7g93z2u0yoh-0{list-style-type:none}ul.lst-kix_m7g93z2u0yoh-3{list-style-type:none}ol.lst-kix_e6dkfacqb32u-5.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-5 0}.lst-kix_lpofzvgw0m4b-1>li:before{content:"\0025cb   "}ul.lst-kix_m7g93z2u0yoh-4{list-style-type:none}ul.lst-kix_m7g93z2u0yoh-1{list-style-type:none}.lst-kix_lpofzvgw0m4b-0>li:before{content:"\0025cf   "}.lst-kix_lpofzvgw0m4b-2>li:before{content:"\0025a0   "}.lst-kix_j8z0act96u3h-1>li:before{content:"\0025cb   "}ol.lst-kix_rm7wnwyvtans-7.start{counter-reset:lst-ctn-kix_rm7wnwyvtans-7 0}ul.lst-kix_m7g93z2u0yoh-2{list-style-type:none}.lst-kix_iczqrri98nom-0>li:before{content:"\0025cf   "}ul.lst-kix_m7g93z2u0yoh-7{list-style-type:none}.lst-kix_j8z0act96u3h-2>li:before{content:"\0025a0   "}.lst-kix_rm7wnwyvtans-7>li{counter-increment:lst-ctn-kix_rm7wnwyvtans-7}ul.lst-kix_m7g93z2u0yoh-8{list-style-type:none}ul.lst-kix_m7g93z2u0yoh-5{list-style-type:none}ul.lst-kix_m7g93z2u0yoh-6{list-style-type:none}.lst-kix_m7g93z2u0yoh-1>li:before{content:"\0025cb   "}.lst-kix_rpvhu9atpg99-8>li:before{content:"\0025a0   "}.lst-kix_e6dkfacqb32u-7>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-7}.lst-kix_4rju3ptdqvek-0>li:before{content:"\0025cf   "}.lst-kix_rm7wnwyvtans-6>li{counter-increment:lst-ctn-kix_rm7wnwyvtans-6}.lst-kix_8mkd9xl48q7o-5>li:before{content:"\0025a0   "}.lst-kix_8mkd9xl48q7o-7>li:before{content:"\0025cb   "}.lst-kix_rpvhu9atpg99-4>li:before{content:"\0025cb   "}.lst-kix_rm7wnwyvtans-5>li{counter-increment:lst-ctn-kix_rm7wnwyvtans-5}.lst-kix_8mkd9xl48q7o-3>li:before{content:"\0025cf   "}.lst-kix_rpvhu9atpg99-6>li:before{content:"\0025cf   "}ul.lst-kix_3mc2odiscfp7-2{list-style-type:none}ul.lst-kix_3mc2odiscfp7-1{list-style-type:none}ul.lst-kix_3mc2odiscfp7-0{list-style-type:none}ul.lst-kix_rm7wnwyvtans-0{list-style-type:none}.lst-kix_e6dkfacqb32u-2>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-2,lower-roman) ". "}.lst-kix_e6dkfacqb32u-4>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-4,lower-latin) ". "}ul.lst-kix_rm7wnwyvtans-1{list-style-type:none}ul.lst-kix_3mc2odiscfp7-6{list-style-type:none}ul.lst-kix_3mc2odiscfp7-5{list-style-type:none}ul.lst-kix_3mc2odiscfp7-4{list-style-type:none}ul.lst-kix_3mc2odiscfp7-3{list-style-type:none}ul.lst-kix_3mc2odiscfp7-8{list-style-type:none}.lst-kix_4rju3ptdqvek-8>li:before{content:"\0025a0   "}ul.lst-kix_3mc2odiscfp7-7{list-style-type:none}.lst-kix_8mkd9xl48q7o-1>li:before{content:"\0025cb   "}ol.lst-kix_e6dkfacqb32u-6.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-6 0}.lst-kix_m7g93z2u0yoh-7>li:before{content:"\0025cb   "}.lst-kix_4rju3ptdqvek-2>li:before{content:"\0025a0   "}.lst-kix_4rju3ptdqvek-4>li:before{content:"\0025cb   "}.lst-kix_61svlhpcybpe-4>li:before{content:"\0025cb   "}.lst-kix_ogbmmh3unxsz-0>li:before{content:"\0025cf   "}.lst-kix_m7g93z2u0yoh-5>li:before{content:"\0025a0   "}.lst-kix_ogbmmh3unxsz-2>li:before{content:"\0025a0   "}.lst-kix_4rju3ptdqvek-6>li:before{content:"\0025cf   "}.lst-kix_e6dkfacqb32u-6>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-6,decimal) ". "}.lst-kix_e6dkfacqb32u-8>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-8,lower-roman) ". "}.lst-kix_61svlhpcybpe-0>li:before{content:"\0025cf   "}.lst-kix_61svlhpcybpe-2>li:before{content:"\0025a0   "}.lst-kix_m7g93z2u0yoh-3>li:before{content:"\0025cf   "}.lst-kix_ogbmmh3unxsz-6>li:before{content:"\0025cf   "}.lst-kix_3mc2odiscfp7-4>li:before{content:"\0025cb   "}.lst-kix_3mc2odiscfp7-6>li:before{content:"\0025cf   "}.lst-kix_ogbmmh3unxsz-4>li:before{content:"\0025cb   "}.lst-kix_ogbmmh3unxsz-8>li:before{content:"\0025a0   "}ol.lst-kix_e6dkfacqb32u-7.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-7 0}.lst-kix_20dyyg195tmy-8>li:before{content:"\0025a0   "}ul.lst-kix_61svlhpcybpe-7{list-style-type:none}ul.lst-kix_61svlhpcybpe-6{list-style-type:none}.lst-kix_20dyyg195tmy-6>li:before{content:"\0025cf   "}ul.lst-kix_61svlhpcybpe-8{list-style-type:none}ul.lst-kix_61svlhpcybpe-3{list-style-type:none}ul.lst-kix_61svlhpcybpe-2{list-style-type:none}ul.lst-kix_61svlhpcybpe-5{list-style-type:none}ul.lst-kix_61svlhpcybpe-4{list-style-type:none}.lst-kix_61svlhpcybpe-6>li:before{content:"\0025cf   "}ul.lst-kix_61svlhpcybpe-1{list-style-type:none}ul.lst-kix_61svlhpcybpe-0{list-style-type:none}.lst-kix_3mc2odiscfp7-8>li:before{content:"\0025a0   "}.lst-kix_61svlhpcybpe-8>li:before{content:"\0025a0   "}.lst-kix_ij313lst2mos-3>li:before{content:"\0025cf   "}.lst-kix_e6dkfacqb32u-0>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-0}.lst-kix_rpvhu9atpg99-2>li:before{content:"\0025a0   "}.lst-kix_ij313lst2mos-1>li:before{content:"\0025cb   "}.lst-kix_rpvhu9atpg99-0>li:before{content:"\0025cf   "}.lst-kix_ij313lst2mos-7>li:before{content:"\0025cb   "}ol.lst-kix_e6dkfacqb32u-8.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-8 0}.lst-kix_3mc2odiscfp7-0>li:before{content:"\0025cf   "}.lst-kix_3mc2odiscfp7-2>li:before{content:"\0025a0   "}.lst-kix_e6dkfacqb32u-6>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-6}.lst-kix_ij313lst2mos-5>li:before{content:"\0025a0   "}ul.lst-kix_l43colofp3n7-2{list-style-type:none}ul.lst-kix_4rju3ptdqvek-5{list-style-type:none}.lst-kix_g0f9urgvum7p-6>li:before{content:"\0025cf   "}ul.lst-kix_l43colofp3n7-1{list-style-type:none}ul.lst-kix_4rju3ptdqvek-4{list-style-type:none}ul.lst-kix_l43colofp3n7-4{list-style-type:none}ul.lst-kix_4rju3ptdqvek-7{list-style-type:none}.lst-kix_g0f9urgvum7p-5>li:before{content:"\0025a0   "}.lst-kix_g0f9urgvum7p-7>li:before{content:"\0025cb   "}.lst-kix_a1swy3v65qvp-0>li:before{content:"\0025cf   "}ul.lst-kix_l43colofp3n7-3{list-style-type:none}ul.lst-kix_4rju3ptdqvek-6{list-style-type:none}ul.lst-kix_l43colofp3n7-6{list-style-type:none}ul.lst-kix_4rju3ptdqvek-1{list-style-type:none}.lst-kix_g0f9urgvum7p-4>li:before{content:"\0025cb   "}.lst-kix_g0f9urgvum7p-8>li:before{content:"\0025a0   "}ul.lst-kix_l43colofp3n7-5{list-style-type:none}ul.lst-kix_4rju3ptdqvek-0{list-style-type:none}ul.lst-kix_l43colofp3n7-8{list-style-type:none}ul.lst-kix_4rju3ptdqvek-3{list-style-type:none}ul.lst-kix_l43colofp3n7-7{list-style-type:none}ul.lst-kix_4rju3ptdqvek-2{list-style-type:none}ol.lst-kix_e6dkfacqb32u-2.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-2 0}.lst-kix_g0f9urgvum7p-2>li:before{content:"\0025a0   "}ol.lst-kix_e6dkfacqb32u-1{list-style-type:none}.lst-kix_g0f9urgvum7p-1>li:before{content:"\0025cb   "}.lst-kix_g0f9urgvum7p-3>li:before{content:"\0025cf   "}.lst-kix_a1swy3v65qvp-2>li:before{content:"\0025a0   "}ol.lst-kix_e6dkfacqb32u-0{list-style-type:none}ul.lst-kix_4rju3ptdqvek-8{list-style-type:none}ul.lst-kix_l43colofp3n7-0{list-style-type:none}.lst-kix_a1swy3v65qvp-1>li:before{content:"\0025cb   "}ol.lst-kix_e6dkfacqb32u-7{list-style-type:none}ul.lst-kix_j8z0act96u3h-1{list-style-type:none}ol.lst-kix_e6dkfacqb32u-6{list-style-type:none}ul.lst-kix_j8z0act96u3h-0{list-style-type:none}ol.lst-kix_e6dkfacqb32u-8{list-style-type:none}ol.lst-kix_e6dkfacqb32u-3{list-style-type:none}ol.lst-kix_e6dkfacqb32u-2{list-style-type:none}ol.lst-kix_e6dkfacqb32u-5{list-style-type:none}ol.lst-kix_e6dkfacqb32u-4{list-style-type:none}ul.lst-kix_g0f9urgvum7p-5{list-style-type:none}ul.lst-kix_g0f9urgvum7p-4{list-style-type:none}ul.lst-kix_g0f9urgvum7p-7{list-style-type:none}.lst-kix_e6dkfacqb32u-1>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-1}ul.lst-kix_g0f9urgvum7p-6{list-style-type:none}ul.lst-kix_g0f9urgvum7p-1{list-style-type:none}ul.lst-kix_g0f9urgvum7p-0{list-style-type:none}ul.lst-kix_g0f9urgvum7p-3{list-style-type:none}ul.lst-kix_g0f9urgvum7p-2{list-style-type:none}ul.lst-kix_lpofzvgw0m4b-4{list-style-type:none}ul.lst-kix_lpofzvgw0m4b-3{list-style-type:none}ul.lst-kix_lpofzvgw0m4b-6{list-style-type:none}ul.lst-kix_lpofzvgw0m4b-5{list-style-type:none}ul.lst-kix_lpofzvgw0m4b-0{list-style-type:none}.lst-kix_rm7wnwyvtans-0>li:before{content:"\0025cf   "}ul.lst-kix_g0f9urgvum7p-8{list-style-type:none}ul.lst-kix_lpofzvgw0m4b-2{list-style-type:none}ul.lst-kix_lpofzvgw0m4b-1{list-style-type:none}.lst-kix_rm7wnwyvtans-2>li:before{content:"" counter(lst-ctn-kix_rm7wnwyvtans-2,lower-roman) ". "}.lst-kix_rm7wnwyvtans-3>li:before{content:"" counter(lst-ctn-kix_rm7wnwyvtans-3,decimal) ". "}ul.lst-kix_j8z0act96u3h-8{list-style-type:none}ul.lst-kix_j8z0act96u3h-7{list-style-type:none}ul.lst-kix_j8z0act96u3h-6{list-style-type:none}ul.lst-kix_lpofzvgw0m4b-8{list-style-type:none}ul.lst-kix_j8z0act96u3h-5{list-style-type:none}.lst-kix_rm7wnwyvtans-1>li:before{content:"\0025cb   "}ul.lst-kix_lpofzvgw0m4b-7{list-style-type:none}ul.lst-kix_j8z0act96u3h-4{list-style-type:none}ul.lst-kix_j8z0act96u3h-3{list-style-type:none}ul.lst-kix_j8z0act96u3h-2{list-style-type:none}.lst-kix_20dyyg195tmy-1>li:before{content:"\0025cb   "}.lst-kix_rm7wnwyvtans-6>li:before{content:"" counter(lst-ctn-kix_rm7wnwyvtans-6,decimal) ". "}.lst-kix_rm7wnwyvtans-7>li:before{content:"" counter(lst-ctn-kix_rm7wnwyvtans-7,lower-latin) ". "}ul.lst-kix_20dyyg195tmy-0{list-style-type:none}ul.lst-kix_20dyyg195tmy-3{list-style-type:none}.lst-kix_g0f9urgvum7p-0>li:before{content:"\0025cf   "}.lst-kix_rm7wnwyvtans-4>li:before{content:"" counter(lst-ctn-kix_rm7wnwyvtans-4,lower-latin) ". "}ol.lst-kix_rm7wnwyvtans-5.start{counter-reset:lst-ctn-kix_rm7wnwyvtans-5 0}.lst-kix_rm7wnwyvtans-8>li:before{content:"" counter(lst-ctn-kix_rm7wnwyvtans-8,lower-roman) ". "}ul.lst-kix_20dyyg195tmy-4{list-style-type:none}.lst-kix_20dyyg195tmy-0>li:before{content:"\0025cf   "}ul.lst-kix_20dyyg195tmy-1{list-style-type:none}.lst-kix_20dyyg195tmy-4>li:before{content:"\0025cb   "}ul.lst-kix_20dyyg195tmy-2{list-style-type:none}ul.lst-kix_20dyyg195tmy-7{list-style-type:none}ul.lst-kix_20dyyg195tmy-8{list-style-type:none}ul.lst-kix_20dyyg195tmy-5{list-style-type:none}ul.lst-kix_20dyyg195tmy-6{list-style-type:none}.lst-kix_20dyyg195tmy-3>li:before{content:"\0025cf   "}.lst-kix_rm7wnwyvtans-5>li:before{content:"" counter(lst-ctn-kix_rm7wnwyvtans-5,lower-roman) ". "}.lst-kix_20dyyg195tmy-2>li:before{content:"\0025a0   "}ol.lst-kix_rm7wnwyvtans-6.start{counter-reset:lst-ctn-kix_rm7wnwyvtans-6 0}ul.lst-kix_8mkd9xl48q7o-2{list-style-type:none}ul.lst-kix_8mkd9xl48q7o-1{list-style-type:none}ul.lst-kix_8mkd9xl48q7o-0{list-style-type:none}.lst-kix_e6dkfacqb32u-5>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-5}ul.lst-kix_8mkd9xl48q7o-8{list-style-type:none}ul.lst-kix_8mkd9xl48q7o-7{list-style-type:none}ul.lst-kix_8mkd9xl48q7o-6{list-style-type:none}ul.lst-kix_8mkd9xl48q7o-5{list-style-type:none}ul.lst-kix_8mkd9xl48q7o-4{list-style-type:none}ul.lst-kix_8mkd9xl48q7o-3{list-style-type:none}.lst-kix_ylq5fnif0jlx-7>li:before{content:"\0025cb   "}ul.lst-kix_iczqrri98nom-8{list-style-type:none}ul.lst-kix_iczqrri98nom-5{list-style-type:none}.lst-kix_ylq5fnif0jlx-5>li:before{content:"\0025a0   "}ul.lst-kix_iczqrri98nom-4{list-style-type:none}ul.lst-kix_iczqrri98nom-7{list-style-type:none}.lst-kix_ylq5fnif0jlx-4>li:before{content:"\0025cb   "}.lst-kix_ylq5fnif0jlx-8>li:before{content:"\0025a0   "}ul.lst-kix_iczqrri98nom-6{list-style-type:none}ul.lst-kix_iczqrri98nom-1{list-style-type:none}ul.lst-kix_iczqrri98nom-0{list-style-type:none}ul.lst-kix_iczqrri98nom-3{list-style-type:none}ul.lst-kix_iczqrri98nom-2{list-style-type:none}.lst-kix_ylq5fnif0jlx-6>li:before{content:"\0025cf   "}.lst-kix_a1swy3v65qvp-6>li:before{content:"\0025cf   "}.lst-kix_a1swy3v65qvp-8>li:before{content:"\0025a0   "}.lst-kix_ylq5fnif0jlx-1>li:before{content:"\0025cb   "}.lst-kix_ylq5fnif0jlx-0>li:before{content:"\0025cf   "}.lst-kix_a1swy3v65qvp-3>li:before{content:"\0025cf   "}.lst-kix_a1swy3v65qvp-7>li:before{content:"\0025cb   "}.lst-kix_ylq5fnif0jlx-3>li:before{content:"\0025cf   "}.lst-kix_a1swy3v65qvp-4>li:before{content:"\0025cb   "}.lst-kix_ylq5fnif0jlx-2>li:before{content:"\0025a0   "}.lst-kix_a1swy3v65qvp-5>li:before{content:"\0025a0   "}ol.lst-kix_rm7wnwyvtans-2{list-style-type:none}ol.lst-kix_rm7wnwyvtans-3{list-style-type:none}.lst-kix_m7g93z2u0yoh-0>li:before{content:"\0025cf   "}ul.lst-kix_rpvhu9atpg99-0{list-style-type:none}ul.lst-kix_rpvhu9atpg99-2{list-style-type:none}ul.lst-kix_rpvhu9atpg99-1{list-style-type:none}ol.lst-kix_rm7wnwyvtans-4.start{counter-reset:lst-ctn-kix_rm7wnwyvtans-4 0}.lst-kix_4rju3ptdqvek-1>li:before{content:"\0025cb   "}.lst-kix_8mkd9xl48q7o-8>li:before{content:"\0025a0   "}.lst-kix_rpvhu9atpg99-3>li:before{content:"\0025cf   "}.lst-kix_m7g93z2u0yoh-8>li:before{content:"\0025a0   "}.lst-kix_rpvhu9atpg99-5>li:before{content:"\0025a0   "}.lst-kix_e6dkfacqb32u-8>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-8}.lst-kix_8mkd9xl48q7o-6>li:before{content:"\0025cf   "}.lst-kix_rpvhu9atpg99-7>li:before{content:"\0025cb   "}ol.lst-kix_rm7wnwyvtans-8{list-style-type:none}ol.lst-kix_rm7wnwyvtans-6{list-style-type:none}ol.lst-kix_rm7wnwyvtans-7{list-style-type:none}ol.lst-kix_rm7wnwyvtans-4{list-style-type:none}ol.lst-kix_rm7wnwyvtans-5{list-style-type:none}.lst-kix_8mkd9xl48q7o-4>li:before{content:"\0025cb   "}.lst-kix_e6dkfacqb32u-3>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-3,decimal) ". "}.lst-kix_e6dkfacqb32u-1>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-1,lower-latin) ". "}.lst-kix_e6dkfacqb32u-5>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-5,lower-roman) ". "}.lst-kix_8mkd9xl48q7o-2>li:before{content:"\0025a0   "}.lst-kix_4rju3ptdqvek-7>li:before{content:"\0025cb   "}.lst-kix_8mkd9xl48q7o-0>li:before{content:"\0025cf   "}.lst-kix_m7g93z2u0yoh-6>li:before{content:"\0025cf   "}.lst-kix_4rju3ptdqvek-3>li:before{content:"\0025cf   "}.lst-kix_m7g93z2u0yoh-4>li:before{content:"\0025cb   "}ol.lst-kix_e6dkfacqb32u-3.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-3 0}.lst-kix_61svlhpcybpe-3>li:before{content:"\0025cf   "}.lst-kix_m7g93z2u0yoh-2>li:before{content:"\0025a0   "}.lst-kix_e6dkfacqb32u-7>li:before{content:"" counter(lst-ctn-kix_e6dkfacqb32u-7,lower-latin) ". "}.lst-kix_ogbmmh3unxsz-1>li:before{content:"\0025cb   "}.lst-kix_ogbmmh3unxsz-3>li:before{content:"\0025cf   "}.lst-kix_4rju3ptdqvek-5>li:before{content:"\0025a0   "}.lst-kix_61svlhpcybpe-1>li:before{content:"\0025cb   "}.lst-kix_3mc2odiscfp7-5>li:before{content:"\0025a0   "}ol.lst-kix_e6dkfacqb32u-0.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-0 0}.lst-kix_ogbmmh3unxsz-5>li:before{content:"\0025a0   "}.lst-kix_ogbmmh3unxsz-7>li:before{content:"\0025cb   "}.lst-kix_3mc2odiscfp7-3>li:before{content:"\0025cf   "}.lst-kix_3mc2odiscfp7-7>li:before{content:"\0025cb   "}.lst-kix_20dyyg195tmy-5>li:before{content:"\0025a0   "}.lst-kix_rm7wnwyvtans-8>li{counter-increment:lst-ctn-kix_rm7wnwyvtans-8}.lst-kix_rm7wnwyvtans-3>li{counter-increment:lst-ctn-kix_rm7wnwyvtans-3}.lst-kix_20dyyg195tmy-7>li:before{content:"\0025cb   "}.lst-kix_61svlhpcybpe-5>li:before{content:"\0025a0   "}.lst-kix_61svlhpcybpe-7>li:before{content:"\0025cb   "}.lst-kix_rm7wnwyvtans-2>li{counter-increment:lst-ctn-kix_rm7wnwyvtans-2}ol.lst-kix_rm7wnwyvtans-3.start{counter-reset:lst-ctn-kix_rm7wnwyvtans-3 0}.lst-kix_ij313lst2mos-2>li:before{content:"\0025a0   "}.lst-kix_ij313lst2mos-4>li:before{content:"\0025cb   "}.lst-kix_e6dkfacqb32u-3>li{counter-increment:lst-ctn-kix_e6dkfacqb32u-3}ul.lst-kix_a1swy3v65qvp-7{list-style-type:none}ul.lst-kix_a1swy3v65qvp-8{list-style-type:none}ol.lst-kix_e6dkfacqb32u-1.start{counter-reset:lst-ctn-kix_e6dkfacqb32u-1 0}ul.lst-kix_a1swy3v65qvp-5{list-style-type:none}ul.lst-kix_a1swy3v65qvp-6{list-style-type:none}ul.lst-kix_a1swy3v65qvp-3{list-style-type:none}ul.lst-kix_a1swy3v65qvp-4{list-style-type:none}ul.lst-kix_a1swy3v65qvp-1{list-style-type:none}ul.lst-kix_a1swy3v65qvp-2{list-style-type:none}.lst-kix_ij313lst2mos-0>li:before{content:"\0025cf   "}.lst-kix_ij313lst2mos-8>li:before{content:"\0025a0   "}ul.lst-kix_a1swy3v65qvp-0{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_rpvhu9atpg99-1>li:before{content:"\0025cb   "}.lst-kix_3mc2odiscfp7-1>li:before{content:"\0025cb   "}ul.lst-kix_rpvhu9atpg99-4{list-style-type:none}ul.lst-kix_rpvhu9atpg99-3{list-style-type:none}ul.lst-kix_rpvhu9atpg99-6{list-style-type:none}.lst-kix_ij313lst2mos-6>li:before{content:"\0025cf   "}ul.lst-kix_rpvhu9atpg99-5{list-style-type:none}ul.lst-kix_rpvhu9atpg99-8{list-style-type:none}ul.lst-kix_rpvhu9atpg99-7{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.c31{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:1pt;width:73.5pt;border-top-color:#999999;border-bottom-style:solid}.c50{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:1pt;width:86.2pt;border-top-color:#999999;border-bottom-style:solid}.c14{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:1pt;width:138.8pt;border-top-color:#999999;border-bottom-style:solid}.c45{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:1pt;width:73.5pt;border-top-color:#999999;border-bottom-style:solid}.c35{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:1pt;width:162pt;border-top-color:#999999;border-bottom-style:solid}.c47{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:1pt;width:138.8pt;border-top-color:#999999;border-bottom-style:solid}.c16{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:1pt;width:86.2pt;border-top-color:#999999;border-bottom-style:solid}.c9{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:1pt;width:162pt;border-top-color:#999999;border-bottom-style:solid}.c28{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#2b303b;border-left-style:solid;border-bottom-width:0pt;width:468pt;border-top-color:#000000;border-bottom-style:solid}.c10{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:10pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c5{margin-left:72pt;padding-top:0pt;padding-left:0pt;padding-bottom:10pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c1{margin-left:108pt;padding-top:0pt;padding-left:0pt;padding-bottom:10pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c51{color:#666666;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:15pt;font-family:"Arial";font-style:normal}.c30{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Proxima Nova";font-style:normal}.c33{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:26pt;font-family:"Arial";font-style:normal}.c42{padding-top:0pt;padding-bottom:16pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c26{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c18{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c7{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c20{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c6{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:9pt;font-family:"Proxima Nova";font-style:normal}.c37{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c22{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:9pt;font-family:"Proxima Nova";font-style:normal}.c4{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Consolas";font-style:normal}.c19{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c48{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c24{padding-top:0pt;padding-bottom:10pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c38{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#0000ee;text-decoration:underline}.c34{text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.c41{border-spacing:0;border-collapse:collapse;margin-right:auto}.c0{background-color:#2b303b;font-family:"Consolas";color:#c0c5ce;font-weight:400}.c25{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c23{padding-top:0pt;padding-bottom:0pt;line-height:1.15;text-align:left}.c15{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c21{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c49{font-size:9pt;font-family:"Proxima Nova";font-weight:400}.c12{background-color:#2b303b;color:#d08770}.c11{color:inherit;text-decoration:inherit}.c17{background-color:#2b303b;color:#a3be8c}.c44{background-color:#2b303b;color:#8fa1b3}.c52{color:#000000;font-family:"Proxima Nova"}.c43{background-color:#2b303b;color:#65737e}.c13{border:1px solid black;margin:5px}.c36{font-weight:700;font-style:italic}.c32{background-color:#2b303b;color:#b48ead}.c3{padding:0;margin:0}.c46{margin-left:144pt;padding-left:0pt}.c8{font-weight:400;font-family:"Consolas"}.c27{height:11pt}.c39{height:21pt}.c40{font-weight:700}.c29{height:0pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c21 doc-content"><p class="c48 title" id="h.m6bbk5ryqdgu"><span class="c33">Ledger Accounting Queue Disaster Recovery &amp; Multi-region Support</span></p><p class="c42 subtitle" id="h.xr4fjcby1ber"><span class="c51">Author: Kevin Crane (kcrane@)</span></p><p class="c24"><span>Status: Approved<br>Last Updated: 4/22/21<br>Jira Epic: </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-3477&amp;sa=D&amp;source=editors&amp;ust=1689357913637192&amp;usg=AOvVaw1W-TvbWFu_Ldx8y6Vtm3cQ">ACTENG-3477</a></span></p><p class="c23 c27"><span class="c34 c40 c52"></span></p><a id="t.81071982e04ff7bb11b77e8e328591c0d712483d"></a><a id="t.0"></a><table class="c41"><tr class="c39"><td class="c50" colspan="1" rowspan="1"><p class="c15"><span class="c30">LDAP</span></p></td><td class="c45" colspan="1" rowspan="1"><p class="c15"><span class="c30">Approved?</span></p></td><td class="c47" colspan="1" rowspan="1"><p class="c15"><span class="c30">Open Questions?</span></p></td><td class="c35" colspan="1" rowspan="1"><p class="c15"><span class="c30">Other Comments</span></p></td></tr><tr class="c29"><td class="c16" colspan="1" rowspan="1"><p class="c15"><span class="c38"><a class="c11" href="mailto:agray@squareup.com">Abigail Gray</a></span></p></td><td class="c31" colspan="1" rowspan="1"><p class="c15"><span class="c22">Yes</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c15 c27"><span class="c6"></span></p></td><td class="c9" colspan="1" rowspan="1"><p class="c15"><span class="c49">Seems to strike the right balance between adding in redundancy and resiliency for the AQ without adding too much complexity.</span></p></td></tr><tr class="c29"><td class="c16" colspan="1" rowspan="1"><p class="c15"><span class="c38"><a class="c11" href="mailto:dskarbek@squareup.com">Daniel Skarbek</a></span></p></td><td class="c31" colspan="1" rowspan="1"><p class="c15"><span class="c22">Yes</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td><td class="c9" colspan="1" rowspan="1"><p class="c15"><span class="c49">This is going to make a kick-ass demo.</span><sup><a href="#cmnt1" id="cmnt_ref1">[a]</a></sup><span class="c22">&nbsp; I expect you to actually do an SQS fail-over in like 5 mins as the demo. &nbsp;Switch publishing back and forth and then switch consumption.</span></p></td></tr><tr class="c29"><td class="c16" colspan="1" rowspan="1"><p class="c15"><span class="c38"><a class="c11" href="mailto:mgp@squareup.com">Mike Parker</a></span></p></td><td class="c31" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c15 c27"><span class="c6"></span></p></td><td class="c9" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td></tr><tr class="c29"><td class="c16" colspan="1" rowspan="1"><p class="c15"><span class="c38"><a class="c11" href="mailto:benv@squareup.com">Ben VandenBos</a></span></p></td><td class="c31" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c15 c27"><span class="c6"></span></p></td><td class="c9" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td></tr><tr class="c29"><td class="c16" colspan="1" rowspan="1"><p class="c15"><span class="c38"><a class="c11" href="mailto:kcraft@squareup.com">Kevin Craft</a></span></p></td><td class="c31" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c15 c27"><span class="c6"></span></p></td><td class="c9" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td></tr><tr class="c29"><td class="c16" colspan="1" rowspan="1"><p class="c15"><span class="c38"><a class="c11" href="mailto:mengen@squareup.com">Grace Mengen Huang</a></span></p></td><td class="c31" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c15 c27"><span class="c6"></span></p></td><td class="c9" colspan="1" rowspan="1"><p class="c15 c27"><span class="c22"></span></p></td></tr></table><h1 class="c19" id="h.29ejly63xktz"><span>Motivation &amp; Goals</span></h1><p class="c24"><span>If we are unable to reach SQS in the current AWS region (</span><span class="c8">us-west-1</span><span>)</span><span>&nbsp;from either Square datacenter, then we will be unable to process any Ledger events. While AWS ha</span><span>s a very high uptime</span><sup><a href="#cmnt2" id="cmnt_ref2">[b]</a></sup><sup><a href="#cmnt3" id="cmnt_ref3">[c]</a></sup><span>&nbsp;(</span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://aws.amazon.com/messaging/sla/&amp;sa=D&amp;source=editors&amp;ust=1689357913650006&amp;usg=AOvVaw2-UU7w_8fOOHUiPA6v0f8s">99.9% according to their published SLA</a></span><span>, or 9 hours per year</span><span>), the consequences of being unable to enqueue or dequeue new events means that we will still want the option to have an alternate region to work with in </span><span>the event of unavailability</span><sup><a href="#cmnt4" id="cmnt_ref4">[d]</a></sup><span class="c2">.</span></p><ul class="c3 lst-kix_20dyyg195tmy-0 start"><li class="c10 li-bullet-0"><span>Create at least one alternate AWS region with an SQS queue (</span><span class="c8">us-east-1</span><span class="c2">)</span></li><li class="c10 li-bullet-0"><span class="c2">Be able to specify which AWS region we publish new events to</span></li></ul><ul class="c3 lst-kix_20dyyg195tmy-1 start"><li class="c5 li-bullet-0"><span class="c2">This should be configurable for each Square DC region</span></li></ul><ul class="c3 lst-kix_20dyyg195tmy-0"><li class="c10 li-bullet-0"><span class="c2">Have a thread pool of QueueHandlers for each SQS region</span></li></ul><ul class="c3 lst-kix_20dyyg195tmy-1 start"><li class="c5 li-bullet-0"><span class="c2">This should be configurable via feature flag to account for varying event volume in each region</span></li></ul><h1 class="c19" id="h.78gb57xj3wl1"><span class="c37">What Ledger Changes Are Needed?</span></h1><p class="c24"><span>The main idea here would be to create a parallel SQS setup in an additional AWS region </span><span class="c8">(us-east-1</span><span class="c2">). We would only publish Accounting Events to one queue, but we would listen for events in either queue. This would ensure delivery of new events to SQS even if one region goes down and would allow Leder to remain operational.</span></p><p class="c24"><span>Currently we have a single </span><span class="c8">SqsQueueService</span><span>&nbsp;that enqueues and dequeues serialized messages to the existing AWS region (</span><span class="c8">us-west-1</span><span>). This is used by </span><span class="c8">MessageQueueAccountingQueue</span><span>&nbsp;(enqueuing) and </span><span class="c8">QueueHandler</span><span>&nbsp;(dequeuing). We&rsquo;ll create an additional </span><span class="c8">SqsQueueService</span><span class="c2">&nbsp;for each new region we plan to interact with, then add deciders to these classes to decide which region to enqueue to or dequeue from.</span></p><p class="c24"><span>This would come with minimal additional financial cost as SQS is billed on data ingress/egress and number of API calls made. </span><span>This means that having one queue lying idly</span><span class="c2">&nbsp;in wait would cost us nothing, except for the queue handlers that are listening for new events (and we can dynamically tune down the number of handler threads to be as low as needed to keep this minimal as well).</span></p><p class="c24"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 522.42px;"><img alt="" src="images/image1.png" style="width: 624.00px; height: 522.42px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c24"><span>By configuring the feature flags to accept the local Square DC as an input, </span><span>we can even gain performance benefits from data locality as well by sharding our traffic to the more local AWS region</span><sup><a href="#cmnt5" id="cmnt_ref5">[e]</a></sup><sup><a href="#cmnt6" id="cmnt_ref6">[f]</a></sup><sup><a href="#cmnt7" id="cmnt_ref7">[g]</a></sup><span class="c2">. For example, we can avoid making multiple cross-country trips to process Accounting Events with a feature flag rule mapping:</span></p><ul class="c3 lst-kix_j8z0act96u3h-0 start"><li class="c10 li-bullet-0"><span>&nbsp;</span><span class="c4">ledger/aq_enqueue_to_region(sjc2b) -&gt; us-west-1</span></li><li class="c10 li-bullet-0"><span>&nbsp;</span><span class="c4">ledger/aq_enqueue_to_region(iad2b) -&gt; us-east-1</span></li></ul><p class="c24"><span>Similarly, we can tweak the rate of processing AQ events by tuning the number of handler threads. The input to the feature flag is a token in the form </span><span class="c36">square_dc:aws_region:queue_name</span><span class="c2">:</span></p><ul class="c3 lst-kix_61svlhpcybpe-0 start"><li class="c10 li-bullet-0"><span class="c4">ledger/aq_num_handler_threads(sjc2b:us-west-1:aq_staging_ae) -&gt; 15</span></li><li class="c10 li-bullet-0"><span class="c4">ledger/aq_num_handler_threads(sjc2b:us-east-1:aq_staging_ae) -&gt; 0</span></li><li class="c10 li-bullet-0"><span class="c4">ledger/aq_num_handler_threads(iad2b:us-west-1:aq_staging_ae) -&gt; 0</span></li><li class="c10 li-bullet-0"><span class="c8">ledger/aq_num_handler_threads(iad2b:us-east-1:aq_staging_ae) -&gt; 15</span></li></ul><p class="c24"><span class="c2">In the event of an outage, we can then tune those to publish to the alternate AWS region or increase the number of handlers listening to the queues.</span></p><h2 class="c20" id="h.dh5p5g8gej5l"><span class="c26">Assumptions</span></h2><ul class="c3 lst-kix_m7g93z2u0yoh-0 start"><li class="c10 li-bullet-0"><span>If an event is enqueued to the Accounting Queue and SQS goes down in one region before it is dequeued, it will not be retried by the producer client;</span><span>&nbsp;the assumption is that the event will not be processed at all until that region recovers.</span></li><li class="c10 li-bullet-0"><span class="c2">An unavailable AWS region will eventually recover and messages in the SQS queue during this time will still be available for dequeuing when it recovers.</span></li><li class="c10 li-bullet-0"><span>Due to the idempotence of Accounting Events, dequeuing an event more than once is acceptable. We require at-least-once delivery only.</span><sup><a href="#cmnt8" id="cmnt_ref8">[h]</a></sup><sup><a href="#cmnt9" id="cmnt_ref9">[i]</a></sup></li></ul><h2 class="c20" id="h.9l2y3k89gp94"><span class="c26">Ledger Code Changes</span></h2><h3 class="c7" id="h.d2wlgymfxgyd"><span class="c18">Config Files</span></h3><ul class="c3 lst-kix_ij313lst2mos-0 start"><li class="c10 li-bullet-0"><span class="c2">Change original SQS URL from a single string to a list of regions and URLs</span></li></ul><a id="t.1c0fda4439af78253e6e9f86181a1628bd238e1c"></a><a id="t.1"></a><table class="c41"><tr class="c29"><td class="c28" colspan="1" rowspan="1"><p class="c23"><span class="c43 c8"># Before</span><span class="c0"><br>aq_sqs_queue_url: </span><span class="c17 c8">&#39;https://sqs.us-west-1.amazonaws.com/123456789012/&#39;</span><span class="c0"><br><br></span><span class="c8 c43"># After</span><span class="c0"><br>aq_sqs_queue_urls:<br> &nbsp;- region: </span><span class="c17 c8">us-west-1</span><span class="c0"><br> &nbsp; &nbsp;sqs_root_url: </span><span class="c17 c8">&#39;https://sqs.us-west-1.amazonaws.com/123456789012/&#39;</span><span class="c0"><br> &nbsp;- region: </span><span class="c8 c17">us-east-1</span><span class="c0"><br> &nbsp; &nbsp;sqs_root_url: </span><span class="c17 c8 c34">&#39;https://sqs.us-east-1.amazonaws.com/123456789012/&#39;</span></p></td></tr></table><h3 class="c7" id="h.bifokurlvskx"><span class="c18">QueueRegion &amp; SqsQueueRegion</span></h3><ul class="c3 lst-kix_a1swy3v65qvp-0 start"><li class="c10 li-bullet-0"><span class="c2">Tiny helper interface &amp; class that will codify the available regions for a given cloud environment</span></li><li class="c10 li-bullet-0"><span>Will essentially be an enum containing </span><span class="c8">US_EAST_1</span><span>&nbsp;&amp; </span><span class="c4">US_WEST_1</span></li></ul><a id="t.ba17dd75623ac1a604c9d40242b532921b578296"></a><a id="t.2"></a><table class="c41"><tr class="c29"><td class="c28" colspan="1" rowspan="1"><p class="c23"><span class="c32 c8">interface</span><span class="c0">&nbsp;</span><span class="c8 c44">QueueRegion</span><span class="c0">&nbsp;{<br> &nbsp; &nbsp;</span><span class="c32 c8">public</span><span class="c0">&nbsp;String </span><span class="c44 c8">getName</span><span class="c12 c8">()</span><span class="c0">;<br> &nbsp; &nbsp;</span><span class="c32 c8">public</span><span class="c0">&nbsp;</span><span class="c32 c8">static</span><span class="c0">&nbsp;List&lt;QueueRegion&gt; </span><span class="c44 c8">getAllRegions</span><span class="c12 c8">()</span><span class="c0">;<br>}<br><br></span><span class="c32 c8">enum</span><span class="c0">&nbsp;SqsQueueRegion implements QueueRegion {<br> &nbsp; &nbsp;US_EAST_1, US_WEST_1;<br><br> &nbsp; &nbsp;</span><span class="c32 c8">public</span><span class="c0">&nbsp;String </span><span class="c44 c8">getName</span><span class="c12 c8">()</span><span class="c0">&nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c43 c8">// This could also be cleaned up or skipped if we commit to all lowercase or uppercase and standardize on hyphen vs underscore</span><sup><a href="#cmnt10" id="cmnt_ref10">[j]</a></sup><sup><a href="#cmnt11" id="cmnt_ref11">[k]</a></sup><span class="c0"><br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c32 c8">return</span><span class="c0">&nbsp;</span><span class="c32 c8">this</span><span class="c0">.toLowerCase().replace(</span><span class="c17 c8">&quot;_&quot;</span><span class="c0">, </span><span class="c17 c8">&quot;-&quot;</span><span class="c0">);<br> &nbsp; &nbsp;}<br> &nbsp; &nbsp;</span><span class="c8 c32">public</span><span class="c0">&nbsp;</span><span class="c32 c8">static</span><span class="c0">&nbsp;List&lt;QueueRegion&gt; </span><span class="c44 c8">getAllRegions</span><span class="c12 c8">()</span><span class="c0">&nbsp;{<br> &nbsp; &nbsp; &nbsp; &nbsp;</span><span class="c32 c8">return</span><span class="c0">&nbsp;List.of(SqsQueueRegion.values());<br> &nbsp; &nbsp;}<br>}</span></p></td></tr></table><ul class="c3 lst-kix_a1swy3v65qvp-0"><li class="c10 li-bullet-0"><span class="c2">This will allow us to more easily codify the inputs to the feature flag knobs as well</span></li></ul><ul class="c3 lst-kix_a1swy3v65qvp-1 start"><li class="c5 li-bullet-0"><span class="c2">Example:</span></li></ul><a id="t.4c1563646d784882ef543c27dbbb08ea9de4d0b0"></a><a id="t.3"></a><table class="c41"><tr class="c29"><td class="c28" colspan="1" rowspan="1"><p class="c23"><span class="c0">String.format(</span><span class="c17 c8">&quot;%s:%s&quot;</span><span class="c0">, env.getDatacenter(), region.getName()).toLowerCase()</span></p></td></tr></table><h3 class="c7" id="h.c0g4t9puhlxx"><span class="c18">SqsQueueModule</span></h3><ul class="c3 lst-kix_g0f9urgvum7p-0 start"><li class="c10 li-bullet-0"><span>Bind </span><span class="c4">QueueRegion -&gt; SqsQueueRegion</span></li><li class="c10 li-bullet-0"><span>Instead of binding a single instance of </span><span class="c8">QueueService -&gt; SqsQueueService</span><span>, we can iterate through each region in </span><span class="c8">SqsQueueRegion.getAllRegions()</span><span>&nbsp;and bind a Map from </span><span class="c8">QueueRegion -&gt; QueueService</span><span>, with a new instance of </span><span class="c8">SqsQueueService</span><span class="c2">&nbsp;for each region.</span></li></ul><ul class="c3 lst-kix_g0f9urgvum7p-1 start"><li class="c5 li-bullet-0"><span>This would be used similarly to how we currently use </span><span class="c8">JooqTransacters</span><span class="c2">, injecting the Map of the possible regions, and using the one we require.</span></li></ul><h3 class="c7" id="h.ow4fsgkmjbnh"><span class="c18">MessageQueueAccountingQueueLifecycle</span></h3><ul class="c3 lst-kix_ylq5fnif0jlx-0 start"><li class="c10 li-bullet-0"><span>In </span><span class="c8">handleStarting</span><span>, we currently create a new thread pool of </span><span class="c8">QueueHandlers</span><span>&nbsp;for each queue name; we would want to expand this for each </span><span class="c8">QueueRegion</span><span class="c2">&nbsp;as well.</span></li><li class="c10 li-bullet-0"><span>In </span><span class="c8">checkAndScaleHandlers</span><span>, we would want to expand the feature flag used (</span><span class="c8">ledger/aq_num_handler_threads</span><span class="c2">) to have different values based on the current Square DC and the AWS regions we want to listen for.</span></li></ul><ul class="c3 lst-kix_ylq5fnif0jlx-1 start"><li class="c5 li-bullet-0"><span>Example: </span><span class="c8">ledger/aq_num_handler_threads(sjc2b:us-west-1:aq-staging-ae) -&gt; 15</span><span>&nbsp;and </span><span class="c8">ledger/aq_num_handler_threads(sjc2b:us-east-1:aq-staging-ae) -&gt; 1</span><span class="c2">, meaning we would have two thread pools of different, live-tunable sizes listening for events in different AWS regions.</span></li></ul><h3 class="c7" id="h.2a3pm19r8x0k"><span class="c18">MessageQueueAccountingQueue</span></h3><ul class="c3 lst-kix_3mc2odiscfp7-0 start"><li class="c10 li-bullet-0"><span>Inject </span><span class="c8">Map&lt;QueueRegion, QueueService&lt;AccountingEventM&gt;&gt;</span><span>&nbsp;instead of </span><span class="c8">QueueService&lt;AccountingEventM&gt;</span><span>, </span><span class="c8">Env</span><span>, and the Feature Flag </span><span class="c8">ledger/aq_enqueue_to_region</span><span class="c2">.</span></li><li class="c10 li-bullet-0"><span>In each enqueue method, we can check the </span><span class="c8">ledger/aq_enqueue_to_region </span><span>flag for the Square DC we&rsquo;re in and get the correct </span><span class="c8">SqsQueueService</span><span>&nbsp;based on which we&rsquo;ve selected.</span></li></ul><h2 class="c20" id="h.82db3h7tots4"><span class="c26">Operational Changes</span></h2><ul class="c3 lst-kix_iczqrri98nom-0 start"><li class="c10 li-bullet-0"><span class="c8">LedgerFeatureFlagModule</span></li></ul><ul class="c3 lst-kix_iczqrri98nom-1 start"><li class="c5 li-bullet-0"><span>N</span><span>ew feature flag: </span><span class="c4">ledger/aq_enqueue_to_region</span></li></ul><ul class="c3 lst-kix_iczqrri98nom-2 start"><li class="c1 li-bullet-0"><span>As an input to this feature flag, we should provide the Square datacenter, in all-lowercase (e.g. </span><span class="c8">iad2b</span><span>, </span><span class="c8">sjc2b</span><span class="c2">).</span></li><li class="c1 li-bullet-0"><span>The output of this should be an </span><span class="c8">EnumFlag</span><span>, with each applicable region defined in code (</span><span class="c8">us-east-1</span><span>, </span><span class="c8">us-west-1</span><span class="c2">).</span></li><li class="c1 li-bullet-0"><span>Default value: </span><span class="c4">us-west-1</span></li></ul><ul class="c3 lst-kix_iczqrri98nom-1"><li class="c5 li-bullet-0"><span>Modify feature flag: </span><span class="c4">ledger/aq_num_handler_threads</span></li></ul><ul class="c3 lst-kix_iczqrri98nom-2 start"><li class="c1 li-bullet-0"><span class="c2">As an input to this feature flag, we should provide both the Square datacenter, AWS region and queue name.</span></li></ul><ul class="c3 lst-kix_iczqrri98nom-3 start"><li class="c24 c46 li-bullet-0"><span>For example, </span><span class="c8">sjc2b:us-west-1:aq-staging-ae</span><span>&nbsp;or </span><span class="c4">iad2b:us-east-1:aq-staging-ae</span></li></ul><ul class="c3 lst-kix_iczqrri98nom-2"><li class="c1 li-bullet-0"><span class="c2">The output of this is an int corresponding to how many threads we should dedicate to dequeuing events from that region in a particular Square DC.</span></li><li class="c1 li-bullet-0"><span>Default value: </span><span class="c4">15</span></li></ul><ul class="c3 lst-kix_iczqrri98nom-1"><li class="c5 li-bullet-0"><span>New feature flags for resizing the AQ queue handler thread pool sizes (</span><span>1 flag for each region</span><span class="c2">)</span></li></ul><ul class="c3 lst-kix_iczqrri98nom-0"><li class="c10 li-bullet-0"><span>Config changes to accept multiple SQS queues (</span><span class="c8">aq_sqs_queue_urls</span><span class="c2">)</span></li></ul><h2 class="c20" id="h.975xo75hodku"><span>Monitoring Changes</span><sup><a href="#cmnt12" id="cmnt_ref12">[l]</a></sup><sup><a href="#cmnt13" id="cmnt_ref13">[m]</a></sup></h2><ul class="c3 lst-kix_l43colofp3n7-0 start"><li class="c10 li-bullet-0"><span class="c2">In SignalFx, we&rsquo;d have to change our graphs to include the new regions.</span></li></ul><ul class="c3 lst-kix_l43colofp3n7-1 start"><li class="c5 li-bullet-0"><span class="c2">Currently our graphs are created by both the region and the queue name.</span></li><li class="c5 li-bullet-0"><span>Since the queue name stays the same, we&rsquo;d just have to add </span><span class="c8">us-east-1</span><span class="c2">&nbsp;to the list of known regions to be graphed.</span></li></ul><ul class="c3 lst-kix_l43colofp3n7-0"><li class="c10 li-bullet-0"><span class="c2">New metric: number of messages received when dequeuing a new batch; this can be used to tune the number of handlers required (for example, if we are not retrieving a full batch of messages on average, we can tune down the number of handlers)</span></li><li class="c10 li-bullet-0"><span>We&rsquo;d have to make sure our alerts are updated to cover this new region as well. This can be automated in the </span><span class="c8">signalform</span><span>&nbsp;repo for the </span><span class="c8">acteng</span><span>&nbsp;detectors.</span></li></ul><h1 class="c19" id="h.cs4ya3ybss6k"><span class="c37">Steps To Induce A Failure</span></h1><p class="c24"><span class="c2">To be most realistic, there are two ways we can simulate an actual failure:</span></p><ul class="c3 lst-kix_rm7wnwyvtans-0 start"><li class="c10 li-bullet-0"><span class="c2">Request NetEng to block outgoing requests to AWS from our Ledger nodes</span></li><li class="c10 li-bullet-0"><span class="c2">Insert a feature flag to Ledger to simulate failures by throwing exceptions whenever we enqueue or dequeue a message from the Accounting Queue</span></li></ul><p class="c24"><span>The benefit of the first option is that we can really test all failure cases by simulating what happens if SQS vanishes off the planet (from the perspective of Ledger). It would also allow us to verify the durability of messages in the queue (will we seamlessly pick up where we left off). We can be confident that SQS will durably store messages, even in the event of a failure (see </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://aws.amazon.com/sqs/faqs/%23:~:text%3DAmazon%2520SQS%2520works%2520on%2520a,and%2520your%2520stakeholders%2520added%2520confidence.&amp;sa=D&amp;source=editors&amp;ust=1689357913664930&amp;usg=AOvVaw2O_-JL1iI2FCvc7T05w2ne">here</a></span><span>&nbsp;&amp; </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://neiljbrown.com/2017/08/26/evaluating-message-brokers-amazon-sqs/&amp;sa=D&amp;source=editors&amp;ust=1689357913665237&amp;usg=AOvVaw0zDdKo98jWQMWbjQBgaXir">here</a></span><span class="c2">), but it would still be nice to see this with our own eyes as well. This may be a non-starter though if NetEng says this is too difficult or dangerous to accomplish.</span></p><p class="c24"><span class="c2">Alternatively, if inducing an actual failure is overkill for the purposes of this exercise (i.e. we didn&rsquo;t want to modify the Ledger source to intentionally throw exceptions or make potentially dangerous network changes), we could just do a gameday exercise of proving we can flip traffic from one Availability Zone (AZ) to another without losing any Ledger events.</span></p><h1 class="c19" id="h.tu3mt3l1v29"><span>Steps To Recover</span><sup><a href="#cmnt14" id="cmnt_ref14">[n]</a></sup><sup><a href="#cmnt15" id="cmnt_ref15">[o]</a></sup><sup><a href="#cmnt16" id="cmnt_ref16">[p]</a></sup><sup><a href="#cmnt17" id="cmnt_ref17">[q]</a></sup><sup><a href="#cmnt18" id="cmnt_ref18">[r]</a></sup><sup><a href="#cmnt19" id="cmnt_ref19">[s]</a></sup><sup><a href="#cmnt20" id="cmnt_ref20">[t]</a></sup></h1><p class="c24"><span>Assuming this is just an SQS outage, we would just need to </span><span>flip the feature flag to redirect the publishing of Accounting Events to the alternate SQS queues in the other AZs</span><sup><a href="#cmnt21" id="cmnt_ref21">[u]</a></sup><span>. The Feature Flag library supports enum feature sets, so we could configure a list of valid AZs (likely just </span><span class="c8">us-east-1</span><span>&nbsp;and </span><span class="c8">us-west-1</span><span class="c2">).</span></p><p class="c24"><span class="c2">Events already enqueued in the unavailable region will be processed once the that region recovers and is able to dequeue events again.</span></p><h1 class="c19" id="h.kt2w8dtfxhnd"><span>Metrics &amp; Logs To Monitor</span><sup><a href="#cmnt22" id="cmnt_ref22">[v]</a></sup><span class="c37">&nbsp;During A Disaster</span></h1><p class="c24"><span>The </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://square.signalfx.com/%23/dashboard/EF0A6BYAcAA?groupId%3DEFz-tuCAgAU%26configId%3DEF0A7i2AYAA%26selectedEventOverlays%3DyR5jhy%26selectedEventOverlays%3D6S1lUf%26startTime%3D-4h%26endTime%3DNow&amp;sa=D&amp;source=editors&amp;ust=1689357913666779&amp;usg=AOvVaw2go32Ny45vSYnDlypoMayP">Accounting Queue SignalFx dashboard</a></span><span>&nbsp;is a great place to start. Specifically, the </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://square.signalfx.com/%23/chart/EoHX75MAgAE?groupId%3DEFz-tuCAgAU%26configId%3DEF0A7i2AYAA%26startTime%3D-4h%26endTime%3DNow&amp;sa=D&amp;source=editors&amp;ust=1689357913667043&amp;usg=AOvVaw19vk8jdVkYB_AvRoPiK_9y">Events Enqueued</a></span><span>, </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://square.signalfx.com/%23/chart/EpO0dRmAcAA?groupId%3DEFz-tuCAgAU%26configId%3DEF0A7i2AYAA%26startTime%3D-4h%26endTime%3DNow&amp;sa=D&amp;source=editors&amp;ust=1689357913667223&amp;usg=AOvVaw1O6DeSttgOcclZNI1uCVzV">Events Dequeued</a></span><span>, and </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://square.signalfx.com/%23/chart/EVM2umlAgAA?groupId%3DEFz-tuCAgAU%26configId%3DEF0A7i2AYAA%26startTime%3D-4h%26endTime%3DNow&amp;sa=D&amp;source=editors&amp;ust=1689357913667409&amp;usg=AOvVaw0JpmHkuPrtvIFr6K8L9Wtf">AQ Exceptions</a></span><span class="c2">&nbsp;graphs should make it apparent when there are systemic issues.</span></p><p class="c24"><span>We have PagerDuty alerts set up for &ldquo;</span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://square.signalfx.com/%23/detector/EGX2bdRAcAA/edit&amp;sa=D&amp;source=editors&amp;ust=1689357913667679&amp;usg=AOvVaw1Cq76gCYG2M4EUADZMTCLd">slow to enqueue CaptureEvents</a></span><span>&rdquo; and &ldquo;</span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://square.signalfx.com/%23/detector/EVM25NQAcAA/edit&amp;sa=D&amp;source=editors&amp;ust=1689357913667843&amp;usg=AOvVaw3samlZy0pHc1McGzymLEIw">high number of AQ exceptions</a></span><span>&rdquo;, which should be sufficient for alerting us if SQS is experiencing issues. It would also be worth adding an alert if the total number of successful AQ enqueues is zero for too long.</span></p><h2 class="c20" id="h.da62e8kutuym"><span class="c26">Additional Monitoring</span></h2><ul class="c3 lst-kix_8mkd9xl48q7o-0 start"><li class="c10 li-bullet-0"><span class="c2">A SignalFx detector for alerting us if the number of successful enqueues is zero for too long</span></li></ul><h1 class="c19" id="h.787k8s59xpv5"><span class="c37">Timeline &amp; Jira Tickets</span></h1><p class="c24"><span>Jira tickets are defined in Epic &ldquo;Accounting Queue DR&rdquo;: </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-3477&amp;sa=D&amp;source=editors&amp;ust=1689357913668509&amp;usg=AOvVaw1L5tSwh0n7r6U8YK_b-Dy4">ACTENG-3477</a></span></p><p class="c24"><span>The implementation and testing of this whole project shouldn&rsquo;t take more than a sprint. I anticipate </span><span class="c40">approximately 1 to 1.5 weeks to implement</span><span>, followed by a few days to test by simulating failovers in staging and swapping AQ traffic between AWS regions.</span></p><h1 class="c19" id="h.m2ctsee5zis"><span class="c37">Appendix</span></h1><h2 class="c20" id="h.wl6zzj5zozls"><span class="c26">Original Idea for &ldquo;Ledger Code Changes&rdquo; (for posterity)</span></h2><h3 class="c7" id="h.vpnyct60bp6y"><span class="c18">SqsQueueService</span></h3><p class="c24"><span>A majority of the required changes are in </span><span class="c4">SqsQueueService</span></p><ul class="c3 lst-kix_4rju3ptdqvek-0 start"><li class="c10 li-bullet-0"><span>Currently we inject a String from a config file </span><span class="c8">aq_sqs_queue_url</span><span class="c2">; this string contains the exact SQS queue that we should enqueue events to</span></li></ul><a id="t.6fd1dcc02f8312178bac100656cd7d9c4d6dee21"></a><a id="t.4"></a><table class="c41"><tr class="c29"><td class="c28" colspan="1" rowspan="1"><p class="c23"><span class="c0">aq_sqs_queue_url: </span><span class="c17 c8">&#39;https://sqs.us-west-1.amazonaws.com/123456789012/&#39;</span></p></td></tr></table><ul class="c3 lst-kix_4rju3ptdqvek-0"><li class="c10 li-bullet-0"><span>We would want to change this configuration value to take a list instead, letting us map each region to its own queue URL.</span><sup><a href="#cmnt23" id="cmnt_ref23">[w]</a></sup></li></ul><a id="t.f0934aa0b38e88d72b5e0559d8df4411d550c5d4"></a><a id="t.5"></a><table class="c41"><tr class="c29"><td class="c28" colspan="1" rowspan="1"><p class="c23"><span class="c0">aq_sqs_queue_urls:<br> &nbsp;- us_west_1: </span><span class="c17 c8">&#39;https://sqs.us-west-1.amazonaws.com/123456789012/&#39;</span><span class="c0"><br> &nbsp;- us_east_1: </span><span class="c17 c8">&#39;https://sqs.us-east-1.amazonaws.com/123456789012/&#39;</span><span class="c34 c0"><br></span></p><p class="c23"><span class="c43 c8"># alternatively:</span><span class="c0"><br></span><span class="c0">aws_account_id: </span><span class="c8 c12">123456789012</span><span class="c0"><br>aq_sqs_regions:<br></span><span class="c17 c8">&nbsp; -</span><span class="c0">&nbsp;</span><span class="c17 c8">us-east-1</span><span class="c0"><br></span><span class="c17 c8">&nbsp; -</span><span class="c0">&nbsp;</span><span class="c17 c8">us-west-1</span></p></td></tr></table><ul class="c3 lst-kix_4rju3ptdqvek-0"><li class="c10 li-bullet-0"><span class="c2">Inject the new feature flag and config values</span></li><li class="c10 li-bullet-0"><span class="c4">formatQueueName</span></li></ul><ul class="c3 lst-kix_4rju3ptdqvek-1 start"><li class="c5 li-bullet-0"><span class="c2">This method builds fully-qualified SQS queue URLs using the root URL.</span></li><li class="c5 li-bullet-0"><span class="c2">This would be modified to also include the region we should use in the formatted queue URL</span></li></ul><ul class="c3 lst-kix_4rju3ptdqvek-0"><li class="c10 li-bullet-0"><span class="c4">prepareSendMessageRequest</span></li></ul><ul class="c3 lst-kix_4rju3ptdqvek-1 start"><li class="c5 li-bullet-0"><span>Use the new feature flag to determine which region to send to </span><span class="c8">formatQueueName</span><span class="c2">&nbsp;before enqueuing a new message</span></li><li class="c5 li-bullet-0"><span>This would also give us the potential for automatic fail-overs. Using the error status codes returned by the SQS client during an unavailability incident (in </span><span class="c8">handleSendMessageResult</span><span class="c2">), we could determine if we should try enqueueing the message in an alternate region.</span></li></ul><ul class="c3 lst-kix_4rju3ptdqvek-0"><li class="c10 li-bullet-0"><span class="c8">receiveMessages, retryMessage</span></li></ul><ul class="c3 lst-kix_4rju3ptdqvek-1 start"><li class="c5 li-bullet-0"><span>In practice, we should be able to dequeue and retry events from either AWS region; the only reasons to limit ourselves on which regions we listen to are the financial cost of using SQS (we are build by the API call), as well as the extra memory overhead of keeping more </span><span class="c8">QueueHandler</span><span class="c2">&rsquo;s spinning and listening for events.</span></li><li class="c5 li-bullet-0"><span class="c2">We could either:</span></li></ul><ul class="c3 lst-kix_4rju3ptdqvek-2 start"><li class="c1 li-bullet-0"><span class="c2">Add an extra String to the method arguments, specifying exactly which region to make our receive API call to</span></li><li class="c1 li-bullet-0"><span>Pass String </span><span class="c8">receiveFromRegion</span><span>&nbsp;into the </span><span class="c8">SqsQueueService</span><span>&nbsp;as part of its constructor; would have to inject this as an </span><span class="c8">@Assisted</span><span>&nbsp;Guice type (see </span><span class="c8">QueueHandler</span><span class="c2">&nbsp;for example of how to do this)</span></li></ul><h3 class="c7" id="h.ywd4s2vwezrw"><span class="c18">QueueHandler</span></h3><ul class="c3 lst-kix_ogbmmh3unxsz-0 start"><li class="c10 li-bullet-0"><span>Inject an additional String for the region we should receive messages from;</span><span>&nbsp;this can be passed to </span><span class="c8">queueService.receiveMessages</span><span>.</span><sup><a href="#cmnt24" id="cmnt_ref24">[x]</a></sup></li></ul><h3 class="c7" id="h.lllsqrhqupww"><span class="c18">MessageQueueAccountingQueueLifecycle</span></h3><ul class="c3 lst-kix_lpofzvgw0m4b-0 start"><li class="c10 li-bullet-0"><span>Iterate through the list of valid regions and spin up a new thread pool of </span><span class="c8">MessageQueueAccountingQueueProcessor</span><span class="c2">&nbsp;for each one.</span></li><li class="c10 li-bullet-0"><span class="c2">We can also use independent feature flags to tune the size of each thread pool. This gives us extra control for scaling the rate at which we try to dequeue events from each region, letting us minimize our financial costs for the inactive region.</span></li></ul><div class="c13"><p class="c15"><a href="#cmnt_ref1" id="cmnt1">[a]</a><span class="c2">&#x1f918;&#x1f3fc;</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref2" id="cmnt2">[b]</a><span class="c2">please quantify this</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref3" id="cmnt3">[c]</a><span class="c2">&#x1f44d;&#x1f3fc;</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref4" id="cmnt4">[d]</a><span class="c2">since 3 nines of availability is ~ 9 hours of downtime/year.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref5" id="cmnt5">[e]</a><span class="c2">nice benefit!</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref6" id="cmnt6">[f]</a><span class="c2">I&#39;m not sure whether this is an actual benefit or a theoretical one.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref7" id="cmnt7">[g]</a><span class="c2">I think it&#39;ll be an &quot;actual&quot; benefit, albeit one that&#39;ll be questionable whether or not it makes a practical, noticeable difference from the customers&#39; perspective (if we&#39;re taking seconds to process an event within Ledger, shaving milliseconds off the round-trip time may not be noticeable).</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref8" id="cmnt8">[h]</a><span class="c2">True, but not relevant to this design, is it?&nbsp; Are we increasing the amount of duplicate processing somewhere?</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref9" id="cmnt9">[i]</a><span class="c2">We shouldn&#39;t, no. This is more just explicitly pointing out that if we dequeue a message twice by some failure scenario with SQS, that&#39;s not a &quot;problem&quot; for Ledger.</span></p><p class="c15 c27"><span class="c2"></span></p><p class="c15"><span class="c2">For example if we dequeue and process a message and SQS goes down before we ack it, then process it a second&nbsp;time when SQS is back, we won&#39;t see effects like double-counting a payment.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref10" id="cmnt10">[j]</a><span class="c2">yeah, we are defining the enum values, can&#39;t we just keep them consistent?&nbsp; Can we use all-caps in the flags so that we don&#39;t need this method at all?</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref11" id="cmnt11">[k]</a><span class="c2">Yeah, this was kinda pseudo-code brainstorming&nbsp;here and will be subject to change when I actually write out the real code. The main idea I had in my head is if we had an enum with value US_EAST_1 and a config value that said &quot;region: us-east-1&quot;, that we&#39;d have to translate between the two of them.</span></p><p class="c15 c27"><span class="c2"></span></p><p class="c15"><span class="c2">I think there&#39;s some java enum magic where we can handle that natively too, in which case those methods aren&#39;t needed.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref12" id="cmnt12">[l]</a><span class="c2">slightly unrelated, but would be useful here... I was thinking about how do we know if we have way too many handler threads or are getting close to the limit.&nbsp; It would be great to have some sort of chart that gives us visibility into this.&nbsp; I think maybe one way to get that would be to have the consumer threads publish a metric about how many messages they fetch on each pull.&nbsp; The max is 10, but if they are only actually getting 1, that probably means that we have more threads running than we need.&nbsp; If they are getting 10 every time the we are probably on the verge of or already falling behind.&nbsp; Would be nice to add this now as it will help us resize the pools once we have split the traffic.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref13" id="cmnt13">[m]</a><span class="c2">Ooh, cool idea. Yeah I&#39;ll add that as a note too.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref14" id="cmnt14">[n]</a><span class="c2">How are messages already enqueued (but not yet dequeued [successfully]) handled?</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref15" id="cmnt15">[o]</a><span class="c2">They&#39;ll be dequeued when the down SQS region recovers, which is probably the best we can do for those (short of making producers wait until the event is dequeued to guarantee completion)</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref16" id="cmnt16">[p]</a><span class="c2">Do we need to worry about lost (unreasonably delayed) messages (specifically, CAPTUREs), should SQS have an extended outage?</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref17" id="cmnt17">[q]</a><span class="c2">In practical terms, I don&#39;t think so.</span></p><p class="c15"><span class="c2">If there was an unprecedented outage (like on the order of days), it&#39;d be a lot more concerning, but without re-architecting a ton of systems and making clients hold on to additional state for extended periods, there isn&#39;t much we can do about this either way unfortunately.</span></p><p class="c15 c27"><span class="c2"></span></p><p class="c15"><span class="c2">Our options for assuming that an enqueued message might never get read come down to either making the client hold on to the event and wait/callback that it was processed, or enqueuing it to multiple SQS queues (more reasonable, but would double our financial costs and require us to attempt to process every event twice).</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref18" id="cmnt18">[r]</a><span class="c2">Yeah, this was a specific non-goal of the project.&nbsp; Besides some other operational advantages, we are making it so that we aren&#39;t completely down the entire time an AWS region is out.&nbsp; We will have some impact in the O(100) messages in flight being severely delayed.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref19" id="cmnt19">[s]</a><span class="c2">If this is a non-goal, can it be explicitly called out as as such in the main document (maybe with a sentence of justification, or even a brief section with ramifications)?&nbsp; Otherwise, I&#39;d&#39;ve assumed that &quot;recovering enqueued messages and promptly handling them&quot; would be a goal of DR</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref20" id="cmnt20">[t]</a><span class="c2">Yep, I called that out in the &quot;Assumptions&quot; section at the top, that we would handle messages that currently inside the unavailable&nbsp;region once it comes back online.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref21" id="cmnt21">[u]</a><span class="c2">Should be helpful to link this section to here for shifting AQ between SQS regions: https://docs.google.com/document/d/1GBAodAshPVy8tv5_pdrpWlQR-DAK9eSj-KvpELB1Um8/edit#heading=h.nu4aogld0ns1</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref22" id="cmnt22">[v]</a><span class="c2">I&#39;d like to see some more detail on what needs to change.&nbsp; At least some statement of &quot;we need separate data lines by region&quot;.&nbsp; But, which graphs split by AWS region vs. SQ datacenter? Do we need the cross-product?&nbsp; Which graphs don&#39;t need to split them out?</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref23" id="cmnt23">[w]</a><span class="c2">Make a different instance per queue URL.</span></p></div><div class="c13"><p class="c15"><a href="#cmnt_ref24" id="cmnt24">[x]</a><span class="c2">or, shouldn&#39;t you just have a different QueueService instance per region?</span></p></div></body></html>
