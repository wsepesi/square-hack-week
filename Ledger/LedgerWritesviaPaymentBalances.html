<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_vo3dja6u3a3p-0>li:before{content:"\0025cf   "}ul.lst-kix_vo3dja6u3a3p-1{list-style-type:none}ul.lst-kix_vo3dja6u3a3p-0{list-style-type:none}.lst-kix_vo3dja6u3a3p-1>li:before{content:"\0025cb   "}ul.lst-kix_vo3dja6u3a3p-5{list-style-type:none}ul.lst-kix_vo3dja6u3a3p-4{list-style-type:none}ul.lst-kix_vo3dja6u3a3p-3{list-style-type:none}ul.lst-kix_vo3dja6u3a3p-2{list-style-type:none}.lst-kix_vo3dja6u3a3p-5>li:before{content:"\0025a0   "}.lst-kix_vo3dja6u3a3p-6>li:before{content:"\0025cf   "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_vo3dja6u3a3p-8>li:before{content:"\0025a0   "}.lst-kix_vo3dja6u3a3p-7>li:before{content:"\0025cb   "}.lst-kix_vo3dja6u3a3p-4>li:before{content:"\0025cb   "}ul.lst-kix_vo3dja6u3a3p-8{list-style-type:none}.lst-kix_vo3dja6u3a3p-3>li:before{content:"\0025cf   "}ul.lst-kix_vo3dja6u3a3p-7{list-style-type:none}ul.lst-kix_vo3dja6u3a3p-6{list-style-type:none}.lst-kix_vo3dja6u3a3p-2>li:before{content:"\0025a0   "}ol{margin:0;padding:0}table td,table th{padding:0}.c4{margin-left:72pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c1{margin-left:36pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:26pt;font-family:"Arial";font-style:normal}.c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c9{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c13{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c10{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c6{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c8{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#0000ee;text-decoration:underline}.c12{background-color:#ffffff;max-width:720pt;padding:36pt 36pt 36pt 36pt}.c11{color:inherit;text-decoration:inherit}.c2{padding:0;margin:0}.c7{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c12 doc-content"><p class="c10 title" id="h.seknxo4syxrr"><span class="c3">Ledger Writes via PaymentBalances</span></p><p class="c6"><span>Author: </span><span class="c8"><a class="c11" href="mailto:dskarbek@squareup.com">Daniel Skarbek</a></span></p><p class="c6"><span>Date: </span><span>Mar 13, 2023</span></p><p class="c6"><span class="c0">Status: WIP</span></p><p class="c6 c7"><span class="c0"></span></p><h1 class="c9" id="h.etp5t6a3jca8"><span class="c5">Goal</span></h1><p class="c6"><span class="c0">We want Books service to be completely encapsulated by FinancialAccount (which is the platform service under PaymentBalanes). &nbsp;That means all connectivity between Ledger and Books needs to be removed. &nbsp;The plan is to first replace all reads with calls to PaymentBalances and then replace all writes. &nbsp;This doc is about removing write connections from Ledger to Books and should be the path to completely dropping the ledger-&gt;books connection.</span></p><h1 class="c9" id="h.ktyg5z6lqyma"><span class="c5">Ledger Writes to Books</span></h1><ul class="c2 lst-kix_vo3dja6u3a3p-0 start"><li class="c1 li-bullet-0"><span class="c0">The following RPCs directly execute an event handler and then return the journal entry id that is persisted</span></li></ul><ul class="c2 lst-kix_vo3dja6u3a3p-1 start"><li class="c4 li-bullet-0"><span class="c0">BookDepositAction</span></li><li class="c4 li-bullet-0"><span class="c0">FailDepositAction</span></li><li class="c4 li-bullet-0"><span class="c0">CreateForgiveDebtJournalEntryAction</span></li><li class="c4 li-bullet-0"><span class="c0">RiskReserveReleaseAction</span></li><li class="c4 li-bullet-0"><span>CreateRiskReserveHoldAction (not the id, but the hold amount from the AccountingEvent). &nbsp;This event is synchronous because it uses balance assertions to not reserve more than it should. &nbsp;</span><span class="c13">Might need a max balance option for this.</span></li></ul><ul class="c2 lst-kix_vo3dja6u3a3p-0"><li class="c1 li-bullet-0"><span class="c0">JournalEntryAccountingEventHander, the base class of all AccountingEventHandlers writes journal commands, all the handlers need to switch to writing PaymentBalance transactions</span></li></ul><ul class="c2 lst-kix_vo3dja6u3a3p-1 start"><li class="c4 li-bullet-0"><span class="c0">&lt;list all handlers&gt;</span></li></ul><ul class="c2 lst-kix_vo3dja6u3a3p-0"><li class="c1 li-bullet-0"><span class="c0">MerchantUpdatesFeedListener reads books to ensure we have the basic books pre-created and that the books are in the right currency. &nbsp;This will switch over to ensuring the PaymentBalance account.</span></li><li class="c1 li-bullet-0"><span class="c0">CreateRiskReserveHoldAction creates the RISK_RESERVE_PAYABLE book on the fly. &nbsp;Need to make the PB account instead.</span></li><li class="c1 li-bullet-0"><span class="c0">BooksBalanceCorrector creates missing books and adjusts the balances to match ledger data.</span></li><li class="c1 li-bullet-0"><span class="c0">BackfillPaymentBalanceAccountService reads books to find all the PaymentBalance Accounts that should exist.</span></li><li class="c1 li-bullet-0"><span class="c0">FeePaymentBalanceHelper used by CreateFeeLedgerEntryAction and EnableGrossSettlementForMerchantAction to create the fee payable book on the fly. &nbsp;Will be replaced with creating the fee account on the fly.</span></li><li class="c1 li-bullet-0"><span class="c0">ConvertBankSettlementEntryToBooksJournalEntry used by BooksJournalEntryBankSettlementEntryFeedListener processes the BankSettlementEntry&rsquo;s from ledger and records settlement adjustments to books.</span></li><li class="c1 li-bullet-0"><span class="c0">EnableBooksForHighThroughputResponse reads and writes book properties, will be made obsolete by books clean-up work.</span></li></ul><p class="c6 c7"><span class="c0"></span></p><p class="c6"><span class="c0">Need all accounting writes to go via PaymentBalances, not to ledger first. &nbsp;The last hold outs on this are the BizbankSweep and reverse sweep and the DepositFees (and undo). &nbsp;Deposit Fees are the only event that can call the &ldquo;processEventSync&rdquo; interface on the BCEProcessor, and the Bizbank sweep handlers use the alternate (and defunct) &ldquo;dual write&rdquo; infrastructure.</span></p></body></html>
