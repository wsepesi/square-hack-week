<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=lhDjYqiy3mZ0x6ROQEUoUw);.lst-kix_jl8n8ntmsuem-4>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-4}.lst-kix_jl8n8ntmsuem-3>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-3}.lst-kix_jl8n8ntmsuem-1>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-1}.lst-kix_md3t8hu2rufw-2>li:before{content:"\0025a0   "}.lst-kix_md3t8hu2rufw-1>li:before{content:"\0025cb   "}.lst-kix_md3t8hu2rufw-3>li:before{content:"\0025cf   "}.lst-kix_md3t8hu2rufw-7>li:before{content:"\0025cb   "}.lst-kix_7fgg3n76em5v-7>li:before{content:"\0025cb   "}.lst-kix_md3t8hu2rufw-0>li:before{content:"\0025cf   "}.lst-kix_md3t8hu2rufw-8>li:before{content:"\0025a0   "}.lst-kix_jl8n8ntmsuem-7>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-7}.lst-kix_7fgg3n76em5v-8>li:before{content:"\0025a0   "}.lst-kix_jl8n8ntmsuem-0>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-0}ol.lst-kix_jl8n8ntmsuem-3.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-3 0}.lst-kix_md3t8hu2rufw-6>li:before{content:"\0025cf   "}.lst-kix_md3t8hu2rufw-5>li:before{content:"\0025a0   "}.lst-kix_jl8n8ntmsuem-6>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-6}.lst-kix_g4cg48tqbea5-7>li:before{content:"\0025cb   "}.lst-kix_md3t8hu2rufw-4>li:before{content:"\0025cb   "}.lst-kix_g4cg48tqbea5-8>li:before{content:"\0025a0   "}.lst-kix_7fgg3n76em5v-0>li:before{content:"\0025cf   "}ul.lst-kix_md3t8hu2rufw-2{list-style-type:none}ul.lst-kix_md3t8hu2rufw-3{list-style-type:none}ul.lst-kix_md3t8hu2rufw-0{list-style-type:none}ul.lst-kix_md3t8hu2rufw-1{list-style-type:none}.lst-kix_7fgg3n76em5v-1>li:before{content:"\0025cb   "}.lst-kix_7fgg3n76em5v-3>li:before{content:"\0025cf   "}ul.lst-kix_md3t8hu2rufw-6{list-style-type:none}ul.lst-kix_md3t8hu2rufw-7{list-style-type:none}ul.lst-kix_md3t8hu2rufw-4{list-style-type:none}ul.lst-kix_md3t8hu2rufw-5{list-style-type:none}.lst-kix_7fgg3n76em5v-2>li:before{content:"\0025a0   "}.lst-kix_7fgg3n76em5v-6>li:before{content:"\0025cf   "}ol.lst-kix_jl8n8ntmsuem-4.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-4 0}.lst-kix_7fgg3n76em5v-5>li:before{content:"\0025a0   "}.lst-kix_7fgg3n76em5v-4>li:before{content:"\0025cb   "}.lst-kix_yc7fj7d4ld9p-5>li:before{content:"\0025a0   "}.lst-kix_yc7fj7d4ld9p-2>li:before{content:"\0025a0   "}.lst-kix_yc7fj7d4ld9p-6>li:before{content:"\0025cf   "}ul.lst-kix_md3t8hu2rufw-8{list-style-type:none}.lst-kix_yc7fj7d4ld9p-3>li:before{content:"\0025cf   "}.lst-kix_yc7fj7d4ld9p-4>li:before{content:"\0025cb   "}ul.lst-kix_7fgg3n76em5v-5{list-style-type:none}ul.lst-kix_7fgg3n76em5v-6{list-style-type:none}ul.lst-kix_7fgg3n76em5v-3{list-style-type:none}ul.lst-kix_7fgg3n76em5v-4{list-style-type:none}ul.lst-kix_7fgg3n76em5v-1{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-8.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-8 0}ul.lst-kix_7fgg3n76em5v-2{list-style-type:none}ul.lst-kix_7fgg3n76em5v-0{list-style-type:none}.lst-kix_yc7fj7d4ld9p-1>li:before{content:"\0025cb   "}ol.lst-kix_jl8n8ntmsuem-0.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-0 0}ul.lst-kix_7fgg3n76em5v-7{list-style-type:none}.lst-kix_yc7fj7d4ld9p-0>li:before{content:"\0025cf   "}ul.lst-kix_7fgg3n76em5v-8{list-style-type:none}ul.lst-kix_yc7fj7d4ld9p-4{list-style-type:none}.lst-kix_jl8n8ntmsuem-0>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-0,decimal) ". "}.lst-kix_jl8n8ntmsuem-1>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-1,lower-latin) ". "}ul.lst-kix_yc7fj7d4ld9p-5{list-style-type:none}.lst-kix_ejyfk2odw310-4>li:before{content:"\0025cb   "}.lst-kix_ejyfk2odw310-5>li:before{content:"\0025a0   "}ol.lst-kix_jl8n8ntmsuem-5.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-5 0}ul.lst-kix_yc7fj7d4ld9p-6{list-style-type:none}ul.lst-kix_yc7fj7d4ld9p-7{list-style-type:none}ul.lst-kix_yc7fj7d4ld9p-8{list-style-type:none}.lst-kix_jl8n8ntmsuem-2>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-2,lower-roman) ". "}.lst-kix_ejyfk2odw310-3>li:before{content:"\0025cf   "}.lst-kix_g4cg48tqbea5-6>li:before{content:"\0025cf   "}.lst-kix_jl8n8ntmsuem-4>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-4,lower-latin) ". "}.lst-kix_jl8n8ntmsuem-5>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-5,lower-roman) ". "}.lst-kix_ejyfk2odw310-0>li:before{content:"\0025cf   "}.lst-kix_ejyfk2odw310-1>li:before{content:"\0025cb   "}.lst-kix_g4cg48tqbea5-5>li:before{content:"\0025a0   "}.lst-kix_g4cg48tqbea5-4>li:before{content:"\0025cb   "}ul.lst-kix_yc7fj7d4ld9p-0{list-style-type:none}.lst-kix_jl8n8ntmsuem-3>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-3,decimal) ". "}ul.lst-kix_yc7fj7d4ld9p-1{list-style-type:none}.lst-kix_ejyfk2odw310-2>li:before{content:"\0025a0   "}ol.lst-kix_jl8n8ntmsuem-2.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-2 0}ul.lst-kix_yc7fj7d4ld9p-2{list-style-type:none}ul.lst-kix_yc7fj7d4ld9p-3{list-style-type:none}.lst-kix_g4cg48tqbea5-2>li:before{content:"\0025a0   "}.lst-kix_jl8n8ntmsuem-8>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-8,lower-roman) ". "}.lst-kix_g4cg48tqbea5-1>li:before{content:"\0025cb   "}.lst-kix_g4cg48tqbea5-3>li:before{content:"\0025cf   "}.lst-kix_jl8n8ntmsuem-6>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-6,decimal) ". "}.lst-kix_g4cg48tqbea5-0>li:before{content:"\0025cf   "}.lst-kix_jl8n8ntmsuem-7>li:before{content:"" counter(lst-ctn-kix_jl8n8ntmsuem-7,lower-latin) ". "}ol.lst-kix_jl8n8ntmsuem-6.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-6 0}ol.lst-kix_jl8n8ntmsuem-1{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-0{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-3{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-2{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-5{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-4{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-7{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-6{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-8{list-style-type:none}.lst-kix_ejyfk2odw310-6>li:before{content:"\0025cf   "}.lst-kix_jl8n8ntmsuem-5>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-5}ul.lst-kix_ejyfk2odw310-7{list-style-type:none}ul.lst-kix_ejyfk2odw310-6{list-style-type:none}.lst-kix_jl8n8ntmsuem-8>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-8}ul.lst-kix_ejyfk2odw310-5{list-style-type:none}.lst-kix_jl8n8ntmsuem-2>li{counter-increment:lst-ctn-kix_jl8n8ntmsuem-2}ul.lst-kix_g4cg48tqbea5-8{list-style-type:none}ul.lst-kix_ejyfk2odw310-4{list-style-type:none}ul.lst-kix_ejyfk2odw310-3{list-style-type:none}ul.lst-kix_ejyfk2odw310-2{list-style-type:none}.lst-kix_ejyfk2odw310-7>li:before{content:"\0025cb   "}ul.lst-kix_ejyfk2odw310-1{list-style-type:none}ul.lst-kix_ejyfk2odw310-0{list-style-type:none}ol.lst-kix_jl8n8ntmsuem-7.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-7 0}.lst-kix_ejyfk2odw310-8>li:before{content:"\0025a0   "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ol.lst-kix_jl8n8ntmsuem-1.start{counter-reset:lst-ctn-kix_jl8n8ntmsuem-1 0}ul.lst-kix_g4cg48tqbea5-3{list-style-type:none}ul.lst-kix_g4cg48tqbea5-2{list-style-type:none}ul.lst-kix_g4cg48tqbea5-1{list-style-type:none}ul.lst-kix_g4cg48tqbea5-0{list-style-type:none}ul.lst-kix_g4cg48tqbea5-7{list-style-type:none}.lst-kix_yc7fj7d4ld9p-7>li:before{content:"\0025cb   "}ul.lst-kix_g4cg48tqbea5-6{list-style-type:none}ul.lst-kix_g4cg48tqbea5-5{list-style-type:none}.lst-kix_yc7fj7d4ld9p-8>li:before{content:"\0025a0   "}ul.lst-kix_g4cg48tqbea5-4{list-style-type:none}ul.lst-kix_ejyfk2odw310-8{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.c31{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:1pt;width:257.1pt;border-top-color:#999999;border-bottom-style:solid}.c27{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:1pt;width:83.8pt;border-top-color:#999999;border-bottom-style:solid}.c24{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:1pt;width:257.1pt;border-top-color:#999999;border-bottom-style:solid}.c17{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:1pt;width:63.6pt;border-top-color:#999999;border-bottom-style:solid}.c9{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#ffffff;border-left-style:solid;border-bottom-width:1pt;width:83.8pt;border-top-color:#999999;border-bottom-style:solid}.c28{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#999999;border-top-width:1pt;border-right-width:1pt;border-left-color:#999999;vertical-align:top;border-right-color:#999999;border-left-width:1pt;border-top-style:solid;background-color:#f3f3f3;border-left-style:solid;border-bottom-width:1pt;width:63.6pt;border-top-color:#999999;border-bottom-style:solid}.c8{margin-left:72pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c14{margin-left:72pt;padding-top:0pt;padding-left:0pt;padding-bottom:10pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c39{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c5{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.c12{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c6{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c15{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:9pt;font-family:"Arial";font-style:normal}.c29{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c10{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c16{padding-top:0pt;padding-bottom:10pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c22{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-family:"Arial"}.c32{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.c35{border-spacing:0;border-collapse:collapse;margin-right:auto}.c25{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c38{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#0000ee;text-decoration:underline}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c26{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c21{margin-left:36pt;padding-left:0pt}.c30{margin-left:144pt;padding-left:0pt}.c18{margin-left:108pt;padding-left:0pt}.c40{font-size:26pt;font-style:normal}.c3{border:1px solid black;margin:5px}.c13{font-size:9pt;font-style:italic}.c11{color:inherit;text-decoration:inherit}.c1{font-weight:400;font-family:"Consolas"}.c7{padding:0;margin:0}.c4{height:11pt}.c34{height:21pt}.c20{height:0pt}.c36{font-size:10pt}.c23{font-weight:700}.c37{height:2.7pt}.c33{font-size:9pt}.c19{font-style:italic}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c26 doc-content"><p class="c39 title" id="h.wj31xtc84yc3"><span class="c22 c40">Ledger: Gift Cards with App Fees</span></p><p class="c10"><span class="c6">Author: Kevin Crane</span></p><p class="c10"><span>Tickets: </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-3218&amp;sa=D&amp;source=editors&amp;ust=1689357871751233&amp;usg=AOvVaw3VUGO5vlQ8y9rGHTof-7Ju">ACTENG-3218</a></span><span>&nbsp;(design); </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-2936&amp;sa=D&amp;source=editors&amp;ust=1689357871751571&amp;usg=AOvVaw1i8rHmRInUBgwppCFu7BMb">ACTENG-2936</a></span><span class="c6">&nbsp;(epic)</span></p><p class="c10"><span class="c6">Date updated: 2/10/21</span></p><p class="c10"><span>Status: </span><span class="c23">approved on 1/8/21 (for </span><span class="c23 c19">Option 2</span><span class="c12">&nbsp;in design)</span></p><p class="c10"><span>Related doc: </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://docs.google.com/document/d/1aizpc3kP5jCGqnimWscniqoaEISxkXUExE_yQHU7Ik0/edit?&amp;sa=D&amp;source=editors&amp;ust=1689357871752096&amp;usg=AOvVaw2_bdSOCTy31sxiWoc3Z7ws">Gift Card SOS Delivery Fees</a></span></p><p class="c10"><span>Estimated development timeline: Q1 &lsquo;21</span><span class="c12"><br></span></p><a id="t.056d0721fea994b302e4adbce3a82c47d564e29c"></a><a id="t.0"></a><table class="c35"><tr class="c34"><td class="c27" colspan="1" rowspan="1"><p class="c0"><span class="c23 c36">LDAP</span><sup><a href="#cmnt1" id="cmnt_ref1">[a]</a></sup><sup><a href="#cmnt2" id="cmnt_ref2">[b]</a></sup><sup><a href="#cmnt3" id="cmnt_ref3">[c]</a></sup><sup><a href="#cmnt4" id="cmnt_ref4">[d]</a></sup><sup><a href="#cmnt5" id="cmnt_ref5">[e]</a></sup></p></td><td class="c28" colspan="1" rowspan="1"><p class="c0"><span class="c5">Team</span></p></td><td class="c28" colspan="1" rowspan="1"><p class="c0"><span class="c5">Approved?</span></p></td><td class="c31" colspan="1" rowspan="1"><p class="c0"><span class="c5">Other Comments</span></p></td></tr><tr class="c20"><td class="c9" colspan="1" rowspan="1"><p class="c0"><span class="c2">hsilverio</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">ActEng</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">Yes</span></p></td><td class="c24" colspan="1" rowspan="1"><p class="c0"><span class="c13 c22">Looks good to me.</span></p></td></tr><tr class="c20"><td class="c9" colspan="1" rowspan="1"><p class="c0"><span class="c2">agray</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">ActEng</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">Yes</span></p></td><td class="c24" colspan="1" rowspan="1"><p class="c0"><span class="c13">LGTM so far. Added Ben, Dan, Mike and Ming (who was involved in the related ACH refactor) as reviewers. &nbsp; Hoping Steve Brewer or </span><span class="c13">Chris</span><sup><a href="#cmnt6" id="cmnt_ref6">[f]</a></sup><sup><a href="#cmnt7" id="cmnt_ref7">[g]</a></sup><sup><a href="#cmnt8" id="cmnt_ref8">[h]</a></sup><span class="c22 c13">&nbsp;Heisel can ID any outside stakeholders to review. </span></p></td></tr><tr class="c20"><td class="c9" colspan="1" rowspan="1"><p class="c0"><span class="c2">eblock</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">ActEng</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0 c4"><span class="c2"></span></p></td><td class="c24" colspan="1" rowspan="1"><p class="c0 c4"><span class="c22 c13"></span></p></td></tr><tr class="c20"><td class="c9" colspan="1" rowspan="1"><p class="c0"><span class="c2">benv</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">ActEng</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">Yes</span></p></td><td class="c24" colspan="1" rowspan="1"><p class="c0"><span class="c22 c13">Option 2 makes sense to me. &nbsp;I&rsquo;m sure the deduplication concerns can be handled. &nbsp;</span></p></td></tr><tr class="c37"><td class="c9" colspan="1" rowspan="1"><p class="c0"><span class="c2">dskarbek</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">ActEng</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0 c4"><span class="c2"></span></p></td><td class="c24" colspan="1" rowspan="1"><p class="c0 c4"><span class="c22 c13"></span></p></td></tr><tr class="c20"><td class="c9" colspan="1" rowspan="1"><p class="c0"><span class="c2">stevebrewer</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">ActEng</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c33">Yes</span><sup><a href="#cmnt9" id="cmnt_ref9">[i]</a></sup><sup><a href="#cmnt10" id="cmnt_ref10">[j]</a></sup><sup><a href="#cmnt11" id="cmnt_ref11">[k]</a></sup><sup><a href="#cmnt12" id="cmnt_ref12">[l]</a></sup><sup><a href="#cmnt13" id="cmnt_ref13">[m]</a></sup><sup><a href="#cmnt14" id="cmnt_ref14">[n]</a></sup></p></td><td class="c24" colspan="1" rowspan="1"><p class="c0"><span class="c22 c13">Glad to see the refactoring done last year paying dividends here! </span></p><p class="c0 c4"><span class="c22 c13"></span></p><p class="c0"><span class="c22 c13">One concern i have is the potential for fraud and loss. Say a seller sells $100 gift card, we settle them their money, their balance is $0.</span></p><p class="c0 c4"><span class="c22 c13"></span></p><p class="c0"><span class="c13">Then, they spend the gift card on the API with an app fee of $5. Seller&rsquo;s balance is -$5, developer balance is $5. We settle the $5. &nbsp;That Seller could have disconnected their bank account at this point, or even churned off of Square. </span><sup><a href="#cmnt15" id="cmnt_ref15">[o]</a></sup><sup><a href="#cmnt16" id="cmnt_ref16">[p]</a></sup></p><p class="c0 c4"><span class="c22 c13"></span></p><p class="c0"><span class="c13">I think this should be called out in the doc and risk should be looped in, though I don&rsquo;t think we have to hold up the first draft on it.</span><sup><a href="#cmnt17" id="cmnt_ref17">[q]</a></sup></p></td></tr><tr class="c20"><td class="c9" colspan="1" rowspan="1"><p class="c0"><span class="c2">minghua</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">ActEng</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0 c4"><span class="c2"></span></p></td><td class="c24" colspan="1" rowspan="1"><p class="c0 c4"><span class="c22 c13"></span></p></td></tr><tr class="c20"><td class="c9" colspan="1" rowspan="1"><p class="c0"><span class="c2">rpeterson</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0"><span class="c2">Risk</span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c0 c4"><span class="c2"></span></p></td><td class="c24" colspan="1" rowspan="1"><p class="c0 c4"><span class="c22 c13"></span></p></td></tr></table><h1 class="c29" id="h.l7bwudcj6phc"><span class="c15">Issue Addressed By This Feature</span></h1><p class="c16"><span>A more detailed description is in the </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://docs.google.com/document/d/1aizpc3kP5jCGqnimWscniqoaEISxkXUExE_yQHU7Ik0/edit?ts%3D5f05334d%23heading%3Dh.gqaiydoi4wb9&amp;sa=D&amp;source=editors&amp;ust=1689357871763028&amp;usg=AOvVaw09nBu4l7wvQSwsP-t12ELf">Summary section of this document</a></span><span class="c6">.</span></p><p class="c16"><span class="c6">The quick overview from Ledger&rsquo;s perspective is that we want to be able to charge AppFees from a Square Merchant to a developer or App Merchant (e.g. a delivery partner such as Doordash or Postmates) when making a purchase with a gift card.</span></p><p class="c16"><span>The reason why this isn&rsquo;t currently possible is that an AppFee is typically associated with a Capture. However, the actual money movement associated with a Gift Card happens upfront at a different time; the App Fee portion of this transaction comes when making a purchase later from the balance of this gift card (which does not require any money movement to the merchant, as the merchant received money for the gift card earlier).</span><sup><a href="#cmnt18" id="cmnt_ref18">[r]</a></sup></p><p class="c16"><span class="c6">This is painful from a customer&rsquo;s perspective because even though they have a gift card balance with the merchant they&rsquo;re ordering from, if they order delivery or anything else with an AppFee, they have to use their own credit card to create a new Capture so we can transfer money from the Merchant to the Developer.</span></p><p class="c16"><span>An example of a live Gift Card PaymentRecord without an AppFee can be seen </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://rqm.sjc2b.sqprod.co/index/payment%23/query/9SYrS2U0W8G1bGe545mH3VMLuaB&amp;sa=D&amp;source=editors&amp;ust=1689357871764071&amp;usg=AOvVaw3P6A1dZLpqvAp2w273CZVj">here</a></span><span class="c6">.</span></p><h1 class="c29" id="h.y2rsjnegs176"><span class="c15">Solution</span></h1><p class="c16"><span>Luckily, with a recent refactor we did with Ledger&rsquo;s handling of payments from the Esperanto feed (</span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-2757&amp;sa=D&amp;source=editors&amp;ust=1689357871764506&amp;usg=AOvVaw2MMgbRiLIiUK10z75QxAk-">ACTENG-2757</a></span><span>, </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://docs.google.com/document/d/1VqkcqgvrEfmc42jxyiHR_yqkx2j1n2uYX7qOVOz7z98/edit%23&amp;sa=D&amp;source=editors&amp;ust=1689357871764799&amp;usg=AOvVaw3pXiKk5JSNGKuaCDsX2-lg">design doc</a></span><span class="c6">), adding more customized payment handling is far easier to incorporate than before.</span></p><p class="c16"><span>We&rsquo;d want to create a new </span><span class="c1">PaymentRecordProcessor</span><span>&nbsp;called </span><span class="c1">GiftCardAppFeePaymentRecordProcessor</span><span>, similar to the existing </span><span class="c1">CardCapturePaymentRecordProcessor</span><span>. </span><span class="c6">In this, we&rsquo;d either:</span></p><ul class="c7 lst-kix_7fgg3n76em5v-0 start"><li class="c16 c21 li-bullet-0"><span>Option 1: </span><span>Create a new Capture event </span><sup><a href="#cmnt19" id="cmnt_ref19">[s]</a></sup><sup><a href="#cmnt20" id="cmnt_ref20">[t]</a></sup><span>with the desired </span><span class="c1">app_fee_amount</span><span>&nbsp;and a </span><span class="c1">to_merchant_amount</span><span>&nbsp;</span><span>of zero</span><sup><a href="#cmnt21" id="cmnt_ref21">[u]</a></sup><sup><a href="#cmnt22" id="cmnt_ref22">[v]</a></sup><span>. This would then get enqueued into Ledger where the appropriate </span><span class="c1">THIRD_PARTY_FEE</span><span>&nbsp;event would get debited to the Merchant, and an equivalent </span><span class="c1">APP_FEE</span><span>&nbsp;event would be credited to the </span><span>App Merchant&rsquo;s</span><span class="c6">&nbsp;balance (Option 1 in the Changes Proposed section).</span></li><li class="c16 c21 li-bullet-0"><span>Option 2: </span><span>Alternatively</span><span class="c6">, we could manually create just the ThirdPartyFee and AppFee events, which would result in the same Ledger entries but with the benefit of being explicit in our code about what events are being created.</span></li></ul><p class="c16"><span>&nbsp;We would also do the same thing for </span><span class="c1">GiftCardRefundPaymentRecordProcessor</span><span class="c6">, but in the opposite direction.</span></p><h1 class="c29" id="h.342ylayjgn5g"><span class="c15">Changes Proposed</span></h1><ol class="c7 lst-kix_jl8n8ntmsuem-0 start" start="1"><li class="c10 c21 li-bullet-0"><span class="c1">GiftCardAppFeePaymentRecordProcessor</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-1 start" start="1"><li class="c8 li-bullet-0"><span>This class would follow the exact same template as </span><span class="c1">CardCapturePaymentRecordProcessor</span><span>&nbsp;and </span><span class="c1">BankCapturePaymentRecordProcessor</span><span class="c6">.</span></li><li class="c8 li-bullet-0"><span class="c32 c1">shouldProcess</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-2 start" start="1"><li class="c10 c18 li-bullet-0"><span>We would want to process any PaymentRecord from the Esperanto Feed that </span><span class="c1">isGiftCard</span><span>&nbsp;(defined in </span><span class="c1">LedgerPaymentFilter</span><span>), </span><span class="c1">hasCaptureIntent</span><span>, and </span><span class="c1">hasAppFee</span><span class="c6">.</span></li><li class="c10 c18 li-bullet-0"><span>If it&rsquo;s not a gift card transaction </span><span>or</span><sup><a href="#cmnt23" id="cmnt_ref23">[w]</a></sup><sup><a href="#cmnt24" id="cmnt_ref24">[x]</a></sup><sup><a href="#cmnt25" id="cmnt_ref25">[y]</a></sup><sup><a href="#cmnt26" id="cmnt_ref26">[z]</a></sup><sup><a href="#cmnt27" id="cmnt_ref27">[aa]</a></sup><span class="c6">&nbsp;doesn&rsquo;t have a Capture, obviously we shouldn&rsquo;t touch this payment record at all.</span></li><li class="c10 c18 li-bullet-0"><span>if</span><span>&nbsp;it</span><sup><a href="#cmnt28" id="cmnt_ref28">[ab]</a></sup><sup><a href="#cmnt29" id="cmnt_ref29">[ac]</a></sup><span class="c6">&nbsp;doesn&rsquo;t have an AppFee, then we shouldn&rsquo;t create a Ledger entry for this transaction as the money movement will have already happened at the time of the initial gift card purchase.</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-1" start="3"><li class="c8 li-bullet-0"><span class="c6">There are two good options for how to implement this class. Both of them would result in essentially the same output with the same compute cost, so this decision mostly comes down to code cleanliness and minimizing future cognitive load of understanding the business logic. I&rsquo;ll lay out the pros/cons of each below.</span></li><li class="c8 li-bullet-0"><span class="c23">Option 1:</span><span>&nbsp;extend </span><span class="c1">CapturePaymentRecordProcessor</span><sup><a href="#cmnt30" id="cmnt_ref30">[ad]</a></sup><sup><a href="#cmnt31" id="cmnt_ref31">[ae]</a></sup><sup><a href="#cmnt32" id="cmnt_ref32">[af]</a></sup><span>&nbsp;(and implement </span><span class="c1">convertToCaptureEventSpec</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-2 start" start="1"><li class="c10 c18 li-bullet-0"><span>This would largely duplicate what&rsquo;s already in </span><span class="c1">CardCapturePaymentRecordProcessor</span><span class="c6">.</span></li><li class="c10 c18 li-bullet-0"><span>The big changes that would be needed is to set </span><span class="c1">totalPaymentAmount</span><span class="c6">&nbsp;to 0, as we are not settling any money to the merchant with this transaction.</span></li><li class="c10 c18 li-bullet-0"><span>The </span><span class="c1">CaptureEventSpec</span><span class="c6">&nbsp;is intended to act as the input data structure when creating new Capture ledger entries. However, the Capture event handlers that use this are also responsible for creating ThirdPartyFee events that would debit the merchant and AppFee events that credit a different app merchant. This means that even though there is typically little value in creating a $0 Capture ledger entry (pun very intended), we can reuse the same classes to also make the desired money movement between merchant and app merchant.</span></li><li class="c10 c18 li-bullet-0"><span class="c23">Benefits:</span><span>&nbsp;we can reuse large parts of </span><span class="c1">CapturePaymentRecordProcessor</span><span class="c6">, potentially being the simplest to implement (2 easy methods with very little unique business logic).</span></li><li class="c10 c18 li-bullet-0"><span class="c23">Downsides:</span><span>&nbsp;we would end up creating an unnecessary </span><span>Capture ledger entry with each transaction. In a sense, this wouldn&rsquo;t really matter as the Capture would be for $0.00 and would not settle out</span><sup><a href="#cmnt33" id="cmnt_ref33">[ag]</a></sup><sup><a href="#cmnt34" id="cmnt_ref34">[ah]</a></sup><span>. However, it could create confusion in the future if we have to modify this code in the future and are wondering why we are creating captures but explicitly zeroing out the amount paid to the merchant.<br>Right now in </span><span class="c1">CaptureAccountingEventHandler</span><span>, although our preconditions specify that the </span><span class="c1">toUser</span><span>&nbsp;amount must be </span><span class="c1">&gt;=0</span><span>, </span><sup><a href="#cmnt35" id="cmnt_ref35">[ai]</a></sup><sup><a href="#cmnt36" id="cmnt_ref36">[aj]</a></sup><span class="c1">CaptureTemplateBuilder</span><span>&nbsp;will actually throw an exception if the </span><span class="c1">toUser</span><span>&nbsp;amount </span><span class="c1">==0</span><span class="c6">&nbsp;when creating the Journal Entry. This would also need to be reconciled if we do proceed with this option as well (presumably by just not creating a Journal Entry if the amount is $0).</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-1" start="5"><li class="c8 li-bullet-0"><span class="c23">Option 2:</span><span>&nbsp;extend </span><span class="c1">PaymentRecordProcessor</span><span>&nbsp;to create a standalone processor (implement </span><span class="c1">processPaymentRecord</span><span class="c6">)</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-2 start" start="1"><li class="c10 c18 li-bullet-0"><span>In </span><span class="c1">CaptureEventHandler</span><span>&nbsp;and </span><span class="c1">CaptureAccountingEventHandler</span><span>, when we are processing a Capture event, we check if an AppFee is attached and create </span><span>and enqueue a THIRD_PARTY_FEE and APP_FEE_REVENUE Ledger entries or Journal Commands, respectively</span><sup><a href="#cmnt37" id="cmnt_ref37">[ak]</a></sup><span class="c6">.</span></li><li class="c10 c18 li-bullet-0"><span>Since the only output we need from </span><span class="c1">processPaymentRecord</span><span>&nbsp;is a list of </span><span class="c1">EventToEnqueues</span><span>&nbsp;</span><span>to enqueue to the BCEQ</span><span>, we could also cut out the Capture portion entirely and just create </span><span>2 </span><span class="c1">EventToEnqueues</span><sup><a href="#cmnt38" id="cmnt_ref38">[al]</a></sup><span class="c6">.</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-3 start" start="1"><li class="c10 c30 li-bullet-0"><span>An example of how to build a ThirdPartyFee event to enqueue is in </span><span class="c1">BalanceTenderEventFactory.toThirdPartyFeeEvent</span><span class="c6">.</span></li><li class="c10 c30 li-bullet-0"><span>An example of how to construct an AppFee event to enqueue is in </span><span class="c1">CaptureEventHandler.createAppFeeEvent</span><span class="c6">.</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-2" start="3"><li class="c10 c18 li-bullet-0"><span class="c23">Benefits:</span><span>&nbsp;the biggest benefit of this method is that we are explicit with the events that we expect to create with this PaymentRecordProcessor. There is far less ambiguity with what is happening behind the scenes with this method, and it should be simpler to reason about in the future. We also wouldn&rsquo;t have to make any changes to the Journal Entry portion of </span><span class="c1">CaptureAccountingEventHandler</span><span class="c6">, which reduces the risk of any unforeseen changes there.</span></li><li class="c10 c18 li-bullet-0"><span class="c23">Downsides:</span><span>&nbsp;</span><span>there would be more code duplication with this method</span><sup><a href="#cmnt39" id="cmnt_ref39">[am]</a></sup><sup><a href="#cmnt40" id="cmnt_ref40">[an]</a></sup><span class="c6">. In the current Ledger landscape, we are delegating the creation of third party fees and app fees to the Capture handlers, ensuring that they are created with the correct amounts. Duplication of code is probably pretty easy to work around with some refactoring of how we create these event types (a shared method for constructing EventToEnqueue objects).</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-1" start="6"><li class="c8 li-bullet-0"><span>At the moment, I think I&rsquo;d prefer </span><span class="c23">Option 2</span><sup><a href="#cmnt41" id="cmnt_ref41">[ao]</a></sup><sup><a href="#cmnt42" id="cmnt_ref42">[ap]</a></sup><sup><a href="#cmnt43" id="cmnt_ref43">[aq]</a></sup><sup><a href="#cmnt44" id="cmnt_ref44">[ar]</a></sup><span class="c6">&nbsp;for this based on the explicit nature of specifying exactly what events we expect to create, but I&rsquo;d definitely like to get feedback from others on their thoughts.</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-0" start="2"><li class="c10 c21 li-bullet-0"><span class="c1">GiftCardAppFeeRefundPaymentRecordProcessor</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-1 start" start="1"><li class="c8 li-bullet-0"><span>This would work essentially the same as </span><span class="c1">GiftCardAppFeePaymentRecordProcessor</span><span>, but with a </span><span class="c1">RefundIntent</span><span>&nbsp;on the </span><span class="c1">PaymentRecord</span><span>&nbsp;instead of a </span><span class="c1">CaptureIntent</span><span class="c6">. The same two design options as above would apply here as well.</span></li><li class="c8 li-bullet-0"><span>Each PaymentRecord with refunds has a list of </span><span class="c1">PartialRefunds</span><span>&nbsp;and a list of </span><span class="c1">AppFeeRefunds</span><span>&nbsp;(linked by a common </span><span class="c1">RefundUuid</span><span>); we would iterate through each of these items and create ThirdPartyFeeRefunds and AppFeeRefunds for each element in </span><span class="c1">record.getRefundAppFees</span><span class="c6">.</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-2 start" start="1"><li class="c10 c18 li-bullet-0"><span class="c1">ThirdPartyFeeRefunds</span><span>&nbsp;are created with the same event handlers that </span><span class="c1">ThirdPartyFees</span><span>&nbsp;use; they check for </span><span class="c1">hasThirdPartyReversalTender</span><span class="c6">, and create a refund if that is present (or debit if it isn&rsquo;t)</span></li><li class="c10 c18 li-bullet-0"><span class="c1">AppFeeRefunds</span><span>&nbsp;are handled by </span><span class="c1">AppFeeRefundEventHandler</span><span>, but this logic is essentially identical to </span><span class="c1">AppFeeEventHandler</span><span class="c6">, so they can be created with the same logic.</span></li><li class="c10 c18 li-bullet-0"><span class="c6">All of that means that we can progress with either Option 1 or Option 2 above for refunds as well; there is no blocker for either.</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-1" start="3"><li class="c8 li-bullet-0"><span>The AppFee refund could potentially be smaller than the original value of the AppFee, but this calculation would be handled </span><span>upstream</span><sup><a href="#cmnt45" id="cmnt_ref45">[as]</a></sup><span class="c6">&nbsp;of us; we would receive a list of partial refunds and refund UUIDs in the PaymentRecord and would create our refunds accordingly with the values provided.</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-0" start="3"><li class="c10 c21 li-bullet-0"><span>Changes in </span><span class="c1">LedgerPaymentFilter</span><span>&nbsp;and </span><span class="c1">PaymentRecordSkipper</span></li></ol><ol class="c7 lst-kix_jl8n8ntmsuem-1 start" start="1"><li class="c8 li-bullet-0"><span>Currently in </span><span class="c1">LedgerPaymentFilter</span><span>&nbsp;and </span><span class="c1">PaymentRecordSkipper</span><span class="c6">, we check to see if a payment received through the Esperanto Feed is a gift card, and we refuse to handle it if so.</span></li><li class="c8 li-bullet-0"><span>We would need to </span><span>remove this check from </span><span class="c1">LedgerPaymentFilter</span><sup><a href="#cmnt46" id="cmnt_ref46">[at]</a></sup><span>, and then add it to the other PaymentRecordProcessors that are in use. This would then instruct the Esperanto Feed handler to receive and process gift card payments and to route them to the appropriate processor.</span></li></ol><h1 class="c29" id="h.94kvazk6zffz"><span>Testing</span><sup><a href="#cmnt47" id="cmnt_ref47">[au]</a></sup></h1><ul class="c7 lst-kix_g4cg48tqbea5-0 start"><li class="c16 c21 li-bullet-0"><span>Beyond the normal unit testing, we should create a full integration test for Gift Cards with App Fees. We would want to test the following </span><span>scenarios</span><sup><a href="#cmnt48" id="cmnt_ref48">[av]</a></sup></li></ul><ul class="c7 lst-kix_g4cg48tqbea5-1 start"><li class="c14 li-bullet-0"><span class="c6">Happy case: a Gift Card PaymentRecord with an App Fee (should create 2 ledger entries, debiting a merchant and crediting a developer)</span></li><li class="c14 li-bullet-0"><span class="c6">Gift Card without an App Fee (should ignore this payment from the Esperanto Feed)</span></li><li class="c14 li-bullet-0"><span class="c6">Happy case: refund a whole gift card payment with an App Fee (should create 2 ledger entries crediting the merchant and debiting the developer the whole amount of the fee)</span></li><li class="c14 li-bullet-0"><span class="c6">Partial refund of a gift card payment with app fee</span></li><li class="c14 li-bullet-0"><span class="c6">Refunding a gift card payment without an App Fee (should ignore this payment)</span></li><li class="c14 li-bullet-0"><span class="c6">Verify that no other payment record processors process gift cards</span></li></ul><ul class="c7 lst-kix_g4cg48tqbea5-0"><li class="c16 c21 li-bullet-0"><span class="c6">Our Ledger integration tests are pretty comprehensive in what moving parts we&rsquo;re able to test (can enqueue a real payment into a local Esperanto Feed, process it into a real MySQL database, validate the actual Ledger entries created), but we&rsquo;d like to test this in a real staging environment as well.</span></li></ul><ul class="c7 lst-kix_g4cg48tqbea5-1 start"><li class="c14 li-bullet-0"><span>We&rsquo;d want to work with the Payments API team to use </span><span class="c19">squareupstaging.com</span><span class="c6">&nbsp;or the developer APIs to buy gift cards in staging and make fake purchases with them.</span></li><li class="c14 li-bullet-0"><span class="c6">We can use our own staging developer accounts to add fees to these payments and ensure that our merchant account is debited appropriately (debited for the fee; not credited for the value of the purchase itself, as that is paid for by a gift card).</span></li><li class="c14 li-bullet-0"><span class="c6">The same procedures can be used to refund these purchases as well.</span></li></ul><h1 class="c29" id="h.aeydgt8xe1qb"><span class="c15">2/10/21 Update to Design</span></h1><ul class="c7 lst-kix_yc7fj7d4ld9p-0 start"><li class="c16 c21 li-bullet-0"><span>This is already out for review (</span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://github.com/squareup/java/pull/202488&amp;sa=D&amp;source=editors&amp;ust=1689357871775251&amp;usg=AOvVaw0OL53nbw1mZnxSs2RQ6v2W">PR here</a></span><span class="c6">), but I wanted to update this doc with the changes that we ended up making to the implementation due to some curveballs inside Ledger that were missed in the initial design.</span></li><li class="c16 c21 li-bullet-0"><span>We decided against using the </span><span class="c1">ThirdPartyFee</span><span class="c6">&nbsp;handlers to create the Ledger events.</span></li></ul><ul class="c7 lst-kix_yc7fj7d4ld9p-1 start"><li class="c14 li-bullet-0"><span>The reason for this is that the current </span><span class="c1">ThirdPartyFeeEventHandler</span><span class="c6">&nbsp;seems unusually tailored for Money Transfers and tenders specifically. During implementation, I found that I was overloading terminology a lot and skirting around the intended usages of the parameters of the event handler.</span></li><li class="c14 li-bullet-0"><span>In addition, it required removing some values of the </span><span class="c1">ThirdPartyFee</span><span>&nbsp;balance event, because there was no </span><span class="c1">PaymentRecord</span><span>&nbsp;created for this transaction (these are created by Capture events only). This would make fees harder to find in Regulator, as they wouldn&rsquo;t be scooped up by </span><span class="c1">PaymentToken</span><span class="c6">.</span></li><li class="c14 li-bullet-0"><span class="c6">While I had a &ldquo;working&rdquo; solution, it was messy enough that future work on these handlers would be confusing and more open to misunderstanding (and therefore opening avenues for bugs).</span></li><li class="c14 li-bullet-0"><span>Discussion on the issues faced can be found </span><span class="c25"><a class="c11" href="https://www.google.com/url?q=https://docs.google.com/document/d/1LLEFHWUNOgASl42ebCzMNfw5HKUjhCn0nMt2dJwXxB8/edit%23heading%3Dh.rreeqw9uaor&amp;sa=D&amp;source=editors&amp;ust=1689357871776348&amp;usg=AOvVaw2cUuC5s0QuM9w3-7HzfI59">here</a></span><span class="c6">.</span></li></ul><ul class="c7 lst-kix_yc7fj7d4ld9p-0"><li class="c16 c21 li-bullet-0"><span class="c6">Now, we are using the normal Capture &amp; Refund handlers to process these Gift Card payments from the Esperanto Feed.</span></li></ul><ul class="c7 lst-kix_yc7fj7d4ld9p-1 start"><li class="c14 li-bullet-0"><span class="c6">This lets us use the normal front door for payments to Ledger from the Esperanto Feed.</span></li><li class="c14 li-bullet-0"><span class="c6">The main changes required to do this were:</span></li></ul><ul class="c7 lst-kix_yc7fj7d4ld9p-2 start"><li class="c16 c18 li-bullet-0"><span>Allow payments from gift cards to enter Capture &amp; Refund handlers; we would then check if the payment was from a gift card in these handlers, and </span><span class="c19">not</span><span class="c6">&nbsp;create a Capture/Refund Ledger Entry if they were.</span></li></ul><ul class="c7 lst-kix_yc7fj7d4ld9p-3 start"><li class="c16 c30 li-bullet-0"><span>Captures: check the instrument type for </span><span class="c1 c32">SQUARE_GIFT_CARD_V2</span></li><li class="c16 c30 li-bullet-0"><span>Refunds: added new boolean field </span><span class="c1">from_gift_card</span><span class="c6">&nbsp;to the event proto</span></li></ul><ul class="c7 lst-kix_yc7fj7d4ld9p-2"><li class="c16 c18 li-bullet-0"><span class="c6">Repeat the above for the corresponding AccountingEvent handlers</span></li><li class="c16 c18 li-bullet-0"><span>Create a </span><span class="c1">PaymentRecord</span><span>&nbsp;as a side effect of the </span><span class="c1">CaptureEventHandler</span><span class="c6">, even if there was no Capture ledger entry being created</span></li></ul><ul class="c7 lst-kix_yc7fj7d4ld9p-1"><li class="c14 li-bullet-0"><span>This means that if we process a gift card Capture with no AppFee, then there should be no Ledger Entries created from the </span><span class="c1">CaptureEventHandler</span><span>. If it had an AppFee, the only Ledger Entry created would be a ThirdPartyFee entry (while enqueueing a corresponding AppFee event to credit the app merchant.</span></li></ul><h1 class="c29" id="h.cya6r0wchl83"><span class="c15">Open Questions</span></h1><ul class="c7 lst-kix_ejyfk2odw310-0 start"><li class="c16 c21 li-bullet-0"><span class="c6">How do we handle issues of risk &amp; fraud between a Square Merchant with insufficient balance or invalid accounts?</span></li></ul><ul class="c7 lst-kix_ejyfk2odw310-1 start"><li class="c14 li-bullet-0"><span class="c6">In Steve&rsquo;s example in the reviewer rubric at the top of this doc, he mentions a case where an App Merchant could charge an app fee to a Square Merchant with a gift card, even if the Square Merchant&rsquo;s bank account is closed.</span></li><li class="c14 li-bullet-0"><span>For example, Merchant A sells a gift card for $100; they settle out that gift card and receive the money and closes their bank account. Someone then uses that gift card to make a purchase that has a $100 app fee that goes to Merchant B; Merchant B would receive the $100, but we&rsquo;d be unable to deduct $100 from Merchant A with an invalid account.</span><sup><a href="#cmnt49" id="cmnt_ref49">[aw]</a></sup></li></ul><h1 class="c29" id="h.l8sqkodruqcw"><span class="c15">Tickets &amp; Timeline</span></h1><p class="c16"><span>[</span><span class="c38"><a class="c11" href="mailto:kcrane@squareup.com">Kevin Crane</a></span><span>&nbsp;</span><span class="c23">to complete after after design review</span><span class="c6">]</span></p><p class="c16"><span class="c23">[pre-review summary:</span><span class="c6">&nbsp;probably 2 sprints of work at the most; general steps are:</span></p><ul class="c7 lst-kix_md3t8hu2rufw-0 start"><li class="c16 c21 li-bullet-0"><span>Implement </span><span class="c1">GiftCardAppFeePaymentRecordProcessor</span></li><li class="c16 c21 li-bullet-0"><span>Implement </span><span class="c1">GiftCardAppFeeRefundPaymentRecordProcessor</span></li><li class="c16 c21 li-bullet-0"><span>Adjust the </span><span class="c1">shouldProcess</span><span>&nbsp;method in the other </span><span class="c1">PaymentRecordProcessors</span><span>&nbsp;to skip gift card payments (and remove the isGiftCard check in </span><span class="c1">LedgerPaymentFilter</span><span class="c6">)</span></li><li class="c16 c21 li-bullet-0"><span class="c6">Make integration tests</span></li><li class="c16 c21 li-bullet-0"><span class="c6">Perform validation on squareupstaging.com</span></li></ul><p class="c16"><span>Each of the above will be turned into 1 Jira ticket each after design review]</span></p><div class="c3"><p class="c0"><a href="#cmnt_ref1" id="cmnt1">[a]</a><span class="c6">@heisel@squareup.com who are the right folks to tag here for review? Should it be the same list of reviewers as this doc? https://docs.google.com/document/d/1aizpc3kP5jCGqnimWscniqoaEISxkXUExE_yQHU7Ik0/edit?ts=5f05334d#</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref2" id="cmnt2">[b]</a><span class="c6">This would probably be primarily ActEng-focused (since it&#39;s mostly regarding the Ledger-specific changes), but definitely wouldn&#39;t hurt to have someone outside our team just verify I&#39;m not missing anything feature-wise.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref3" id="cmnt3">[c]</a><span class="c6">Sounds good thanks Kevin! Just shared with a few key stakeholders so they know whats coming</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref4" id="cmnt4">[d]</a><span class="c6">@tmahoney@squareup.com @aedwards@squareup.com here is the Ledger design doc, feel free to review.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref5" id="cmnt5">[e]</a><span class="c6">@tmahoney@squareup.com @aedwards@squareup.com Let us know if you have any&nbsp;questions/comments. We&#39;re going to start implementing this design soon so would be good to confirm this meets your requirements.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref6" id="cmnt6">[f]</a><span class="c6">@heisel@squareup.com and @nrabie@squareup.com we&#39;re going to start dev work on this soon. I&#39;ve tagged @tmahoney@squareup.com and @aedwards@squareup.com but let me know if any other folks on your team should review. Thanks!</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref7" id="cmnt7">[g]</a><span class="c6">Thanks Heather, you&#39;ve got the right people on our side. Syncing with the team on Monday, we&#39;ll be starting development soon also, I&#39;ll keep you posted.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref8" id="cmnt8">[h]</a><span class="c6">Thanks Noor!</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref9" id="cmnt9">[i]</a><span class="c6">Let a note about potential loss. I don&#39;t think this should hold things up now (unless risk or someone else has strong opinions). We can monitor and make updates later if there are issues.</span></p><p class="c0 c4"><span class="c6"></span></p><p class="c0"><span class="c6">I don&#39;t really have an opinion on option 1 vs. 2 - glad to see this level of debate in a design doc! So much faster to have those conversations here rather than in a PR. Well done!</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref10" id="cmnt10">[j]</a><span class="c6">I&#39;ll loop risk in as an FYI.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref11" id="cmnt11">[k]</a><span class="c6">@rpeterson@squareup.com FYI, we can chat about this during our 1:1 tomorrow!</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref12" id="cmnt12">[l]</a><span class="c6">Added an &quot;Open Questions&quot; section below that mentions this. I think it&#39;s probably outside the scope of Ledger to know about this, but I definitely agree that this is something that should be on the radar of Risk, or whoever has a better idea of how it should be handled.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref13" id="cmnt13">[m]</a><span class="c6">Thanks @kcrane@squareup.com! @hsilverio@squareup.com and I discussed this yesterday. We are evaluating the risk implications of this and will get back to you. Agree that it shouldn&#39;t hold up the first draft.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref14" id="cmnt14">[n]</a><span class="c6">Sweet, sounds good. Thanks Rachel!</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref15" id="cmnt15">[o]</a><span class="c6">@rpeterson@squareup.com just FYI the Giftcard w/ App Fee work is now live. We just want to ensure Risk is aware of the fraud risk outlined here. @bradleyc@squareup.com @imcallister@squareup.com&nbsp;</span></p><p class="c0"><span class="c6">the impact of any fraud like this might hit the ECOM P&amp;L as well so looping you in as an FYI.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref16" id="cmnt16">[p]</a><span class="c6">cc @faheem@squareup.com</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref17" id="cmnt17">[q]</a><span class="c6">This should be called out in the PRD.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref18" id="cmnt18">[r]</a><span class="c6">Is the desired behavior to just record a negative entry on the Seller&#39;s balance?&nbsp;</span></p><p class="c0 c4"><span class="c6"></span></p><p class="c0"><span class="c6">Do we need to actively clear the funds before releasing the money to the application developer?</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref19" id="cmnt19">[s]</a><span class="c6">does this mean that a new capture ledger entry is created?&nbsp; Is that a problem?</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref20" id="cmnt20">[t]</a><span class="c6">I&#39;m going to go with Option 2, so not an issue anymore. This method would work, but would require relaxing constraints to allow $0 captures, which wasn&#39;t ideal.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref21" id="cmnt21">[u]</a><span class="c6">this sentence says &quot;either&quot; but then doesn&#39;t give two options.&nbsp; Is there a missing &quot;or&quot; somewhere?</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref22" id="cmnt22">[v]</a><span class="c6">Good catch. The &quot;either&quot; was referring to Option 2, but grammatically that was a mess and wasn&#39;t obvious at all. Just re-formatted this paragraph to be more apparent.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref23" id="cmnt23">[w]</a><span class="c6">Is Capture a requirement? Meaning is it gift card transaction and capture? (More curious than anything since I&#39;m not sure what Gift Card transaction without a capture would be?)</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref24" id="cmnt24">[x]</a><span class="c6">It could be a gift card refund, in which case it&#39;d go through&nbsp;GiftCardAppFeeRefundPaymentRecordProcessor instead.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref25" id="cmnt25">[y]</a><span class="c6">Do giftcard refunds come in as separate payments?&nbsp; I would assume a giftcard refund would be present on the original payment record so you&#39;d have a giftcard and capture AND refund present in the proto.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref26" id="cmnt26">[z]</a><span class="c6">I believe it should be &quot;if giftcard AND app_fee then process the capture (if it exists) and any refunds (if they exists)&quot;</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref27" id="cmnt27">[aa]</a><span class="c6">This section was meant to be just for the Captures, but the class name was getting incredibly unwieldy.</span></p><p class="c0"><span class="c6">It could more accurately be called &quot;GiftCardAppFeeCapturePaymentRecordProcessor&quot;.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref28" id="cmnt28">[ab]</a><span class="c6">What&#39;s the specific logic here?&nbsp; Eg, IF isGiftCard and hasCaptureIntent and !hasAppFee then ignore.&nbsp; &nbsp;Is there ever a case where ignoring all gift cards without app fees will ignore some that need processing?</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref29" id="cmnt29">[ac]</a><span class="c6">In the current landscape of gift cards, I don&#39;t believe so. Right now, Ledger intentionally ignores all payment records that are Gift Cards because there is no money actually changing hands (as it was already paid for in advance).</span></p><p class="c0 c4"><span class="c6"></span></p><p class="c0"><span class="c6">We&#39;d actually be carving out an exception in this case, saying &quot;actually if this gift card transaction has an AppFee, then we *would* be moving money, from the Square Merchant to the App Merchant&quot;.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref30" id="cmnt30">[ad]</a><span class="c6">@kcrane@squareup.com is there a doc that walks through the existing process here?</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref31" id="cmnt31">[ae]</a><span class="c6">There is, but it&#39;s kind of a slog because it was part of a giant rewrite we did of the Esperanto Payment Record Processor.</span></p><p class="c0 c4"><span class="c6"></span></p><p class="c0"><span class="c6">Look at this doc, in the sections titled &quot;Short Design Summary&quot; and</span></p><p class="c0"><span class="c6">&quot;PaymentRecordProcessor&quot; for a summary of the logic here.</span></p><p class="c0"><span class="c6">https://docs.google.com/document/d/1VqkcqgvrEfmc42jxyiHR_yqkx2j1n2uYX7qOVOz7z98/edit#heading=h.cf8903ly0x3l</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref32" id="cmnt32">[af]</a><span class="c6">I&#39;d be happy to walk you through it offline also if that&#39;s helpful.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref33" id="cmnt33">[ag]</a><span class="c6">We shouldn&#39;t create $0 ledger entries.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref34" id="cmnt34">[ah]</a><span class="c6">+1</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref35" id="cmnt35">[ai]</a><span class="c6">I strongly do not want to relax this invariant.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref36" id="cmnt36">[aj]</a><span class="c6">+1</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref37" id="cmnt37">[ak]</a><span class="c6">you shouldn&#39;t be directly creating ledger entries, you need to create a BCE and enqueue that.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref38" id="cmnt38">[al]</a><span class="c6">I think this should be a single &quot;event&quot;.&nbsp; There may be 2 ledger entries that are the 2 sides of the transaction, but they are all part of one event.&nbsp; You wouldn&#39;t want to have one of them by itself, and you want them to have the same external source, which means that it needs to be all one event.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref39" id="cmnt39">[am]</a><span class="c6">I&#39;m not as familiar with the class structure, but I have to imagine there are patterns to address this (preferably&nbsp;not via inheritance).</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref40" id="cmnt40">[an]</a><span class="c6">Yeah I should be able manage it pretty easily. Refactors are very doable with java IntelliJ.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref41" id="cmnt41">[ao]</a><span class="c6">So far, I like Option 2 as well if there&#39;s an elegant way to avoid duplicating&nbsp;the code to create 3rd party fees and app fees.&nbsp; looking forward to comments from Ben, Dan, Elliot, Mike, Ming.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref42" id="cmnt42">[ap]</a><span class="c6">Agree.&nbsp; Prefer Option 2.&nbsp; I&#39;m confident we can figure out the deduplication.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref43" id="cmnt43">[aq]</a><span class="c6">Sweet, I agree with that.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref44" id="cmnt44">[ar]</a><span class="c6">Also +1 to Option 2</span></p><p class="c0"><span class="c6">It is also shallower in the inheritance tree.</span></p><p class="c0"><span class="c6">i.e. `CapturePaymentRecordProcessor` implements `PaymentRecordProcessor`</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref45" id="cmnt45">[as]</a><span class="c6">Do we know what team would handle this? Might be good to share this with them as an FYI</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref46" id="cmnt46">[at]</a><span class="c6">what about gift card payments that don&#39;t have an app fee?&nbsp; do they still get filtered out?&nbsp; Is that filter part of the logic that writes a record to a table saying we aren&#39;t going to process it?&nbsp; Do we still need to do that for the non-app fee ones?&nbsp; What downstream processing is going to expect things if it isn&#39;t filtered?&nbsp; Are we going to be waiting forever for risk events, for example?</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref47" id="cmnt47">[au]</a><span class="c6">@heisel@squareup.com @nrabie@squareup.com FYI re: users states and testing w/ the Payments API team</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref48" id="cmnt48">[av]</a><span class="c6">Can these changes account for the case scenario:</span></p><p class="c0"><span class="c6">- customer wants to buy $10 of product, but only has $5 remaining in their gift card</span></p><p class="c0"><span class="c6">- $5 is charged to the gift card, $5 is charged to their CC</span></p><p class="c0 c4"><span class="c6"></span></p><p class="c0"><span class="c6">Would this be split into two payment records? One that is Gift-card only, and one that is CC only? I&#39;m assuming they will be charging a proportional&nbsp;amount of app fees for the two payment records.</span></p></div><div class="c3"><p class="c0"><a href="#cmnt_ref49" id="cmnt49">[aw]</a><span class="c6">kind-of an extreme case.&nbsp; The app fee is usually a small percentage.&nbsp; Maybe Square just eats the loss in this case?&nbsp; But, this is a product question.</span></p></div></body></html>
