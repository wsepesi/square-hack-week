<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ul.lst-kix_ljmomshjnp4q-3{list-style-type:none}.lst-kix_qn6m6zk460-4>li:before{content:"\0025cb   "}ul.lst-kix_ljmomshjnp4q-2{list-style-type:none}ul.lst-kix_ljmomshjnp4q-5{list-style-type:none}.lst-kix_qn6m6zk460-3>li:before{content:"\0025cf   "}.lst-kix_qn6m6zk460-5>li:before{content:"\0025a0   "}ul.lst-kix_ljmomshjnp4q-4{list-style-type:none}ul.lst-kix_ljmomshjnp4q-7{list-style-type:none}.lst-kix_qn6m6zk460-2>li:before{content:"\0025a0   "}.lst-kix_qn6m6zk460-6>li:before{content:"\0025cf   "}ul.lst-kix_ljmomshjnp4q-6{list-style-type:none}ul.lst-kix_ljmomshjnp4q-8{list-style-type:none}.lst-kix_qn6m6zk460-0>li:before{content:"\0025cf   "}.lst-kix_qn6m6zk460-8>li:before{content:"\0025a0   "}.lst-kix_qn6m6zk460-1>li:before{content:"\0025cb   "}.lst-kix_qn6m6zk460-7>li:before{content:"\0025cb   "}ul.lst-kix_ljmomshjnp4q-1{list-style-type:none}ul.lst-kix_ljmomshjnp4q-0{list-style-type:none}ul.lst-kix_qn6m6zk460-7{list-style-type:none}ul.lst-kix_qn6m6zk460-6{list-style-type:none}ul.lst-kix_qn6m6zk460-8{list-style-type:none}.lst-kix_ljmomshjnp4q-8>li:before{content:"\0025a0   "}ul.lst-kix_qn6m6zk460-1{list-style-type:none}ul.lst-kix_qn6m6zk460-0{list-style-type:none}.lst-kix_ljmomshjnp4q-7>li:before{content:"\0025cb   "}ul.lst-kix_qn6m6zk460-3{list-style-type:none}ul.lst-kix_qn6m6zk460-2{list-style-type:none}ul.lst-kix_qn6m6zk460-5{list-style-type:none}ul.lst-kix_qn6m6zk460-4{list-style-type:none}.lst-kix_ljmomshjnp4q-5>li:before{content:"\0025a0   "}.lst-kix_ljmomshjnp4q-4>li:before{content:"\0025cb   "}.lst-kix_ljmomshjnp4q-6>li:before{content:"\0025cf   "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_ljmomshjnp4q-1>li:before{content:"\0025cb   "}.lst-kix_ljmomshjnp4q-0>li:before{content:"\0025cf   "}.lst-kix_ljmomshjnp4q-2>li:before{content:"\0025a0   "}.lst-kix_ljmomshjnp4q-3>li:before{content:"\0025cf   "}ol{margin:0;padding:0}table td,table th{padding:0}.c1{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c7{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c15{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:26pt;font-family:"Arial";font-style:normal}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left;height:11pt}.c2{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c13{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c17{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c8{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c5{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c19{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c4{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c3{background-color:#ffffff;max-width:720pt;padding:36pt 36pt 36pt 36pt}.c16{color:inherit;text-decoration:inherit}.c10{margin-left:36pt;padding-left:0pt}.c14{margin-left:72pt;padding-left:0pt}.c6{border:1px solid black;margin:5px}.c9{padding:0;margin:0}.c12{height:11pt}.c18{font-size:10pt}.c11{font-style:italic}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c3 doc-content"><p class="c17 title" id="h.1nrqczdq9rs5"><span class="c15">High Level Design for Seller Account Reads</span></p><p class="c5"><span class="c19"><a class="c16" href="https://www.google.com/url?q=https://docs.google.com/document/d/1Djs5xJsOUmTQ2k0NUx7xtlUgLfQUzvX8lcnRAgmKtJk/edit?usp%3Dsharing&amp;sa=D&amp;source=editors&amp;ust=1689358942893196&amp;usg=AOvVaw1cKJ8KJG4wraDj_t3rsNwU">MVP Read API</a></span></p><p class="c5"><span>This doc is a high level look at the basic areas to address to be able to implement the above API on top of a Financial Account API.</span></p><h1 class="c8" id="h.2q8rdye5m3b2"><span class="c1">Mapping Existing Books to Financial Account</span></h1><p class="c5"><span class="c19"><a class="c16" href="https://www.google.com/url?q=https://docs.google.com/spreadsheets/d/1JfsxIMQU5XI-6eCQ9dhyw2LJzOa2rN2GHpLd-MjyFFM/edit?usp%3Dsharing&amp;sa=D&amp;source=editors&amp;ust=1689358942894108&amp;usg=AOvVaw0VsY5vdkTvLs_IDA0x7Fa5">Books that are Used in the Code</a></span></p><h2 class="c7" id="h.1q3xm4psdlv1"><span>Phase 1: Use what you&rsquo;ve got</span><sup><a href="#cmnt1" id="cmnt_ref1">[a]</a></sup><sup><a href="#cmnt2" id="cmnt_ref2">[b]</a></sup></h2><p class="c5"><span>Currently the ledger books don&rsquo;t have a posted balance book. &nbsp;Fortunately, there aren&rsquo;t any real 2 phase money out operations in use (IssuedCard/cardr and Deposits are defined but not really used) and that&#39;s the only case where posted and current are different, so we can pretend the same book (</span><span>MERCHANT_PAYABLE</span><sup><a href="#cmnt3" id="cmnt_ref3">[c]</a></sup><span class="c2">) is both the current and the posted book for reads. &nbsp;We will have to resolve that before doing writes through the financial account.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">We also currently make a whole bunch of different books for different operations, but none of these are actually exposed and don&rsquo;t really matter. &nbsp;They don&rsquo;t have to be separate books. &nbsp;We can mostly ignore them.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">The way we handle esperanto captures right now is basically a 2-phase money in pattern. &nbsp;The money is put into PAYMENT_PENDING_RISK until risk clears it and then it moves to MERCHANT_PAYABLE. &nbsp;The latter is our posted/current balance book. &nbsp;This means PAYMENT_PENDING_RISK is basically our pending balance book. &nbsp;In the future we might change this interaction pattern to be 1-phase, but that would involve keeping the capture in payment processing land only until it clears risk. &nbsp;Right now, it comes to the account while still pending, so we might as well expose it that way. &nbsp;There&rsquo;s also potentially a PAY_IN_PENDING book which is also the &ldquo;pending balance&rdquo;, but it is rarely if ever in use. &nbsp;So, for now we&rsquo;ll ignore it.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span>The seller also has potentially multiple different accounts in the books system. &nbsp;These other accounts are both simple, 1-phase only accounts that don&rsquo;t have a pending or held balance. &nbsp;RISK_RESERVE_PAYABLE is the posted/current balance book for the bonded account that we maintain for the risk reserves product. &nbsp;The CostPlus product also has a side account where it accumulates the net adjustment to fees during the month and then dumps the total into the main account once a month. &nbsp;Unfortunately, debits and credits for this are put in two separate books currently and aren&rsquo;t netted out until they are dumped into MERCHANT_PAYABLE, the two </span><span>cost+</span><sup><a href="#cmnt4" id="cmnt_ref4">[d]</a></sup><span>&nbsp;books are FEE_PAYABLE and </span><span class="c18">FEE_RECEIVABLE. &nbsp;Together these make up the pending/current balance for the cost plus account. &nbsp;Until they are combined, trying to expose the account is mostly pointless, but FEE_PAYABLE could be on-boarded as the one book when a merchant is onboarded, but it won&rsquo;t be worth much until the two books are combined.</span></p><h2 class="c7" id="h.n8ulehfmg2m2"><span>Phase 2: Combine some </span><span>books</span><sup><a href="#cmnt5" id="cmnt_ref5">[e]</a></sup><sup><a href="#cmnt6" id="cmnt_ref6">[f]</a></sup></h2><p class="c5"><span class="c2">In general we can combine books by changing the journal entries to just use one of the books and then doing a migration that moves the balance of the other book into the one it is combining into. &nbsp;This doesn&rsquo;t preserve the merged history, but that&rsquo;s too big of an ask for this.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span>FEE_RECEIVABLE should be combined into FEE_PAYABLE</span><sup><a href="#cmnt7" id="cmnt_ref7">[g]</a></sup><sup><a href="#cmnt8" id="cmnt_ref8">[h]</a></sup><sup><a href="#cmnt9" id="cmnt_ref9">[i]</a></sup><span class="c2">. &nbsp;Then the cost plus account will make sense. &nbsp;This does mean that FEE_PAYABLE could be positive or negative. &nbsp;In the migration, we&rsquo;ll have to switch writes over but still read both when flushing to MERCHANT_PAYABLE. &nbsp;Once the backfill is complete, the reader code can be cleaned up as well. &nbsp;Also, we might not need a backfill cuz we can just wait a month or so for the flush to MERCHANT_PAYABLE to happen. &nbsp;That will empty out both books and then going forward only the one will be used. &nbsp;Still we will need to do some verification that no money is stranded.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span>PAY_IN_PENDING should be merged into </span><span>PAYMENT_PENDING_RISK</span><sup><a href="#cmnt10" id="cmnt_ref10">[j]</a></sup><sup><a href="#cmnt11" id="cmnt_ref11">[k]</a></sup><span>, and that book could be renamed to drop the &ldquo;_RISK&rdquo; part, but that probably isn&rsquo;t worth it. &nbsp;We can just add a note that PayIns will use that book also. &nbsp;There&rsquo;s some possible risk here that pay-ins, which currently</span><span>&nbsp;lock the whole book </span><sup><a href="#cmnt12" id="cmnt_ref12">[l]</a></sup><sup><a href="#cmnt13" id="cmnt_ref13">[m]</a></sup><span class="c2">will start causing contention with payments, being on the same book, but the PayIns feature is mostly dormant at this point. &nbsp;Once we are writing through the FinAcct api it won&rsquo;t be a risk anymore. &nbsp;The migration here might look a little different because the code has to read the pending balance from the book and lock on it. &nbsp;This will require some careful code to ensure nothing is lost, or maybe we get lucky and verify that it actually isn&rsquo;t in use and all balances are zero. &nbsp;Then we can just switch the code over in one go.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">There are many, many other books that are currently journaled to but not exposed in the code which are simply the &ldquo;other side&rdquo; of double entry accounting. &nbsp;These can all be combined into one or two books to match the book schema of Financial Accounts. &nbsp;This doesn&rsquo;t even require balance migration. &nbsp;We can just make the new books and change the journal entries to use them. &nbsp;This isn&rsquo;t needed for the read API at all, but will be needed for the write API.</span></p><h2 class="c7" id="h.9xne6b271s7g"><span>Phase 3: Fork the Posted balance book</span><sup><a href="#cmnt14" id="cmnt_ref14">[n]</a></sup><sup><a href="#cmnt15" id="cmnt_ref15">[o]</a></sup></h2><p class="c5"><span>All of our seller accounts need to have a real posted balance book that is separate from the current balance book before we can switch to using FinAcct&rsquo;s API to do writes. &nbsp;To do this, we want to make a new book that shares a history with another book. &nbsp;Essentially it branches off from it at some point. &nbsp;</span><span>This ability to fork a book will need to be added to the Books API. &nbsp;The new book will need to have an initial book entry record that points to the book entry it is forked from in the other book, and book entry read apis will have to be updated to seamlessly read the history of both books.</span><sup><a href="#cmnt16" id="cmnt_ref16">[p]</a></sup><sup><a href="#cmnt17" id="cmnt_ref17">[q]</a></sup></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">Then we will need to use this feature to migrate our journal entries to separately writing to the posted and current books. &nbsp;Further design TBD, but we can probably add the new posted book definition to the journal entries with some condition that causes that book to be skipped if it doesn&rsquo;t exist and then run a migration that forks the 3 payable books to create separate posted balance books for each of the accounts. &nbsp;Or, potentially, the risk reserve and cost plus books don&rsquo;t need to be forked if the FinAcct write APIs are able to treat a single current balance book as both balances at once and allow that writes can happen, it just means that no 2-phase operations can happen.</span></p><h1 class="c8" id="h.8uvc74vurazy"><span class="c1">Mapping Existing Data</span></h1><p class="c5"><span class="c2">The Financial Account API specifies that a Transaction Event has metadata and a client event type and a Transaction which can have a client_transaction_token. &nbsp;Plus there&rsquo;s the event type and the transaction version and possibly other data which the FinAcct will denormalize into the metadata of the journal entry for retrieval when viewing the balance history. &nbsp;No doubt there will be some expected metadata keys that hold this info.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">To be compatible with legacy book entries on the seller side, the FinAcct will have to be flexible in how it reads the data. &nbsp;All indexed and unindexed metadata should be returned as metadata and if there is no client_event_type metadata, then the journal entry type should be used. &nbsp;Inferring the event type would require having logic on the book types and journal entry type involved and probably the FinAcct code doesn&rsquo;t want to own that, so those parts of the data should just be left empty. (The FinAcct API needs to be ok with those being empty when reading attached transaction event data from a Balance Change. &nbsp;Maybe the API should slim down what is expected in all cases here.) &nbsp;The seller account API will fill in the gaps if needed. &nbsp;Most likely it just wouldn&rsquo;t expose the things like event type anyhow, but it would have some logic to optionally pull out a proper client_transaction_token from the given metadata.</span></p><h1 class="c8" id="h.8uvc74vurazy-1"><span class="c1">Onboarding Sellers</span></h1><p class="c5"><span class="c2">The new seller account read api will include a method to look up financial accounts by merchant_token and account type. &nbsp;If that financial account has not yet been set up in our mapping, then it will be created on the fly. &nbsp;We can do this per type of account. &nbsp;So, if nobody is looking at cost plus accounts, we don&rsquo;t have to set them up yet.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">Just in time account creation will basically require us to read the needed book types to get the book ids for the merchant and then create a financial account with those pre-existing book-ids. &nbsp;This will be an incomplete Financial Account in that it doesn&rsquo;t have all the books the normal FinAcct API would create. &nbsp;So, we will need special create and update account APIs that allow us to make an account with only a few books filled in and then specify additional books later -- besides the normal create financial account behavior will be to make new books, but we are supplying existiing books. &nbsp;Once we have made this partial financial account, we can entry the new financial account id into our mapping and continue on our way.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span>The other wrinkle that will have to be handled is the abomination of &ldquo;square perspective books&rdquo; in use for the ledger books. &nbsp;The whole rest of the interface and system wants to use these accounts in &ldquo;seller perspective&rdquo;, but we have them all negated so that moving $5 to the MERCHANT_PAYABLE book actually </span><span class="c11">reduces</span><span class="c2">&nbsp;the seller&rsquo;s balance by $5! &nbsp;This confusion is horrible and causes bugs. &nbsp;We need to wrap this away in the bowels of the financial account and save all other code from it. &nbsp;Hence, we need an option on a financial account to specify which &ldquo;perspective&rdquo; the books are in. &nbsp;If needed, the financial account should invert all operations on the way in, and negate all amounts on the way out to hide the fact that the books are in square perspective and keep its interface always in seller perspective. &nbsp;When we migrate books into a financial account we will declare them to be square perspective. &nbsp;Eventually, when we are making new financial accounts for new sellers, we will let it create seller perspective books, but the existing sellers will have square perspective books unless we do a special migration to re-write the books to seller perspective.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">At first we&rsquo;ll do just the on demand mapping so that we can test the adaptation out with a few hand-chosen accounts. &nbsp;Then, when we have tested sufficiently, we can run a backfill job to do the account creation and mapping for all merchants.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">At some point we will also want to switch ledger code from reading books directly to reading the financial account where possible, but this can come separately and possibly much later. &nbsp;For now, it will be just the API that reads via the financial account interface. &nbsp;From that point of view, we do not have to rush to backfill all merchants.</span></p><h1 class="c8" id="h.7ly3fwx6krv0"><span class="c1">Next Steps: the Write API</span></h1><p class="c5"><span class="c2">After we have a read API working, the next step will be setting up a write API. &nbsp;I&rsquo;ve alluded already to a few things that will need to happen before this. &nbsp;Basically, we have to transform the book usage to match the books schema of Financial Accounts. &nbsp;(And update our journal entries to use them consistent with how FinAcct does.) &nbsp;Then, along with updating our Financial Account records to have all the proper book ids we basically can change our code to call FinAcct write APIs instead of journaling to books directly. &nbsp;Of course the read code will have to be prepared for getting properly parsed meta data and client event types and transaction tokens from FinAcct, and know that it doesn&rsquo;t need to do any mapping or adaptation.</span></p><p class="c0"><span class="c2"></span></p><p class="c5"><span class="c2">Do note that when we come to this part, in order to move money between accounts cleanly and transactionally like we do today, we would want to have a transfer operation in the FinAcct API that does a 1-phase money out on one account and money in on another.</span></p><h1 class="c8" id="h.3mlclu3c99fw"><span class="c1">Summary: Assumptions on Books and Financial Accounts</span></h1><h2 class="c7" id="h.68dor9fgwoep"><span class="c13">Books</span></h2><ul class="c9 lst-kix_qn6m6zk460-0 start"><li class="c5 c10 li-bullet-0"><span class="c2">Need a &ldquo;fork book&rdquo; functionality. &nbsp;Includes model changes, operation to do it, and changes to read operations to work with the new model.</span></li></ul><h2 class="c7" id="h.xqzjeixdiis8"><span class="c13">Financial Account</span></h2><ul class="c9 lst-kix_ljmomshjnp4q-0 start"><li class="c5 c10 li-bullet-0"><span class="c2">Need to be able to serve the BalanceChange history read entirely from books and not require data to exist in Dynamo.</span></li></ul><ul class="c9 lst-kix_ljmomshjnp4q-1 start"><li class="c5 c14 li-bullet-0"><span class="c2">Due to this and not wanting to put too much metadata in books, might need to consider slimming down what the interface promises to return on a Balance Change read.</span></li></ul><ul class="c9 lst-kix_ljmomshjnp4q-0"><li class="c5 c10 li-bullet-0"><span class="c2">Need to recognize its own journal entry types and have generic logic for working with other, unknown journal entry types.</span></li></ul><ul class="c9 lst-kix_ljmomshjnp4q-1 start"><li class="c5 c14 li-bullet-0"><span class="c2">Map journal entry type to client_event_type</span></li><li class="c5 c14 li-bullet-0"><span class="c2">Map journal entry id to transaction_event_id</span></li></ul><ul class="c9 lst-kix_ljmomshjnp4q-0"><li class="c5 c10 li-bullet-0"><span class="c2">Need privileged, low-level account create and update RPCs.</span></li><li class="c5 c10 li-bullet-0"><span class="c2">Need option to switch from Square perspective to Seller perspective</span></li><li class="c5 c10 li-bullet-0"><span class="c2">Allow reading of books without having all book ids populated in the account.</span></li><li class="c5 c10 li-bullet-0"><span class="c2">Allow an alternate book schema that supports 1-phase operations only.</span></li><li class="c5 c10 li-bullet-0"><span class="c2">1-phase Transfer operation.</span></li></ul><p class="c0"><span class="c2"></span></p><div class="c6"><p class="c4"><a href="#cmnt_ref1" id="cmnt1">[a]</a><span class="c2">Can you add a summary of the section, it sounds like what you&#39;re saying is, by and large, we have books we can expose a &quot;accounts&quot; since we don&#39;t need pending on them (for now).&nbsp; With the exception of costplus which needs to be combined first.</span></p><p class="c4 c12"><span class="c2"></span></p><p class="c4"><span class="c2">Is that correct?</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref2" id="cmnt2">[b]</a><span class="c2">yeah, I think so.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref3" id="cmnt3">[c]</a><span class="c2">this is the new source of truth for balance at a point in time that will be used to figure out how much to transfer in the new world, yes?</span></p><p class="c4 c12"><span class="c2"></span></p><p class="c4"><span class="c2">what&#39;s the plan to check/resolve discrepancies with the actual ledger amount transferred? there&#39;s a small discrepancy in ledger today where the balance at the cut off (for example 5pm) is not actually the same amount that gets transferred at real settlement time (8pm)</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref4" id="cmnt4">[d]</a><span class="c2">There are future dated cost+ entries, so there might need to be some fee pending book or something as well?</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref5" id="cmnt5">[e]</a><span class="c2">really this is &quot;combining some journal entries&quot;, right?</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref6" id="cmnt6">[f]</a><span class="c2">or &quot;combine the use of some books&quot;?&nbsp; It&#39;s, rather than use two different books in two different scenarios (journal entries), use the same book in both scenarios.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref7" id="cmnt7">[g]</a><span class="c2">Alternate approach: make a 3rd book and sweep both into it so that it&#39;s clear where the history stops, otherwise, going back in the FEE_PAYABLE will stop making sense with the other account.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref8" id="cmnt8">[h]</a><span class="c2">I&#39;m wondering what general purpose tools we can build to make this less painful (and error prone).&nbsp; This seems like a it will be a common use-case for onboarding folks into fin-act.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref9" id="cmnt9">[i]</a><span class="c2">I think there may be a need to build a backfiller tool equivalent in books.&nbsp; I could fake it out by backfilling across all merchant records, but that would be ugly, what I really want to do is &quot;for all instances of X book type, do operation Y&quot;</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref10" id="cmnt10">[j]</a><span class="c2">Technically I believe this is exposed in our BalanceSummary endpoint that was created for marketplaces.&nbsp; We should see if anyone is calling it and decommission&nbsp;it if not (it never GA&#39;ed)</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref11" id="cmnt11">[k]</a><span class="c2">Payment pending risk is exposed or Pay-in-pending?&nbsp; I do have payment pending risk noted as exposed, and that&#39;s ok.&nbsp; We&#39;ll keep using it.&nbsp; Oh, or is your point that we may be slightly increasing the scope of what this book means and so prior clients aren&#39;t getting what they expect anymore so we should just kill off that prior client?&nbsp; I guess I agree with killing off dead code either way.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref12" id="cmnt12">[l]</a><span class="c2">Umm... I think&nbsp;it would only impact payins.&nbsp; It doesn&#39;t &quot;lock the whole book&quot; it just uses CaS which would only impact itself.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref13" id="cmnt13">[m]</a><span class="c2">check-and-set is what I mean by &quot;lock the&nbsp;whole book&quot; and if we changed the pay-ins code to use the same book as payment pending risk, then that check and set would mingle with the capture processing code.&nbsp; oh, although I guess it wouldn&#39;t block the capture processing code, just the pay-ins code.&nbsp; That&#39;s true, so less of a risk -- though you could end up pretty blocked for pay-ins.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref14" id="cmnt14">[n]</a><span class="c2">What is we just didn&#39;t support&nbsp;reading the &quot;current&quot; balance on the account beyond 90 days only exposed the &quot;posted&quot; balance beyond that?</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref15" id="cmnt15">[o]</a><span class="c2">Yeah, that&#39;s the most likely alternative if adding a &quot;fork&quot; behavior in books is too hard or not worth it.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref16" id="cmnt16">[p]</a><span class="c2">Could you add some details on what it means to fork a book? One question: After forking, when reading a journal entry made prior to forking, are two book entries (one for the original book, one for the new book) returned for each original book entry for that book? Or only show the original book entry? If the former, that breaks the double&nbsp;entry accounting rule that total from amounts - total to amounts = 0. If the latter, then you&#39;d have book entries pointing&nbsp;to journal entries which, when you read, don&#39;t appear to contain that book entry.</span></p></div><div class="c6"><p class="c4"><a href="#cmnt_ref17" id="cmnt17">[q]</a><span class="c2">yeah, this will certainly need more definition.&nbsp; The basic idea is that you can share the book history but then let them diverge.&nbsp; This does mean there will be some oddity&nbsp;around what the journal entries point to.&nbsp; I think it will work out ok for our use case to just define it as a shared book entry history, but the linked journal entries only point to the one book id, so the forked book kinda sees that at some point in its history it is actually looking at a different history.&nbsp; I suppose this is duplicating money when you copy the book, certainly it&#39;s a new book with a balance all of a sudden.&nbsp; Probably the solution is to offset the copied balance with another book when you do the fork.&nbsp; Then the amounts still add up, we still get the balance in the new book and we can still read the history that led to that balance.&nbsp; All of this needs a deeper design pass to make sure we can make something really consistent at the books level.&nbsp; If we just can&#39;t do it then we&#39;d have to have one of the balances not have a history, which would be unfortunate, but not fatal.</span></p></div></body></html>
