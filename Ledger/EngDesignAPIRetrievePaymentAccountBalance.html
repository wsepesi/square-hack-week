<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=cGvuclDC_Z1vE_cnVEU6Ae_NZQ7StBcqH_vXVqoPMX0);.lst-kix_q607y6alwy9s-1>li:before{content:"\0025cb   "}.lst-kix_q607y6alwy9s-2>li:before{content:"\0025a0   "}.lst-kix_q607y6alwy9s-3>li:before{content:"\0025cf   "}.lst-kix_q607y6alwy9s-5>li:before{content:"\0025a0   "}.lst-kix_q607y6alwy9s-4>li:before{content:"\0025cb   "}.lst-kix_q607y6alwy9s-8>li:before{content:"\0025a0   "}.lst-kix_ttezoboobru8-2>li:before{content:"\0025a0   "}.lst-kix_q607y6alwy9s-7>li:before{content:"\0025cb   "}.lst-kix_q607y6alwy9s-6>li:before{content:"\0025cf   "}.lst-kix_ttezoboobru8-1>li:before{content:"\0025cb   "}.lst-kix_ttezoboobru8-0>li:before{content:"\0025cf   "}ul.lst-kix_o95od61g5ebw-1{list-style-type:none}ul.lst-kix_o95od61g5ebw-0{list-style-type:none}.lst-kix_o95od61g5ebw-0>li:before{content:"\0025cf   "}ul.lst-kix_o95od61g5ebw-3{list-style-type:none}ul.lst-kix_o95od61g5ebw-2{list-style-type:none}.lst-kix_ttezoboobru8-8>li:before{content:"\0025a0   "}.lst-kix_o95od61g5ebw-1>li:before{content:"\0025cb   "}ul.lst-kix_o95od61g5ebw-5{list-style-type:none}ul.lst-kix_o95od61g5ebw-4{list-style-type:none}ul.lst-kix_o95od61g5ebw-7{list-style-type:none}ul.lst-kix_o95od61g5ebw-6{list-style-type:none}.lst-kix_o95od61g5ebw-3>li:before{content:"\0025cf   "}ul.lst-kix_ttezoboobru8-8{list-style-type:none}ul.lst-kix_o95od61g5ebw-8{list-style-type:none}.lst-kix_o95od61g5ebw-2>li:before{content:"\0025a0   "}.lst-kix_o95od61g5ebw-4>li:before{content:"\0025cb   "}ul.lst-kix_ttezoboobru8-6{list-style-type:none}ul.lst-kix_ttezoboobru8-7{list-style-type:none}.lst-kix_ttezoboobru8-4>li:before{content:"\0025cb   "}.lst-kix_ttezoboobru8-3>li:before{content:"\0025cf   "}.lst-kix_o95od61g5ebw-7>li:before{content:"\0025cb   "}.lst-kix_o95od61g5ebw-6>li:before{content:"\0025cf   "}.lst-kix_o95od61g5ebw-8>li:before{content:"\0025a0   "}.lst-kix_o95od61g5ebw-5>li:before{content:"\0025a0   "}.lst-kix_ttezoboobru8-5>li:before{content:"\0025a0   "}.lst-kix_ttezoboobru8-6>li:before{content:"\0025cf   "}.lst-kix_q607y6alwy9s-0>li:before{content:"\0025cf   "}.lst-kix_ttezoboobru8-7>li:before{content:"\0025cb   "}ul.lst-kix_ttezoboobru8-0{list-style-type:none}ul.lst-kix_ttezoboobru8-1{list-style-type:none}ul.lst-kix_ttezoboobru8-4{list-style-type:none}ul.lst-kix_ttezoboobru8-5{list-style-type:none}ul.lst-kix_ttezoboobru8-2{list-style-type:none}ul.lst-kix_ttezoboobru8-3{list-style-type:none}ul.lst-kix_q607y6alwy9s-0{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}ul.lst-kix_q607y6alwy9s-2{list-style-type:none}ul.lst-kix_q607y6alwy9s-1{list-style-type:none}ul.lst-kix_q607y6alwy9s-4{list-style-type:none}ul.lst-kix_q607y6alwy9s-3{list-style-type:none}ul.lst-kix_q607y6alwy9s-6{list-style-type:none}ul.lst-kix_q607y6alwy9s-5{list-style-type:none}ul.lst-kix_q607y6alwy9s-8{list-style-type:none}ul.lst-kix_q607y6alwy9s-7{list-style-type:none}ol{margin:0;padding:0}table td,table th{padding:0}.c27{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#c9daf8;border-left-style:solid;border-bottom-width:1pt;width:313.5pt;border-top-color:#000000;border-bottom-style:solid}.c64{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#f1efee;border-left-style:solid;border-bottom-width:0pt;width:643.5pt;border-top-color:#000000;border-bottom-style:solid}.c12{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#c9daf8;border-left-style:solid;border-bottom-width:1pt;width:175.5pt;border-top-color:#000000;border-bottom-style:solid}.c33{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;background-color:#c9daf8;border-left-style:solid;border-bottom-width:1pt;width:105pt;border-top-color:#000000;border-bottom-style:solid}.c61{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:0pt;border-right-width:0pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:0pt;border-top-style:solid;background-color:#f1efee;border-left-style:solid;border-bottom-width:0pt;width:648.8pt;border-top-color:#000000;border-bottom-style:solid}.c22{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:236.2pt;border-top-color:#000000;border-bottom-style:solid}.c29{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:175.5pt;border-top-color:#000000;border-bottom-style:solid}.c17{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:138pt;border-top-color:#000000;border-bottom-style:solid}.c37{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:306.8pt;border-top-color:#000000;border-bottom-style:solid}.c55{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:186.8pt;border-top-color:#000000;border-bottom-style:solid}.c42{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:249pt;border-top-color:#000000;border-bottom-style:solid}.c36{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:136.5pt;border-top-color:#000000;border-bottom-style:solid}.c46{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:105pt;border-top-color:#000000;border-bottom-style:solid}.c19{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:162pt;border-top-color:#000000;border-bottom-style:solid}.c20{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:161.2pt;border-top-color:#000000;border-bottom-style:solid}.c10{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:25.5pt;border-top-color:#000000;border-bottom-style:solid}.c58{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:298.5pt;border-top-color:#000000;border-bottom-style:solid}.c7{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c35{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c21{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c18{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c23{margin-left:108pt;padding-top:0pt;padding-left:0pt;padding-bottom:0pt;line-height:1.25;text-align:left}.c5{background-color:#f1efee;font-size:10.5pt;font-family:"Consolas";color:#df5320;font-weight:400}.c51{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;text-align:left}.c32{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;text-align:left}.c50{background-color:#212121;color:#89ddff;font-weight:400;font-size:10.5pt;font-family:"Courier New"}.c30{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;text-align:left}.c57{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;text-align:left}.c14{background-color:#f1efee;font-size:10.5pt;font-family:"Consolas";color:#6666ea;font-weight:400}.c25{padding-top:20pt;padding-bottom:6pt;line-height:1.25;page-break-after:avoid;text-align:left}.c8{background-color:#f1efee;font-size:10.5pt;font-family:"Consolas";color:#68615e;font-weight:400}.c26{background-color:#f1efee;font-weight:400;font-size:10.5pt;font-family:"Consolas"}.c39{margin-left:auto;border-spacing:0;border-collapse:collapse;margin-right:auto}.c45{padding-top:0pt;padding-bottom:0pt;line-height:1.25;text-align:left}.c40{border-spacing:0;border-collapse:collapse;margin-right:auto}.c47{color:#ff9900;font-weight:400;font-size:11pt;font-family:"Arial"}.c54{color:#000000;font-weight:400;font-size:16pt;font-family:"Arial"}.c53{color:#000000;font-weight:400;font-size:26pt;font-family:"Arial"}.c34{padding-top:0pt;padding-bottom:0pt;line-height:1.15;text-align:left}.c59{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#0000ee;text-decoration:underline}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.0;text-align:left}.c0{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c38{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c44{text-decoration:none;vertical-align:baseline;font-style:normal}.c56{color:#ff9900;font-size:11pt;font-family:"Arial"}.c63{color:#000000;font-size:11pt}.c31{margin-left:36pt;padding-left:0pt}.c13{padding:0;margin:0}.c11{margin-left:72pt;padding-left:0pt}.c9{orphans:2;widows:2}.c49{font-weight:400;font-family:"Consolas"}.c6{border:1px solid black;margin:5px}.c28{color:inherit;text-decoration:inherit}.c24{margin-left:108pt;padding-left:0pt}.c16{height:138.8pt}.c4{height:11pt}.c3{height:0pt}.c52{font-family:"Consolas"}.c41{height:25.3pt}.c62{color:#ff9900}.c48{background-color:#c9daf8}.c15{font-weight:700}.c43{color:#407ee7}.c60{height:21pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c38 doc-content"><p class="c9 c57 title" id="h.349de4t840kf"><span class="c44 c53">[Eng Design] API: RetrievePaymentAccountBalance</span></p><p class="c2"><span>From higher-level doc: </span><span class="c59"><a class="c28" href="https://www.google.com/url?q=https://docs.google.com/document/d/1kgZcm0QodZ91GhatTSZNQ4eOCM8vfS6pLDFNYQzf-L0/edit?pli%3D1%23heading%3Dh.56986b924a6e&amp;sa=D&amp;source=editors&amp;ust=1689358409916249&amp;usg=AOvVaw25yylVFy1aYCDKxkZn2uBw">API Design - Payment Balances</a></span></p><h1 class="c9 c32" id="h.pscccq8xnjz5"><span class="c21">Overview</span></h1><p class="c2"><span class="c62">Orange</span><span class="c7">&nbsp;means new changes / updates</span></p><p class="c45"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 800.00px; height: 341.33px;"><img alt="" src="images/image1.png" style="width: 800.00px; height: 341.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><h1 class="c32 c9" id="h.ihvdy3bn0ti"><span>Code changes in FinancialAccount</span></h1><p class="c2"><span>Probably a 1-pointer task.</span></p><p class="c2"><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-4569&amp;sa=D&amp;source=editors&amp;ust=1689358409917019&amp;usg=AOvVaw3G8wIR4MLavczdBXBZflIA">https://jira.sqprod.co/browse/ACTENG-4569</a></span></p><p class="c2 c4"><span class="c7"></span></p><p class="c2"><span>Need to add a new </span><span class="c15">int64</span><span>&nbsp;</span><span class="c15">version</span><span>&nbsp;to the </span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://github.com/squareup/java/blob/master/financialaccount/financialaccount-proto/src/main/proto/squareup/financialaccount/balance_services.proto%23L30&amp;sa=D&amp;source=editors&amp;ust=1689358409917506&amp;usg=AOvVaw3P-bYSUmflrYiBBTTXmuyc">Balance proto</a></span><span>.</span><sup><a href="#cmnt1" id="cmnt_ref1">[a]</a></sup><sup><a href="#cmnt2" id="cmnt_ref2">[b]</a></sup><sup><a href="#cmnt3" id="cmnt_ref3">[c]</a></sup><sup><a href="#cmnt4" id="cmnt_ref4">[d]</a></sup><sup><a href="#cmnt5" id="cmnt_ref5">[e]</a></sup><sup><a href="#cmnt6" id="cmnt_ref6">[f]</a></sup><sup><a href="#cmnt7" id="cmnt_ref7">[g]</a></sup><sup><a href="#cmnt8" id="cmnt_ref8">[h]</a></sup><sup><a href="#cmnt9" id="cmnt_ref9">[i]</a></sup><sup><a href="#cmnt10" id="cmnt_ref10">[j]</a></sup><sup><a href="#cmnt11" id="cmnt_ref11">[k]</a></sup><sup><a href="#cmnt12" id="cmnt_ref12">[l]</a></sup><sup><a href="#cmnt13" id="cmnt_ref13">[m]</a></sup><sup><a href="#cmnt14" id="cmnt_ref14">[n]</a></sup><sup><a href="#cmnt15" id="cmnt_ref15">[o]</a></sup><sup><a href="#cmnt16" id="cmnt_ref16">[p]</a></sup><sup><a href="#cmnt17" id="cmnt_ref17">[q]</a></sup><sup><a href="#cmnt18" id="cmnt_ref18">[r]</a></sup><sup><a href="#cmnt19" id="cmnt_ref19">[s]</a></sup><sup><a href="#cmnt20" id="cmnt_ref20">[t]</a></sup><sup><a href="#cmnt21" id="cmnt_ref21">[u]</a></sup><sup><a href="#cmnt22" id="cmnt_ref22">[v]</a></sup><sup><a href="#cmnt23" id="cmnt_ref23">[w]</a></sup><sup><a href="#cmnt24" id="cmnt_ref24">[x]</a></sup><sup><a href="#cmnt25" id="cmnt_ref25">[y]</a></sup><sup><a href="#cmnt26" id="cmnt_ref26">[z]</a></sup><sup><a href="#cmnt27" id="cmnt_ref27">[aa]</a></sup><sup><a href="#cmnt28" id="cmnt_ref28">[ab]</a></sup><sup><a href="#cmnt29" id="cmnt_ref29">[ac]</a></sup></p><p class="c2 c4"><span class="c7"></span></p><p class="c2"><span>This will allow us to get all the data in the same endpoint, avoiding the need to call </span><span class="c15">BalanceChangeService#GetBalancechange</span><span class="c7">&nbsp;to fetch the version.</span></p><p class="c2 c4"><span class="c7"></span></p><p class="c2"><span>Need to add a </span><span class="c15">version</span><span>&nbsp;field to the </span><span class="c15">BalanceModel</span><span class="c7">.</span></p><p class="c2"><span>We can extract the book </span><span class="c15">version</span><span>&nbsp;from the existing </span><span class="c15">BookBalances.BookBalance</span><span class="c7">&nbsp;proto.</span></p><p class="c2"><span>And construct the BalanceModel including the </span><span class="c15">version</span><span>. </span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://github.com/squareup/java/blob/master/financialaccount/src/main/java/com/squareup/financialaccount/model/BalanceModel.kt%23L36&amp;sa=D&amp;source=editors&amp;ust=1689358409918446&amp;usg=AOvVaw3Tr6KyWx-gpYk9M2IOrMkL">See code here</a></span><span class="c7">.</span></p><h2 class="c9 c51" id="h.a1wknf26u3y7"><span class="c44 c54">Flipping the Amount sign in FA for Ledger</span></h2><p class="c2"><span>Ticket: </span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-4599&amp;sa=D&amp;source=editors&amp;ust=1689358409918784&amp;usg=AOvVaw2K6QlRYcP96_aXRLzO7h6-">https://jira.sqprod.co/browse/ACTENG-4599</a></span></p><p class="c2 c4"><span class="c7"></span></p><p class="c2"><span class="c15">Ledger</span><span class="c7">&nbsp;books have negative accruing amounts. This was because it was originally written in the perspective of Square instead of in the perspective of the Merchants.</span></p><p class="c2 c4"><span class="c7"></span></p><p class="c2"><span class="c15">FinancialAccount</span><span class="c7">&nbsp;need to present amounts for the account balance in the perspective of Merchants. This means that its a positively accruing balance. This is because writes to FinancialAccount are asymmetrical. MONEY_IN and MONEY_OUT affects the CURRENT balance differently.</span></p><p class="c2 c4"><span class="c7"></span></p><p class="c2"><span>Therefore, we need to add special logic in FinancialAccount t</span><span class="c15">o flip all the amounts for the Ledger tennant by multiplying by -1 </span><span class="c7">in order to present the balance in the Merchant&rsquo;s perspective.</span></p><h1 class="c32 c9" id="h.m2p9368ttpmx"><span class="c21">Code changes in PaymentBalance</span></h1><p class="c2"><span class="c7">Each bullet point below can be it&rsquo;s own JIRA ticket, with an estimated point value in [brackets]</span></p><p class="c2 c4"><span class="c7"></span></p><ul class="c13 lst-kix_q607y6alwy9s-0 start"><li class="c2 c31 li-bullet-0"><span class="c7">[3] Create FA service for Balance retrieval within PB code</span></li></ul><ul class="c13 lst-kix_q607y6alwy9s-1 start"><li class="c2 c11 li-bullet-0"><span>See ticket description: </span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-4566&amp;sa=D&amp;source=editors&amp;ust=1689358409919600&amp;usg=AOvVaw09lO6HtDelbiofTfo5Agie">https://jira.sqprod.co/browse/ACTENG-4566</a></span></li><li class="c2 c11 li-bullet-0"><span>See </span><span class="c0"><a class="c28" href="#h.co2c6kincbg8">Mappings</a></span><span class="c7">&nbsp;section</span></li></ul><ul class="c13 lst-kix_q607y6alwy9s-2 start"><li class="c2 c24 li-bullet-0"><span class="c7">PB Request -&gt; FA Request</span></li><li class="c2 c24 li-bullet-0"><span class="c7">FA Response -&gt; PB Response</span></li></ul><p class="c2 c4"><span class="c7"></span></p><ul class="c13 lst-kix_q607y6alwy9s-0"><li class="c2 c31 li-bullet-0"><span>[2] </span><span class="c7">Create RPC in PaymentBalancesService</span></li></ul><ul class="c13 lst-kix_q607y6alwy9s-1 start"><li class="c2 c11 li-bullet-0"><span>See ticket description: </span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://jira.sqprod.co/browse/ACTENG-4567&amp;sa=D&amp;source=editors&amp;ust=1689358409920157&amp;usg=AOvVaw1boDQXAP2CkvYP8T0PDGWp">https://jira.sqprod.co/browse/ACTENG-4567</a></span></li><li class="c2 c11 li-bullet-0"><span>See </span><span class="c0"><a class="c28" href="#h.mutbb8bmmuqh">Req/Res protos below</a></span></li><li class="c2 c11 li-bullet-0"><span class="c7">RPC action handlers in PB</span></li><li class="c2 c11 li-bullet-0"><span class="c7">Invoke service created previously</span></li></ul><p class="c2 c4"><span class="c7"></span></p><ul class="c13 lst-kix_o95od61g5ebw-0 start"><li class="c2 c31 li-bullet-0"><span>[2?]</span><sup><a href="#cmnt30" id="cmnt_ref30">[ad]</a></sup><span>&nbsp;Integrate </span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://plathome.sqprod.co/docs/build/api-velocity/implement-your-api-in-java&amp;sa=D&amp;source=editors&amp;ust=1689358409920790&amp;usg=AOvVaw2XQm_pr8Lacgl8kXDrx8Qv">API Velocity </a></span><span>to the RPC endpoint to allow external HTTP access via </span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://developer.squareup.com/reference/square&amp;sa=D&amp;source=editors&amp;ust=1689358409920995&amp;usg=AOvVaw0Hsz_kwZd-vWM1P8n-WYJ6">ConnectV2</a></span></li></ul><ul class="c13 lst-kix_q607y6alwy9s-1 start"><li class="c2 c11 li-bullet-0"><span>Use available </span><span class="c0">Error</span><span class="c7">&nbsp;proto format. Default way to render errors</span></li><li class="c2 c11 li-bullet-0"><span class="c7">Test calling the endpoint for Success / Error responses</span></li></ul><ul class="c13 lst-kix_q607y6alwy9s-2 start"><li class="c23 li-bullet-0"><span class="c15 c52">GET </span><span class="c49">v2/payment-balances/accounts/{account_id}/balance</span></li></ul><h1 class="c25" id="h.mutbb8bmmuqh"><span>Protos</span></h1><h3 class="c30 c9" id="h.ddd8f2hcsn71"><span class="c35">Request/Response Proto:</span></h3><a id="t.ddc51a36d2e6c5e759c15f788ddae526b4062cc5"></a><a id="t.0"></a><table class="c40"><tr class="c3"><td class="c61" colspan="1" rowspan="1"><p class="c34"><span class="c14">message</span><span class="c8">&nbsp;</span><span class="c26 c43">RetrievePaymentAccountBalanceRequest</span><span class="c8">&nbsp;{<br> /* The ID of the account to retrieve */<br> </span><span class="c14">optional</span><span class="c8">&nbsp;</span><span class="c5">string</span><span class="c8">&nbsp;account_id = </span><span class="c5">1</span><span class="c8">&nbsp;[(squareup.validation.not_empty) = </span><span class="c5">true</span><span class="c8">];<br><br> /**<br> &nbsp;* Timestamp (in RFC </span><span class="c5">3339</span><span class="c8">&nbsp;format) to get the balance as of.<br> &nbsp;* Balance at time based on the currently recorded activity.<br> &nbsp;* This can change on </span><span class="c14">repeated</span><span class="c8">&nbsp;calls if a back-dated balance change is created.<br> &nbsp;* TODO: Find out if API Velocity will auto-serialize / deserialize this from DateTime to RFC3339<br> &nbsp;*/<br> </span><span class="c14">optional</span><span class="c8">&nbsp;</span><span class="c5">string</span><sup><a href="#cmnt31" id="cmnt_ref31">[ae]</a></sup><sup><a href="#cmnt32" id="cmnt_ref32">[af]</a></sup><span class="c8">&nbsp;as_of_time = </span><span class="c5">2</span><span class="c8">;<br>}<br><br></span><span class="c14">message</span><span class="c8">&nbsp;</span><span class="c26 c43">RetrievePaymentAccountBalanceResponse</span><span class="c8">&nbsp;{<br> /* The account balance object */<br> </span><span class="c14">optional</span><span class="c8">&nbsp;PaymentBalanceAccountBalance balance = </span><span class="c5">1</span><span class="c8">&nbsp;[(squareup.validation.</span><span class="c14">required</span><span class="c8">) = </span><span class="c5">true</span><span class="c8 c44">];<br><br> /* any errors. If the account is returned, this should be empty */</span></p><p class="c34"><span class="c8">&nbsp;/* Must use connect </span><span class="c0 c26"><a class="c28" href="https://www.google.com/url?q=https://prototype.sqprod.co/%23/docs/squareup.connect.v2.resources.Error&amp;sa=D&amp;source=editors&amp;ust=1689358409923101&amp;usg=AOvVaw3tF9on1QpiI5rx_uNe9-cV">v2 Error proto</a></span><span class="c8">&nbsp;to play nice with conversion to external HTTP endpoint */<br> </span><span class="c14">repeated</span><span class="c8">&nbsp;Error errors = </span><span class="c5">2</span><span class="c8">;<br>}</span></p></td></tr></table><h3 class="c9 c30" id="h.y3hfvlhsihfy"><span class="c35">The model</span></h3><a id="t.4eaabcf4316a7b37fc887eda0bea2d0fa6b2b431"></a><a id="t.1"></a><table class="c40"><tr class="c3"><td class="c64" colspan="1" rowspan="1"><p class="c34"><span class="c14">message</span><span class="c8">&nbsp;</span><span class="c26 c43">PaymentBalanceAccountBalance</span><span class="c8">&nbsp;{<br> /* The ID of the account */<br> </span><span class="c14">optional</span><span class="c8">&nbsp;</span><span class="c5">string</span><span class="c8">&nbsp;account_id = </span><span class="c5">1</span><span class="c8">&nbsp;[(squareup.validation.not_empty) = </span><span class="c5">true</span><span class="c8">];<br><br> /* Timestamp when the balance was last changed, in RFC </span><span class="c5">3339</span><span class="c8">&nbsp;format.<br> &nbsp;* TODO: Find out if API Velocity will auto-serialize / deserialize this from DateTime to RFC3339<br> &nbsp;*/<br> </span><span class="c14">optional</span><span class="c8">&nbsp;</span><span class="c5">string</span><span class="c8">&nbsp;updated_at = </span><span class="c5">2</span><span class="c8">&nbsp;[(squareup.validation.not_empty) = </span><span class="c5">true</span><span class="c8">];<br><br> /* Balance version. Incremented whenever the balance changes */<br> </span><span class="c14">optional</span><span class="c8">&nbsp;</span><span class="c5">int64</span><span class="c8">&nbsp;version = </span><span class="c5">3</span><span class="c8">&nbsp;[(squareup.validation.</span><span class="c14">required</span><span class="c8">) = </span><span class="c5">true</span><span class="c8">];<br><br> /**<br> &nbsp;* The POSTED amount of the balance, currency must match the currency of the account.<br> &nbsp;* Positive amount indicates Square owes the seller that amount, negative means the seller owes Square.<br> &nbsp;*/<br> </span><span class="c14">optional</span><span class="c8">&nbsp;Money amount = </span><span class="c5">4</span><span class="c8">&nbsp;[(squareup.validation.</span><span class="c14">required</span><span class="c8">) = </span><span class="c5">true</span><span class="c8">];<br><br> /* The balance activity that set the balance to this amount.<br> &nbsp;* The running balance of this balance activity will match the amount here.<br> &nbsp;* TODO: Need to create the balance activity model first before being able to fill this field<br> &nbsp;* &nbsp; &nbsp; &nbsp; Once that is done, this field should be a non-empty field<br> &nbsp;*/<br> </span><span class="c14">optional</span><span class="c8">&nbsp;</span><span class="c5">string</span><span class="c8">&nbsp;last_balance_activity_id = </span><span class="c5">5</span><span class="c8">;</span><sup><a href="#cmnt33" id="cmnt_ref33">[ag]</a></sup><sup><a href="#cmnt34" id="cmnt_ref34">[ah]</a></sup><span class="c8"><br>}</span></p></td></tr></table><p class="c2 c4"><span class="c7"></span></p><h1 class="c32 c9" id="h.co2c6kincbg8"><span>Message mappings</span></h1><a id="t.b94e87a9c17a43a53fa95d35db8b60cd39a30c0b"></a><a id="t.2"></a><table class="c39"><tr class="c41"><td class="c22 c48" colspan="1" rowspan="1"><p class="c1 c9"><span class="c18 c15">RetrievePaymentAccountBalanceRequest</span></p></td><td class="c48 c58" colspan="2" rowspan="1"><p class="c1 c9"><span class="c18 c15">GetBalanceByTypeRequest</span></p></td></tr><tr class="c3"><td class="c22" colspan="1" rowspan="1"><p class="c1 c9 c4"><span class="c7"></span></p></td><td class="c19" colspan="1" rowspan="1"><p class="c1 c9"><span class="c15">tenant_id</span></p></td><td class="c36" colspan="1" rowspan="1"><p class="c1 c9"><span class="c7">ledger</span></p></td></tr><tr class="c3"><td class="c22" colspan="1" rowspan="1"><p class="c1 c9 c4"><span class="c7"></span></p></td><td class="c19" colspan="1" rowspan="1"><p class="c1 c9"><span class="c18 c15">Balance.BalanceType type</span></p></td><td class="c36" colspan="1" rowspan="1"><p class="c1 c9"><span class="c7">POSTED</span></p></td></tr><tr class="c3"><td class="c22" colspan="1" rowspan="1"><p class="c1 c9"><span class="c15">account_id</span></p></td><td class="c19" colspan="1" rowspan="1"><p class="c1 c9"><span class="c15">financial_account_id</span></p></td><td class="c36" colspan="1" rowspan="1"><p class="c1 c9"><span class="c7">Strip the &ldquo;pbact_0&rdquo; prefix</span></p></td></tr><tr class="c3"><td class="c22" colspan="1" rowspan="1"><p class="c1 c9"><span class="c18 c15">as_of_time</span></p></td><td class="c19" colspan="1" rowspan="1"><p class="c1 c9"><span class="c18 c15">as_of_time</span></p></td><td class="c36" colspan="1" rowspan="1"><p class="c1 c9"><span class="c7">Format conversion</span></p></td></tr></table><p class="c2 c4"><span class="c7"></span></p><p class="c2 c4"><span class="c7"></span></p><a id="t.1f2a9a6596db1c9ef60395537d8f0ca7e9d5f394"></a><a id="t.3"></a><table class="c39"><tr class="c60"><td class="c48 c55" colspan="2" rowspan="1"><p class="c1"><span class="c18 c15">GetBalanceByTypeResponse</span></p></td><td class="c27" colspan="2" rowspan="1"><p class="c1 c9"><span class="c15 c18">RetrievePaymentAccountBalanceResponse</span></p><p class="c1 c9"><span>PaymentBalanceAccountBalance</span></p></td></tr><tr class="c3"><td class="c20" colspan="1" rowspan="1"><p class="c1"><span class="c15">tenant_id</span></p></td><td class="c10" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c1 c4"><span class="c18 c15"></span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td></tr><tr class="c3"><td class="c20" colspan="1" rowspan="1"><p class="c1"><span class="c15">financial_account_id</span></p></td><td class="c10" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">account_id</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c1"><span class="c7">Add prefix to it</span></p></td></tr><tr class="c3"><td class="c20" colspan="1" rowspan="1"><p class="c1 c9"><span class="c15">BalanceType</span><span>&nbsp;</span><span class="c15">type</span></p></td><td class="c10" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td></tr><tr class="c16"><td class="c20" colspan="1" rowspan="1"><p class="c1"><span class="c15">Money amount</span></p></td><td class="c10" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c1"><span class="c15">Money amount</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c1 c9"><span class="c7">The POSTED balance in FA is taken from Books.</span></p><p class="c1 c9 c4"><span class="c7"></span></p><p class="c1 c9"><span class="c7">The resulting amount should be positive.</span></p><p class="c1 c9 c4"><span class="c7"></span></p><p class="c1 c9"><span>For more details into the specific books corresponding to the PB Account type, </span><span class="c0"><a class="c28" href="#h.mm6epwj801io">see the mapping below.</a></span></p></td></tr><tr class="c3"><td class="c20" colspan="1" rowspan="1"><p class="c1 c9"><span class="c18 c15">DateTime updated_at</span></p></td><td class="c10" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c1"><span class="c15">updated_at</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c1"><span class="c7">Format RFC 3339</span></p></td></tr><tr class="c3"><td class="c20" colspan="1" rowspan="1"><p class="c1 c9 c4"><span class="c18 c15"></span></p></td><td class="c10" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c1 c4"><span class="c18 c15"></span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td></tr><tr class="c3"><td class="c20" colspan="1" rowspan="1"><p class="c1 c9"><span class="c44 c15 c56">version</span></p><p class="c1 c9"><span class="c44 c47">Add this field to the response</span></p></td><td class="c10" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">int64 version</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td></tr><tr class="c3"><td class="c20" colspan="1" rowspan="1"><p class="c1 c9"><span class="c18 c15">last_balance_change_id</span></p></td><td class="c10" colspan="1" rowspan="1"><p class="c1 c4"><span class="c7"></span></p></td><td class="c17" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">last_balance_activity_id</span></p></td><td class="c29" colspan="1" rowspan="1"><p class="c1"><span class="c7">Leave empty</span></p></td></tr></table><h1 class="c25" id="h.mm6epwj801io"><span class="c21">Amount signage mappings</span></h1><p class="c2"><span class="c15">FinancialAccounts</span><span>&nbsp;fetches </span><span class="c15">Books</span><span>&nbsp;balance as-is, without doing any sign conversions.</span><sup><a href="#cmnt35" id="cmnt_ref35">[ai]</a></sup></p><p class="c2"><span>Below is a brief description of what those Books are for, and which </span><span class="c15">PaymentBalanceAccount</span><span class="c7">&nbsp;it maps to.</span></p><p class="c2 c4"><span class="c7"></span></p><a id="t.6f74cc35a8223ceb26479a1c21773a129df63e80"></a><a id="t.4"></a><table class="c39"><tr class="c3"><td class="c33" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">PaymentBalances</span></p><p class="c1"><span class="c18 c15">Account Type</span></p></td><td class="c37 c48" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">GetBalanceByTypeResponse amount<br>(From Book Type)</span></p></td><td class="c42 c48" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">RetrievePaymentAccountBalanceResponse</span></p><p class="c1"><span class="c18 c15">`amount`</span></p></td></tr><tr class="c3"><td class="c46" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">PAYOUT</span></p></td><td class="c37" colspan="1" rowspan="1"><p class="c1"><span class="c15">MERCHANT_PAYABLE</span><span>&nbsp;(</span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://us-east1.books.books-production.sso.squarecloudservices.com/books-admin/index.html%23/ti7E8qMJyAGPezpd0HwrfFovkS6bVXMoxBiygxzRcGwrOpcZc8DWQ/book/PazMq9KoGLy1jPiofBNl6dlUGxQSyh2XUgsFl7og&amp;sa=D&amp;source=editors&amp;ust=1689358409937490&amp;usg=AOvVaw3OrRwwoW1W3Gs0JovOrqCc">example</a></span><span class="c7">)</span></p><p class="c1"><span class="c7">Negative-accruing book balance. The negative amounts is what is &ldquo;owed to the merchant by Square&rdquo;</span></p></td><td class="c42" colspan="1" rowspan="1"><p class="c1"><span class="c7">Should return positive.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">This is the amount owed to the merchant</span></p></td></tr><tr class="c3"><td class="c46" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">FEE</span></p></td><td class="c37" colspan="1" rowspan="1"><p class="c1"><span class="c15">FEE_PAYABLE</span><span>&nbsp;(</span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://us-east1.books.books-production.sso.squarecloudservices.com/books-admin/index.html%23/ti7E8qMJyAGPezpd0HwrfFovkS6bVXMoxBiygxzRcGwrOpcZc8DWQ/book/1PlqDcwFcRhE6xyMcBKMD-c37FRsiamp0q4LtJug&amp;sa=D&amp;source=editors&amp;ust=1689358409938731&amp;usg=AOvVaw2YmtENKWKYscR61Nzbzxnl">example</a></span><span class="c7">)</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">For Cost+ merchants.</span></p><p class="c1"><span class="c7">A negative-accuring book balance.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">This negative balance is swept to the MERCHANT_PAYABLE book via a &ldquo;settlement&rdquo; event.</span></p></td><td class="c42" colspan="1" rowspan="1"><p class="c1"><span class="c7">Sould return positive.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">This is the amount owed to the merchant</span></p></td></tr><tr class="c3"><td class="c46" colspan="1" rowspan="1"><p class="c1"><span class="c18 c15">RISK_RESERVE</span></p></td><td class="c37" colspan="1" rowspan="1"><p class="c1"><span class="c15">RISK_RESERVE_PAYABLE</span><span>&nbsp;(</span><span class="c0"><a class="c28" href="https://www.google.com/url?q=https://us-east1.books.books-production.sso.squarecloudservices.com/books-admin/index.html%23/ti7E8qMJyAGPezpd0HwrfFovkS6bVXMoxBiygxzRcGwrOpcZc8DWQ/book/J6YZOWcjc5QzPrkThBjmtEvOT0R5S0lY8eaNiBgA&amp;sa=D&amp;source=editors&amp;ust=1689358409940220&amp;usg=AOvVaw1PSh2bRP79_MsCMdCaWFQ4">example</a></span><span class="c7">)</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">A negative book balance.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Risk holds a certain amount in order to cover potential future debts. I.e. covering possible chargebacks from customer.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">It is eventually released to the MERCHANT_PAYABLE book.</span></p></td><td class="c42" colspan="1" rowspan="1"><p class="c1"><span class="c7">Should return positive</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">This is the amount owed to the merchant</span></p></td></tr></table><p class="c2 c4"><span class="c7"></span></p><div class="c6"><p class="c1"><a href="#cmnt_ref1" id="cmnt1">[a]</a><span class="c7">Why is `version` info needed here in Balance query? Any reason that `updated_at` is not sufficient?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref2" id="cmnt2">[b]</a><span class="c7">The `version` is part of the spec for the response on the root API doc.</span></p><p class="c1"><span class="c7">Maybe the clients wouldn&#39;t need the `version` field, but that depends on their use case. Maybe @dskarbek@squareup.com can answer it</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">https://docs.google.com/document/d/1kgZcm0QodZ91GhatTSZNQ4eOCM8vfS6pLDFNYQzf-L0/edit?pli=1#heading=h.rclwmvcjar94</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref3" id="cmnt3">[c]</a><span class="c7">Oh I see. Hmm as Dan is out this week, @deni@squareup.com, @cpopescu@squareup.com could you chime in if you have any ideas both from FA and PB API side to see if we actually need to expose the books balance version info in the public API?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref4" id="cmnt4">[d]</a><span class="c7">Yeah i&#39;m kind of interested in what cases we&#39;d prefer to see &quot;give me the Xth balance&quot; vs &quot;give me the balance at a certain time&quot;. Versioning of balances makes sense to me if we need to audit how we got to a certain balance, but seems less useful in the real world.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref5" id="cmnt5">[e]</a><span class="c7">@kcrane@squareup.com actually a key use case multiple developer partners mentioned for the Payment Balances API is troubleshooting. Sometimes they receive a different deposit sum than they were expecting and they want to go back to our balance source of truth and understand how it got to that value.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">@mengen@squareup.com what&nbsp;is the books balance version?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref6" id="cmnt6">[f]</a><span class="c7">Thanks for clarification Christian! If that&#39;s the product need, I agree we could add the version in.</span></p><p class="c1"><span class="c7">I imagine the version exposed here is the Books version? e.g. Books has version incremented every time a new Book Entry is journaled. And we&#39;ll expose the Book&#39;s version at which the Balance we expose?</span></p><p class="c1"><span class="c7">An example: https://us-east1.books.books-production.sso.squarecloudservices.com/books-admin/index.html#/ti7E8qMJyAGPezpd0HwrfFovkS6bVXMoxBiygxzRcGwrOpcZc8DWQ/book/1PlqDcwFcRhE6xyMcBfc2UIF3hQQaP3-Xs4_oanA</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref7" id="cmnt7">[g]</a><span class="c7">yes bookVersion is this. also to chime in, time is not 100% precise as there may be multiple&nbsp;versions recorded within the same timestamp</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref8" id="cmnt8">[h]</a><span class="c7">the index is on bookVersion, so as far as precision&nbsp;is concerned, this should be the source of truth for troubleshooting.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref9" id="cmnt9">[i]</a><span class="c7">Is the balance version incremented based on when the entries are created at timestamp?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref10" id="cmnt10">[j]</a><span class="c7">The balance version is actually the same thing as the Book version.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">This version is incremented every time we have a new Book entry. If two book entries are created at the same time resolution, (for instance in the same second, or fraction of a second), there will be 2 versions for that time.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Each version should uniquely correspond to a &quot;change&quot; in balance though</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref11" id="cmnt11">[k]</a><span class="c7">Can we use the balance activity id as the version?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref12" id="cmnt12">[l]</a><span class="c7">that question is confusing to me. we have both ID and version. ID is UUID and version is auto-incrementing int. we can use ID for debugging purposes, but I wouldnt call it a version, if we don&#39;t want to expose version, that&#39;s fine, but if we do then I think&nbsp;we should use the bookVersion.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref13" id="cmnt13">[m]</a><span class="c7">If someone wants to look up a balance in the past, they either need to use a timestamp or some sort of version identifier.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Timestamp is more convenient but it has some problems that have already been called out. I think it&#39;s still useful, but let&#39;s ignore timestamp for now.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">There is a 1:1 mapping between a version and a balance activity ID, right? If so, the Developer will have to store both the balance_activity_id and the version if they want to retrieve the balance later.&nbsp;It seems like it would make sense to support an API like GetBalanceAfterBalanceActivity(balance_activity_id). Then they only have to store one field (and we only have to expose one field).</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref14" id="cmnt14">[n]</a><span class="c7">&gt; Developer will have to store both the balance_activity_id and the version if they want to retrieve the balance later</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">They could just store the version too. They would already have the Balance ID, so could essentially do:</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">GetBalanceAtVersion(balance_id, version)</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">I think the primary benefit of version is that its ordered and an int as opposed to a UUID. So you could +1, -1, or directly &quot;jump to&quot; the first version (1) if you liked</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref15" id="cmnt15">[o]</a><span class="c7">&gt;&nbsp;There is a 1:1 mapping between a version and a balance activity ID, right? If so, the Developer will have to store both the balance_activity_id and the version if they want to retrieve the balance later</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">There is a 1:1 mapping within the same Balance. (version &quot;2&quot; can mean different things in 2 different Balances)</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">The developer stores the BalanceID, and the version,</span></p><p class="c1"><span class="c7">OR</span></p><p class="c1"><span class="c7">the BalanceActivity ID by itself.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Both can fetch a singular Activity</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref16" id="cmnt16">[p]</a><span class="c7">I&#39;m trying to imagine a scenario where a developer would want to retrieve a historical balance using something other than a timestamp. One scenario I can imagine is that they might store a history of all of their payouts. The payout should point to a balance_activity_id that represents the debit on the payment balance from when we sent money to their bank account. Let&#39;s say they want to get their balance after that debit. There are three ways we could support that:</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">1) We&#39;d give them the balance_activity_id AND the version on the payout object. They can use the balance_activity_id to look up details about that balance activity, or they can use the version to look up the balance.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">OR</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">2) They can get the version of the balance by first looking up the balance activity, then they can lookup the balance by using the version.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">OR</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">3) We let them look up the balance directly with the balance_activity_id.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Also note that if we go with version, then we have to give developers a way to discover the version. I think that means we&#39;d have to put it on the BalanceActivity object. I think we might as well just use the balance_activity_id as the version.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref17" id="cmnt17">[q]</a><span class="c7">Let me try to make this more clear. Let&#39;s say I have the following Payout object:</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">{</span></p><p class="c1"><span class="c7">&nbsp; payout_id: po_1,</span></p><p class="c1"><span class="c7">&nbsp; balance_id: pbact_1,</span></p><p class="c1"><span class="c7">&nbsp; balance_activity_id: pbaty_1,</span></p><p class="c1"><span class="c7">&nbsp; payout_entries: [ ... ]</span></p><p class="c1"><span class="c7">}</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Now I want to lookup the balance after the payout. I can simply do:</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">GetBalance(pbaty_1)</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Alternatively, if we go with version, then I have to do something like this:</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">balance_activity = GetBalanceActivity(pbaty_1)</span></p><p class="c1"><span class="c7">GetBalance(pbact_1, balance_activity.version)</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">OR we&#39;d have to modify the payout object to include the version:</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">{</span></p><p class="c1"><span class="c7">&nbsp; payout_id: po_1,</span></p><p class="c1"><span class="c7">&nbsp; balance_id: pbact_1,</span></p><p class="c1"><span class="c7">&nbsp; balance_version: 1,</span></p><p class="c1"><span class="c7">&nbsp; balance_activity_id: pbaty_1,</span></p><p class="c1"><span class="c7">&nbsp; payout_entries: [ ... ]</span></p><p class="c1"><span class="c7">}</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">GetBalance(pbact_1, version=1)</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref18" id="cmnt18">[r]</a><span class="c7">It feels to me more a product question as how we want to enable clients to call PB API to get balance? According to the current `RetrievePaymentAccountBalance` in PB API design, we only allow an optional field of `as_of_time` timestamp, otherwise we&#39;re returning back latest balance.&nbsp;</span></p><p class="c1"><span class="c7">I think it&#39;s a question for @cpopescu@squareup.com and @dskarbek@squareup.com on if we want to enable query balance by version or by pb activity id in public API?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref19" id="cmnt19">[s]</a><span class="c7">I remembered that the running balance after a balance activity is present on the PaymentBalanceActivity object. https://docs.google.com/document/d/1kgZcm0QodZ91GhatTSZNQ4eOCM8vfS6pLDFNYQzf-L0/edit?pli=1#bookmark=id.i7wkcrdh63l4. That means a developer can use the RetrievePaymentAccountBalanceActivity endpoint for the scenario that @kcraft@squareup.com pointed out i.e., to get the balance after a payment balance ID. In this context I don&#39;t think we need to duplicate that functionality in the RetrievePaymentAccountBalance endpoint, so I&#39;m leaning towards using the books balance version.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref20" id="cmnt20">[t]</a><span class="c7">The &quot;version&quot; right now as-is seems to be only informational, since all the other API endpoints of PB are using balance_activity_id for referencing the model.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">I agree with Cristian on that maybe we should allow using &quot;version&quot; along with &quot;as_of_time&quot; in the&nbsp;RetrievePaymentAccountBalance endpoint.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">I think it makes sense to keep &quot;version&quot; an &quot;identifier&quot; of the Balance, and &quot;activity_id&quot; an identifier of the BalanceActivity, and not use them interchangeably.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref21" id="cmnt21">[u]</a><span class="c7">Actually, I&#39;d recommend that we keep the version field informational for now and only retrieve the balance using &quot;as_of_time&quot;. We&#39;ve heard this request from partners but haven&#39;t heard the need to retrieve the balance by version. If we hear the need in the future to retrieve the balance&nbsp;by version we can add a query&nbsp;by version then. Thoughts?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref22" id="cmnt22">[v]</a><span class="c7">@cpopescu@squareup.com good call out that the running balance is on the balance activity. Agree we don&rsquo;t need to duplicate that functionality on RetrievePaymentAccountBalance for now.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Re. The version field: if it&rsquo;s just informational then what value is it providing? Has anyone asked for it?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref23" id="cmnt23">[w]</a><span class="c7">We&#39;ve heard partners want to use balances API to debug when&nbsp; numbers don&#39;t line up, e.g., the number they expect in the balance does not line up with the actual balance number. In this context the version field could be used for debugging. Hypothetical: seller takes three payments but only two post in the balance because one is suspected. The version could show them that the balance has been changed only twice vs three times (it&#39;s a control check)</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref24" id="cmnt24">[x]</a><span class="c7">Ok that mostly makes sense, but version is still only useful if you have a reference version to compare it against. In your example, the Seller took three payments since a certain point in time, which would be represented by another version that the Seller would have had to record somewhere. Are you thinking that Sellers will record the version at regular intervals (such as when they reconcile their books)?</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref25" id="cmnt25">[y]</a><span class="c7">Agreed, they would use one version as a reference against another. I did not think about that scenario of saving the version each time they reconcile, though now that you mention it I think that would be useful!&nbsp;</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">The way I thought they would use was to run an analysis and query the API only when they see a discrepancy compared to the numbers they expect. They would query the API multiple times until they pinpoint the root cause of the discrepancy.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">I thought that because CommerceSync said they built an API explorer that their Customer Support team uses when sellers call them for issues which allows the CS rep to issue freeform API queries without touching the access token.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">e.g., in the hypothetical scenario above they&#39;d query the API to get the balance before the the 3 payments, they&#39;d see the version number, then query the balance endpoint after the 3 payments, see that the version number only increased by 2, so they realize that 1 payment has not posted. Then they&#39;d query the ListPaymentBalanceAccountBalanceActivity endpoint, identify which two payments have posted based on their related object payment id, then query the v2/payments API to retrieve all 3 payments and by elimination understand which payment has not posted - which will explain the balance discrepancy.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref26" id="cmnt26">[z]</a><span class="c7">ok... I stopped reading this thread at some point.&nbsp; Is a discussion needed?&nbsp; The version isn&#39;t so much about looking&nbsp;up by it, it&#39;s more about having a definitive thing to link to events in the feed and specifically order activity by.&nbsp; We should clarify what exactly it is useful for though and what we do and don&#39;t guarantee about it.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref27" id="cmnt27">[aa]</a><span class="c7">It seems the main purpose of version is to help Developers determine how many balance changes occurred between two points.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref28" id="cmnt28">[ab]</a><span class="c7">To conclude, I think the consensus on this thread is keeping the `version` informational as-is here.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Thanks for the discussion in the thread&nbsp;&#x1f64f;. It sheds light on why and how the clients are going to be using version vs. balance_activity_id</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref29" id="cmnt29">[ac]</a><span class="c7">I&#39;m good with it. Thanks for indulging my questions.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref30" id="cmnt30">[ad]</a><span class="c7">@bta@squareup.com has experience on developing REST API with API Velocity.&nbsp;</span></p><p class="c1"><span class="c7">I think adding the API into Square API public domain could require some additional&nbsp;time in the first pass, but will be easier&nbsp;later.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref31" id="cmnt31">[ae]</a><span class="c7">There&#39;s definitely a DateTime proto field we should use here. I&#39;d assume there&#39;s prior art for how to de/serialize these from the public API (as you mentioned), but I&#39;d love if we were able to keep the proto itself with a DateTime object so we don&#39;t have to reinvent the serialization ourselves downstream.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref32" id="cmnt32">[af]</a><span class="c7">I def. agree ^</span></p><p class="c1"><span class="c7">Haven&#39;t dug into specifics, but I&#39;ld also prefer having a DateTime type here.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref33" id="cmnt33">[ag]</a><span class="c7">Skipping implementation of this model, as we are not yet sure how to fill in the &quot;fee_amount_money&quot; field of &quot;PaymentBalanceActivity&quot;.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">A PB Account of PAYOUT type will not have fees associated with it.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">A PB Account of FEE type will only have fees associated with it.</span></p><p class="c1 c4"><span class="c7"></span></p><p class="c1"><span class="c7">Additionally, some merchants may prefer to be billed fees in a lump-sum as opposed to percentages per-transaction, and its unclear to me how that relationship will be reflected in our modelling.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref34" id="cmnt34">[ah]</a><span class="c7">Agree. We do not need to fill this field for now. Once we finish design of PB Balance Activity we could come back to this.</span></p></div><div class="c6"><p class="c1"><a href="#cmnt_ref35" id="cmnt35">[ai]</a><span class="c7">It does do this, but if you want you can also implement &quot;BooksRepository&quot; in FA where you can pick and choose which books you read and do any sign flipping you want closer to the source also. That way FA will give you exactly the fields and amounts you want.</span></p></div></body></html>
