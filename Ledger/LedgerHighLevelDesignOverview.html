<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_ki7stqbfxf7f-8>li:before{content:"\0025a0   "}ul.lst-kix_7xa21zz2hrxy-8{list-style-type:none}ul.lst-kix_7xa21zz2hrxy-7{list-style-type:none}ul.lst-kix_7xa21zz2hrxy-4{list-style-type:none}ul.lst-kix_7xa21zz2hrxy-3{list-style-type:none}ul.lst-kix_7xa21zz2hrxy-6{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-0{list-style-type:none}ul.lst-kix_7xa21zz2hrxy-5{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-1{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-2{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-3{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-4{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-5{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-6{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-7{list-style-type:none}ul.lst-kix_ki7stqbfxf7f-8{list-style-type:none}.lst-kix_7xa21zz2hrxy-8>li:before{content:"\0025a0   "}.lst-kix_ki7stqbfxf7f-1>li:before{content:"\0025cb   "}.lst-kix_7xa21zz2hrxy-7>li:before{content:"\0025cb   "}.lst-kix_ki7stqbfxf7f-2>li:before{content:"\0025a0   "}ul.lst-kix_7xa21zz2hrxy-0{list-style-type:none}ul.lst-kix_7xa21zz2hrxy-2{list-style-type:none}ul.lst-kix_7xa21zz2hrxy-1{list-style-type:none}.lst-kix_ki7stqbfxf7f-0>li:before{content:"\0025cf   "}.lst-kix_ki7stqbfxf7f-7>li:before{content:"\0025cb   "}.lst-kix_7xa21zz2hrxy-2>li:before{content:"\0025a0   "}.lst-kix_ki7stqbfxf7f-6>li:before{content:"\0025cf   "}.lst-kix_7xa21zz2hrxy-3>li:before{content:"\0025cf   "}.lst-kix_7xa21zz2hrxy-5>li:before{content:"\0025a0   "}.lst-kix_7xa21zz2hrxy-4>li:before{content:"\0025cb   "}.lst-kix_7xa21zz2hrxy-6>li:before{content:"\0025cf   "}.lst-kix_ki7stqbfxf7f-3>li:before{content:"\0025cf   "}.lst-kix_ki7stqbfxf7f-5>li:before{content:"\0025a0   "}.lst-kix_ki7stqbfxf7f-4>li:before{content:"\0025cb   "}.lst-kix_7xa21zz2hrxy-1>li:before{content:"\0025cb   "}.lst-kix_7xa21zz2hrxy-0>li:before{content:"\0025cf   "}ul.lst-kix_evgutd8m22tr-7{list-style-type:none}ul.lst-kix_evgutd8m22tr-8{list-style-type:none}ul.lst-kix_evgutd8m22tr-1{list-style-type:none}.lst-kix_evgutd8m22tr-6>li:before{content:"\0025cf   "}ul.lst-kix_evgutd8m22tr-2{list-style-type:none}.lst-kix_evgutd8m22tr-7>li:before{content:"\0025cb   "}ul.lst-kix_evgutd8m22tr-0{list-style-type:none}ul.lst-kix_evgutd8m22tr-5{list-style-type:none}.lst-kix_evgutd8m22tr-8>li:before{content:"\0025a0   "}ul.lst-kix_evgutd8m22tr-6{list-style-type:none}ul.lst-kix_evgutd8m22tr-3{list-style-type:none}ul.lst-kix_evgutd8m22tr-4{list-style-type:none}.lst-kix_evgutd8m22tr-2>li:before{content:"\0025a0   "}.lst-kix_evgutd8m22tr-1>li:before{content:"\0025cb   "}.lst-kix_evgutd8m22tr-3>li:before{content:"\0025cf   "}.lst-kix_evgutd8m22tr-5>li:before{content:"\0025a0   "}.lst-kix_evgutd8m22tr-4>li:before{content:"\0025cb   "}.lst-kix_evgutd8m22tr-0>li:before{content:"\0025cf   "}ol{margin:0;padding:0}table td,table th{padding:0}.c6{-webkit-text-decoration-skip:none;color:#1155cc;font-weight:400;text-decoration:underline;vertical-align:baseline;text-decoration-skip-ink:none;font-size:11pt;font-family:"Arial";font-style:normal}.c23{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c20{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:center}.c21{padding-top:16pt;padding-bottom:10pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c9{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c17{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:26pt;font-family:"Arial";font-style:normal}.c19{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c13{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.c18{margin-left:36pt;padding-top:3pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c4{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c12{margin-left:18pt;padding-top:3pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c26{margin-left:36pt;padding-top:3pt;padding-bottom:4pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c15{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c27{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c25{padding-top:10pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c28{padding-top:4pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c1{padding-top:0pt;padding-bottom:10pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c14{color:#000000;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c10{font-size:10pt;font-style:italic;color:#434343;font-weight:700}.c22{padding-top:0pt;padding-bottom:0pt;line-height:1.15;text-align:left}.c5{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;font-weight:700;text-decoration:underline}.c7{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c24{font-weight:400;text-decoration:none;vertical-align:baseline;font-family:"Arial"}.c16{background-color:#ffffff;max-width:720pt;padding:36pt 36pt 36pt 36pt}.c11{font-size:10pt;font-style:italic;color:#434343}.c0{color:inherit;text-decoration:inherit}.c8{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c16 doc-content"><p class="c20 title" id="h.6jvd81x16ywy"><span>Ledger High Level Design </span><span>Overview</span></p><p class="c22"><span class="c10">Author</span><span class="c11 c24">&nbsp;&ndash; Daniel Skarbek (dskarbek@)</span></p><p class="c22"><span class="c10">Status</span><span class="c11">&nbsp;&ndash; Last updated March, 2021</span></p><p class="c28"><span class="c7"><a class="c0" href="#h.f0aqe7edjqyw">High Level System Design</a></span></p><p class="c12"><span class="c7"><a class="c0" href="#h.actactku5bj">Event Handling</a></span></p><p class="c12"><span class="c7"><a class="c0" href="#h.larik0pfb21q">Data Models</a></span></p><p class="c12"><span class="c7"><a class="c0" href="#h.hgxipp6f092f">Settlement</a></span></p><p class="c25"><span class="c6"><a class="c0" href="#h.7o7yppgu28im">Conceptual Model</a></span></p><p class="c12"><span class="c6"><a class="c0" href="#h.czcljagee2zv">Ledger / Financials</a></span></p><p class="c18"><span class="c6"><a class="c0" href="#h.yge8s0d1qbg0">Mission Statement</a></span></p><p class="c18"><span class="c6"><a class="c0" href="#h.34l0kqg8c85q">Entities</a></span></p><p class="c12"><span class="c6"><a class="c0" href="#h.k6muegbhxgw5">Books</a></span></p><p class="c18"><span class="c6"><a class="c0" href="#h.r59rmki4szjd">Mission Statement</a></span></p><p class="c26"><span class="c6"><a class="c0" href="#h.6pq9mjl15hcr">Entities</a></span></p><p class="c2 c8"><span class="c4"></span></p><h1 class="c27" id="h.f0aqe7edjqyw"><span class="c23">High Level System Design</span></h1><p class="c2"><span class="c4">This is not a deployment diagram or a detailed diagram, it is a high-level concept diagram.</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 956.00px; height: 564.00px;"><img alt="" src="images/image2.png" style="width: 956.00px; height: 564.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><h2 class="c9" id="h.actactku5bj"><span class="c3">Event Handling</span></h2><p class="c2"><span>The main interaction with Ledger is via events placed in the AccountingQueue (AQ). &nbsp;These events are largely sourced from event feeds from other domains. &nbsp;There are also RPC calls that initiate an Accounting Event (AE) by enqueuing it into the AQ. &nbsp;</span><span>Some RPCs also make use of a transactional enqueueing proxy (not pictured) that first writes the event to the Ledger database and a job then forwards it to the AQ.</span><span class="c4">&nbsp; This enables the enqueue to be committed atomically with other changes to the Ledger domain model.</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span class="c4">The event handling flow for almost all of our events is the same. &nbsp;Events are put in the AQ. The AE handlers construct a Journal Command request which is sent to Books (RPC service running in GCP that uses our Spanner instance). &nbsp;Each Journal Command has the AE passed through in it&rsquo;s meta-data. &nbsp;Committed Journal Commands then end up in the Journal Command Feed which has a listener that pulls the AE back out and passes it to the BCE Processor, which uses BCE Handlers to construct the proper ledger entries to record in the ledger system.</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span class="c4">Originally all ledger data was stored in the Ledger DB (MySQL). &nbsp;Events were modeled as Balance Changing Events (BCE) and went through a MySQL based queue (BCEQ, now dead) and processed by the BCE Processor and BCE Handlers to create ledger entries. &nbsp;Now, we are moving all accounting data to Spanner and access it via the Books system which provides a double entry accounting abstraction. &nbsp;With this change we introduced Accounting Events (AE) which are really just a re-packaging of the BCEs. &nbsp;For now we are keeping both sets of data up to date as we migrate usage to the Books system. &nbsp;Everything starts as an AE, the AE handlers own the logic for applying an AE to Books, and the BCE handlers own the logic for applying an AE to Ledger.</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span class="c4">We also have some synchronous event RPCs. &nbsp;These create AEs that are immediately handled (synchronously, in the RPC call) by the AE handler, persisted to books, and a response from the result of processing is returned. &nbsp;This is used for things like getting authorization for spending where we have to check that the balance has enough funds and then reserve those funds in a guaranteed, consistent way and then tell the caller whether the reservation succeeded. &nbsp;We prefer to keep accounting asynchronous. &nbsp;Other domains decide what to do and tell us and we record it in the system. &nbsp;But, there are some operations (like Auths) where the accounting system is part of making the decision. &nbsp;For these, we have to synchronously process events. &nbsp;Other than skipping the AQ, the rest of the flow is the same: AE is passed through the Journal Command to the BCE Processor to be applied to Ledger as well. &nbsp;</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span class="c4">There are a few legacy RPCs (Bizbank Sweeper and Instant Deposit Fee) that use old patterns. &nbsp;The Bizbank operations &ldquo;dual write&rdquo; meaning that they synchronously update both the books and ledger systems. &nbsp;This cannot guarantee consistency because of the two commit problem. &nbsp;We rely on the fact that the client will retry on error to ensure that the full change is always applied. &nbsp;The Instant Deposit operation flows backwards, it synchronously applies the fee to the ledger database and a ledger entry feed listener then pulls out a passed through AE and processes it against the AE Handlers to get it into books. &nbsp;(The Journal Command Feed is told to ignore these entries, and the ledger entry feed is told to ignore all the normal traffic so that we don&rsquo;t get an infinite loop.) &nbsp;We plan to fix these to a &ldquo;books-first&rdquo; pattern. </span></p><h2 class="c9" id="h.larik0pfb21q"><span class="c3">Data Models</span></h2><p class="c2"><span class="c4">There are also other payment data model concerns in the Ledger database and there are RPCs that have direct access to them. &nbsp;Those parts of the system we&rsquo;d like to decouple from Ledger and move out. &nbsp;There should be a payment lifecycle model that stands upstream of the Financial Account model, which is the core accounting function of Ledger. &nbsp;Right now this is all mixed together in Ledger, but we are working towards breaking this up. &nbsp;Far too many clients are currently consuming the ledger entry feed to find out when captures and refunds happen, but what they really need is a payment event model that doesn&rsquo;t blend in complication from how we do the accounting of those payment events.</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span>The ledger data model is the old, &ldquo;settlement batching&rdquo; model. &nbsp;To visualize the ledger data model, think of a serial log of balance change amounts (received payment, issued refund, etc.). &nbsp;</span><span>When this needs to be &ldquo;settled&rdquo; (moving money to the merchant&rsquo;s bank account)</span><span class="c4">, the old system did this transaction by transaction in batches. &nbsp;So, a batch would take a set of money movements (typically for a day), add up the net effect, send a deposit to the merchant, and then mark the transactions settled (actually, copied them to a separate &ldquo;settled entries&rdquo; table). &nbsp;But, this is inflexible. &nbsp;What if you have a very large transaction and you don&rsquo;t want to completely release it yet, but also don&rsquo;t want to hold all of it back from the merchant?</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span>The books system is based on double entry accounting, which is the industry standard for all accounting. &nbsp;The model is that you have multiple books of running entries and a balance. &nbsp;There are books for assets, liabilities, equity, revenue, expenses; and all transactions must change multiple books or have multiple changes in one book such that the changes balance out. &nbsp;This provides a natural check that money isn&rsquo;t lost. &nbsp;Also, having a book for how much money is due a merchant decouples it from the initial transaction so that you can settle partial amounts. &nbsp;Recording a transaction on a payment book is done in parallel with recording a liability to pay the merchant on another book. &nbsp;Those funds can also move to &ldquo;risk hold&rdquo; books. (Kind of like a state machine for money.) &nbsp;Settlement can just pay the balance in the liability book and record it and it doesn&rsquo;t have to tie this back to a specific transaction. &nbsp;</span><span>This is safer, more flexible, and more performant as one settlement transaction can be written to the book, instead of needing to update N payment transactions as settled.</span><span class="c4">&nbsp; The two key benefits of the books system are the ability to settle arbitrary amounts and also the books give you the ability to know &ldquo;point in time&rdquo; balances. &nbsp;They keep a running balance and can tell you the balance at an arbitrary timestamp. &nbsp;This is a key feature that many other teams want from the ledger system but it is unable to supply.</span></p><h2 class="c9" id="h.hgxipp6f092f"><span class="c3">Settlement</span></h2><p class="c2"><span class="c4">The settlement process is the other primary functionality -- giving sellers their money. &nbsp;This is one of the core value propositions of Square, and is arguably the most critical functionality. &nbsp;Accepting payments is obviously a pretty core capability and if we fail to do that, we are failing to deliver to our sellers on the job they hired us for. &nbsp;But, if we fail to settle, then we have taken money on their behalf and are not giving it to them. &nbsp;This is not just a failure to do what we promised to do, it is taking away something that is not ours. &nbsp;Hence, the health of our settlement pipelines is our primary metric, followed by event processing of captures and other critical &ldquo;payment acceptance&rdquo; events.</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span class="c4">The settlement pipeline system is old and is being replaced by another system on another team under Banking Services. &nbsp;So, the long term plan is that the Accounting Engineering team does not own the settlement process, we just own the &ldquo;keeping the books&rdquo; job.</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span class="c4">There are a lot of details to the pipelines that we won&rsquo;t go into here, but the high-level process is that all the ledger entries for the day are grouped into batches. &nbsp;Besides the ledger_entry table, there is also a ledger_entry_batches, unsettled_ledger_entries, and settled_ledger_entries. &nbsp;When ledger entries are created they get batched and put in the unsettled table. &nbsp;The settlement pipeline determines which entries are eligible to be settled and groups those up per merchant. &nbsp;Then ACH transfers are constructed and sent to our partner banks to transfer funds to the seller bank accounts. &nbsp;Finally, the settled entries are moved to the settled table.</span></p><p class="c2 c8"><span class="c4"></span></p><p class="c2"><span class="c4">The promise we are trying to deliver on is &ldquo;you get your money the next day.&rdquo; &nbsp;So, the way that works is that 5pm is the &ldquo;end of day&rdquo; cut off (I&rsquo;m skipping variations for international issues). &nbsp;That freezes the set of payments that are eligible to settle. &nbsp;Then there is a minimum risk review window of (typically) 2 hours. &nbsp;That gives our risk agents time to review any flagged payments and block them if needed before they get settled out. &nbsp;Shortly after the risk review window our settlement pipeline job runs. &nbsp;It must run and complete before the bank cut-off. &nbsp;The bank cut-off is the deadline for when an ACH file has to be transferred to the bank in order for the transactions to be recorded in time for them to complete by the next day so that sellers will see the funds in their bank account the next day. &nbsp;This is a tight schedule. &nbsp;We have some re-courses. &nbsp;We have enough relationship with some banks that we can get a file in a little late and still have it processed, but not all of them. &nbsp;And, with some we can do &ldquo;same day deposits&rdquo; for additional expense up until like 10am the next morning. &nbsp;But, these are fall-backs that don&rsquo;t completely cover the problem. &nbsp;Missing the bank cut-off is an all-hands-on-deck SEV. &nbsp;We take the responsibility of meeting this brand promise very seriously.</span></p><p class="c2 c8"><span class="c4"></span></p><h1 class="c27" id="h.7o7yppgu28im"><span class="c23">Conceptual Model</span></h1><p class="c2"><span class="c4">Books and Ledger are distinct domains, but we own both of them. &nbsp;Ledger&rsquo;s model is (at least partly) persisted via the Books model, but each is a distinct conceptual model.</span></p><p class="c2 c8"><span class="c3"></span></p><h2 class="c9" id="h.czcljagee2zv"><span class="c3">Ledger / Financials</span></h2><p class="c2"><span class="c4">As we evolve we are breaking up Ledger and hopefully it will go away entirely. &nbsp;The basic parts of it are payment lifecycle concerns, event handling, the Financial Account, and settlement. &nbsp;The event handling system, the Accounting Events, have like 50 or so types that match up to client domain concerns. &nbsp;Like, capture, refund, fee, dispute, and dozens more. &nbsp;We then determine the accounting treatment for those and are working on creating a Financial Account abstraction that we expose that generalizes the accounting and has like 8 operations (immediate credit or debit, and an auth/capture/void 2 phase pattern of credit or debit).</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 760.00px; height: 436.00px;"><img alt="" src="images/image3.png" style="width: 760.00px; height: 436.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><h3 class="c19" id="h.yge8s0d1qbg0"><span class="c15">Mission Statement</span></h3><p class="c1"><span class="c13">&ldquo;The pennies must add up&rdquo;</span></p><p class="c1"><span class="c4">We don&rsquo;t enforce rules or business logic about why or when money should move, we simply do the accounting of how the money is moving. &nbsp;We are the core system that records whatever our client systems tell us to record. &nbsp;We are responsible for being able to say exactly where all the Merchant&rsquo;s money is, but we don&rsquo;t control the reasons why it moves.</span></p><h3 class="c21" id="h.34l0kqg8c85q"><span>Entities</span></h3><p class="c2"><span class="c14 c5">Financial Account</span></p><p class="c1"><span class="c4">A single store of value. &nbsp;A single history of activity in a single currency. &nbsp;Made up of balances segregated into posted and current states but is otherwise one &ldquo;pile of money&rdquo;. &nbsp;The account has four balances (posted, current, pending, and held) and a history of Transactions against those balances.</span></p><p class="c1"><span class="c14 c5">Transaction</span></p><p class="c1"><span class="c4">Any movement of money in or out of the account happens in a Transaction. &nbsp;Some money movements are instant and others are 2-phase patterns (like Auth/Capture on a card). The 2-phase money movements require some notion of a transaction balance -- the total amount that has been held by all the related transaction events. The Transaction maintains the &ldquo;balance&rdquo; of the net effect of the events that have happened. &nbsp;It is a mutable object that is initiated, worked, and resolved. &nbsp;The activity on it is made up of a series of Transaction Events.</span></p><p class="c1"><span class="c5">Transaction Event</span></p><p class="c1"><span class="c4">An immutable change to an account. &nbsp;Each Transaction Event has one or more Balance Changes. &nbsp;It also contains a client type and metadata that describe what it is and give details. &nbsp;One external operation against the Financial Account (like doing a 1-phase money movement or each step of a 2-phase money movement) is one Transaction Event.</span></p><p class="c1"><span class="c5 c14">Balance Change</span></p><p class="c1"><span class="c4">A snapshot of a change to one balance of an account. &nbsp;Has a balance type, a delta amount that is applied to that balance and the new running total of the balance at the time of applying the change. &nbsp;Each Balance Change belongs to a single TransactionEvent but is also tied to the account. &nbsp;It&rsquo;s the bridge between the account and the transaction model. &nbsp;Typically, clients would load a set of Balance Changes for a single balance type to get the history of that balance.</span></p><p class="c1"><span class="c5">Balance</span></p><p class="c1"><span class="c4">A sub-entity of the account, it is simply a type and a current total amount. &nbsp;It is defined to be in the currency of the account. &nbsp;An account has a single currency that is the denomination of all balances. &nbsp;There may actually be 4 balances on an account, the main balance holding balances, POSTED and CURRENT, and then two &ldquo;pending&rdquo; balances that are zero in the steady state: PENDING for in-process deposits, and HELD for in-process withdrawals.</span></p><h2 class="c9" id="h.k6muegbhxgw5"><span class="c3">Books</span></h2><h2 class="c9" id="h.daidpniw6y9g"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 792.00px; height: 253.33px;"><img alt="" src="images/image1.png" style="width: 792.00px; height: 253.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></h2><h3 class="c19" id="h.r59rmki4szjd"><span class="c15">Mission Statement</span></h3><p class="c1"><span class="c13">&ldquo;The MySQL of double entry accounting&rdquo;</span></p><p class="c2"><span class="c4">Books provides a generic interface for the persistence of double-entry accounting primitives. &nbsp;It holds no business logic, only storage concerns. &nbsp;Just like the relational storage model has constraints and rules, the accounting model has constraints and rules, but that is all it deals with.</span></p><h3 class="c19" id="h.6pq9mjl15hcr"><span class="c15">Entities</span></h3><p class="c2"><span class="c5">Book:</span><span class="c4">&nbsp;One piece of value (pile of money); has a current value and a change log (history) made up of Book Entries.</span></p><p class="c2"><span class="c5">Book Entry:</span><span class="c4">&nbsp;A single change to the amount in a book. &nbsp;Either a credit or a debit. &nbsp;Has direction and amount. &nbsp;Can only be created in a Journal Entry</span></p><p class="c2"><span class="c5">Journal Entry:</span><span class="c4">&nbsp;A consistent set of Book Entries. &nbsp;Consistent meaning that they satisfy the basic accounting formula &mdash; they balance out.</span></p><p class="c2"><span class="c5">Journal Command:</span><span class="c4">&nbsp;Maps to one external event / activity that is being recorded in the accounting system. &nbsp;May use more than one Journal Entry and may have some constraints to apply.</span></p><p class="c1 c8"><span class="c4"></span></p></body></html>
